This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
public/
  manifest.json
src/
  app/
    (app)/
      ajustes/
        page.tsx
      dashboard/
        page.tsx
      estoque/
        components/
          ProdutoForm.tsx
          VendaRapidaModal.tsx
        page.tsx
      mercadolivre/
        page.tsx
      vendas/
        page.tsx
      layout.tsx
    api/
      mercadolivre/
        callback/
          route.ts
        items/
          route.ts
        orders/
          route.ts
        questions/
          route.ts
        sync-stock/
          route.ts
        webhook/
          route.ts
      ml-webhook/
        route.ts
    login/
      layout.tsx
      page.tsx
    globals.css
    layout.tsx
    page.tsx
  components/
    navigation/
      TabBar.tsx
    ui/
      Button.tsx
      Card.tsx
      ImageUpload.tsx
      index.ts
      Input.tsx
      Modal.tsx
      SwipeableItem.tsx
      Tabs.tsx
      Toast.tsx
  lib/
    mercadolivre/
      client.ts
    supabase/
      client.ts
      server.ts
    utils/
      calculos.ts
      datas.ts
      helpers.ts
  types/
    database.ts
supabase/
  schema.sql
.env.example
.gitignore
next.config.js
package.json
postcss.config.js
README.md
supabase_ml_schema.sql
tailwind.config.ts
tsconfig.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="public/manifest.json">
{
  "name": "LLControl",
  "short_name": "LLControl",
  "description": "Gestão de Estoque e Vendas - Mercado Livre",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#3b82f6",
  "orientation": "portrait",
  "icons": [
    {
      "src": "/icons/icon-72x72.png",
      "sizes": "72x72",
      "type": "image/png",
      "purpose": "maskable any"
    },
    {
      "src": "/icons/icon-96x96.png",
      "sizes": "96x96",
      "type": "image/png",
      "purpose": "maskable any"
    },
    {
      "src": "/icons/icon-128x128.png",
      "sizes": "128x128",
      "type": "image/png",
      "purpose": "maskable any"
    },
    {
      "src": "/icons/icon-144x144.png",
      "sizes": "144x144",
      "type": "image/png",
      "purpose": "maskable any"
    },
    {
      "src": "/icons/icon-152x152.png",
      "sizes": "152x152",
      "type": "image/png",
      "purpose": "maskable any"
    },
    {
      "src": "/icons/icon-192x192.png",
      "sizes": "192x192",
      "type": "image/png",
      "purpose": "maskable any"
    },
    {
      "src": "/icons/icon-384x384.png",
      "sizes": "384x384",
      "type": "image/png",
      "purpose": "maskable any"
    },
    {
      "src": "/icons/icon-512x512.png",
      "sizes": "512x512",
      "type": "image/png",
      "purpose": "maskable any"
    }
  ],
  "screenshots": [],
  "categories": ["business", "productivity"],
  "lang": "pt-BR",
  "dir": "ltr"
}
</file>

<file path="src/app/(app)/layout.tsx">
import TabBar from '@/components/navigation/TabBar';
import { ToastProvider } from '@/components/ui';

export default function AppLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <ToastProvider>
      <div className="min-h-screen bg-gray-50 flex flex-col">
        {/* Main content area */}
        <main className="flex-1 pb-20 overflow-y-auto">
          {children}
        </main>

        {/* Bottom Tab Bar */}
        <TabBar />
      </div>
    </ToastProvider>
  );
}
</file>

<file path="src/app/api/mercadolivre/items/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { getMLItems, refreshToken } from '@/lib/mercadolivre/client';
import { createClient } from '@supabase/supabase-js';

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { user_id } = body;

    if (!user_id) {
      return NextResponse.json({ error: 'user_id required' }, { status: 400 });
    }

    const supabase = createClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.SUPABASE_SERVICE_ROLE_KEY!
    );

    // Buscar configurações do usuário
    const { data: config } = await supabase
      .from('configuracoes')
      .select('ml_user_id, ml_access_token, ml_refresh_token, ml_token_expires')
      .eq('user_id', user_id)
      .single();

    if (!config?.ml_access_token) {
      return NextResponse.json({ error: 'ML não conectado' }, { status: 401 });
    }

    let accessToken = config.ml_access_token;

    // Verificar se token expirou
    if (config.ml_token_expires && new Date(config.ml_token_expires) < new Date()) {
      // Renovar token
      try {
        const newToken = await refreshToken(config.ml_refresh_token);
        accessToken = newToken.access_token;

        // Atualizar no banco
        await supabase
          .from('configuracoes')
          .update({
            ml_access_token: newToken.access_token,
            ml_refresh_token: newToken.refresh_token,
            ml_token_expires: new Date(Date.now() + newToken.expires_in * 1000).toISOString(),
          })
          .eq('user_id', user_id);
      } catch (err) {
        return NextResponse.json({ error: 'Token expirado, reconecte ao ML' }, { status: 401 });
      }
    }

    // Buscar anúncios do ML
    const items = await getMLItems(accessToken, parseInt(config.ml_user_id));

    return NextResponse.json({ items });
  } catch (err: any) {
    console.error('Erro ao buscar anúncios:', err);
    return NextResponse.json({ error: err.message }, { status: 500 });
  }
}
</file>

<file path="src/app/api/mercadolivre/orders/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { getMLOrders, refreshToken } from '@/lib/mercadolivre/client';
import { createClient } from '@supabase/supabase-js';

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { user_id } = body;

    if (!user_id) {
      return NextResponse.json({ error: 'user_id required' }, { status: 400 });
    }

    const supabase = createClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.SUPABASE_SERVICE_ROLE_KEY!
    );

    // Buscar configurações do usuário
    const { data: config } = await supabase
      .from('configuracoes')
      .select('ml_user_id, ml_access_token, ml_refresh_token, ml_token_expires')
      .eq('user_id', user_id)
      .single();

    if (!config?.ml_access_token) {
      return NextResponse.json({ error: 'ML não conectado' }, { status: 401 });
    }

    let accessToken = config.ml_access_token;

    // Verificar se token expirou
    if (config.ml_token_expires && new Date(config.ml_token_expires) < new Date()) {
      try {
        const newToken = await refreshToken(config.ml_refresh_token);
        accessToken = newToken.access_token;

        await supabase
          .from('configuracoes')
          .update({
            ml_access_token: newToken.access_token,
            ml_refresh_token: newToken.refresh_token,
            ml_token_expires: new Date(Date.now() + newToken.expires_in * 1000).toISOString(),
          })
          .eq('user_id', user_id);
      } catch (err) {
        return NextResponse.json({ error: 'Token expirado, reconecte ao ML' }, { status: 401 });
      }
    }

    // Buscar pedidos do ML
    const orders = await getMLOrders(accessToken, parseInt(config.ml_user_id), 'paid');

    return NextResponse.json({ orders });
  } catch (err: any) {
    console.error('Erro ao buscar pedidos:', err);
    return NextResponse.json({ error: err.message }, { status: 500 });
  }
}
</file>

<file path="src/app/api/mercadolivre/questions/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@supabase/supabase-js';

const SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL || 'https://vbhhjukhtrylghclvotv.supabase.co';
const SUPABASE_SERVICE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY || '';

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { user_id } = body;

    if (!user_id) {
      return NextResponse.json({ error: 'user_id required' }, { status: 400 });
    }

    const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);

    // Buscar configurações do usuário
    const { data: config } = await supabase
      .from('configuracoes')
      .select('ml_user_id, ml_access_token')
      .eq('user_id', user_id)
      .single();

    if (!config?.ml_access_token) {
      return NextResponse.json({ error: 'ML não conectado' }, { status: 401 });
    }

    // Buscar perguntas
    const response = await fetch(
      `https://api.mercadolibre.com/questions/search?seller_id=${config.ml_user_id}&status=UNANSWERED&sort_fields=date_created&sort_types=DESC`,
      {
        headers: {
          'Authorization': `Bearer ${config.ml_access_token}`,
        },
      }
    );

    if (!response.ok) {
      const error = await response.json();
      return NextResponse.json({ error: error.message }, { status: response.status });
    }

    const data = await response.json();
    
    return NextResponse.json({ questions: data.questions || [] });
  } catch (err: any) {
    console.error('Erro ao buscar perguntas:', err);
    return NextResponse.json({ error: err.message }, { status: 500 });
  }
}
</file>

<file path="src/app/api/mercadolivre/sync-stock/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@supabase/supabase-js';

const SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL || 'https://vbhhjukhtrylghclvotv.supabase.co';
const SUPABASE_SERVICE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY || '';

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { user_id } = body;

    if (!user_id) {
      return NextResponse.json({ error: 'user_id required' }, { status: 400 });
    }

    const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);

    // Buscar configurações do usuário
    const { data: config } = await supabase
      .from('configuracoes')
      .select('ml_user_id, ml_access_token')
      .eq('user_id', user_id)
      .single();

    if (!config?.ml_access_token) {
      return NextResponse.json({ error: 'ML não conectado' }, { status: 401 });
    }

    // Buscar anúncios do ML
    const idsResponse = await fetch(
      `https://api.mercadolibre.com/users/${config.ml_user_id}/items/search?limit=50`,
      {
        headers: {
          'Authorization': `Bearer ${config.ml_access_token}`,
        },
      }
    );

    if (!idsResponse.ok) {
      return NextResponse.json({ error: 'Erro ao buscar anúncios' }, { status: 500 });
    }

    const idsData = await idsResponse.json();
    const itemIds = idsData.results || [];

    if (itemIds.length === 0) {
      return NextResponse.json({ synced: 0 });
    }

    // Buscar detalhes dos itens
    const itemsResponse = await fetch(
      `https://api.mercadolibre.com/items?ids=${itemIds.join(',')}`,
      {
        headers: {
          'Authorization': `Bearer ${config.ml_access_token}`,
        },
      }
    );

    const itemsData = await itemsResponse.json();
    const items = itemsData.map((item: any) => item.body);

    let synced = 0;

    for (const item of items) {
      if (item.status !== 'active') continue;

      // Verificar se produto já existe
      const { data: existingProduto } = await supabase
        .from('produtos')
        .select('id, quantidade')
        .eq('ml_id', item.id)
        .eq('user_id', user_id)
        .single();

      if (existingProduto) {
        // Atualizar quantidade do produto existente
        if (existingProduto.quantidade !== item.available_quantity) {
          await supabase
            .from('produtos')
            .update({
              quantidade: item.available_quantity,
              valor_venda: item.price,
              nome: item.title,
            })
            .eq('id', existingProduto.id);
          synced++;
        }
      } else {
        // Criar novo produto
        await supabase
          .from('produtos')
          .insert({
            user_id: user_id,
            nome: item.title,
            foto_url: item.thumbnail?.replace('http://', 'https://') || null,
            quantidade: item.available_quantity,
            valor_pago: 0, // Usuário precisa preencher
            valor_venda: item.price,
            ml_id: item.id,
            taxa_tipo: 'classico',
            ativo: true,
          });
        synced++;
      }
    }

    return NextResponse.json({ synced, total: items.length });
  } catch (err: any) {
    console.error('Erro ao sincronizar estoque:', err);
    return NextResponse.json({ error: err.message }, { status: 500 });
  }
}
</file>

<file path="src/app/api/mercadolivre/webhook/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@supabase/supabase-js';
import { getMLItemDetails, refreshToken } from '@/lib/mercadolivre/client';

// Webhook para receber notificações do Mercado Livre
export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    
    console.log('ML Webhook received:', body);

    // Validar estrutura da notificação
    const { resource, topic, user_id } = body;

    if (!resource || !topic) {
      return NextResponse.json({ error: 'Invalid notification' }, { status: 400 });
    }

    const supabase = createClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.SUPABASE_SERVICE_ROLE_KEY!
    );

    // Buscar configuração do usuário pelo ml_user_id
    const { data: config } = await supabase
      .from('configuracoes')
      .select('user_id, ml_access_token, ml_refresh_token, ml_token_expires')
      .eq('ml_user_id', user_id.toString())
      .single();

    if (!config) {
      console.log('Usuário não encontrado para ml_user_id:', user_id);
      return NextResponse.json({ ok: true }); // Retorna OK para não gerar reenvios
    }

    let accessToken = config.ml_access_token;

    // Renovar token se necessário
    if (config.ml_token_expires && new Date(config.ml_token_expires) < new Date()) {
      try {
        const newToken = await refreshToken(config.ml_refresh_token);
        accessToken = newToken.access_token;

        await supabase
          .from('configuracoes')
          .update({
            ml_access_token: newToken.access_token,
            ml_refresh_token: newToken.refresh_token,
            ml_token_expires: new Date(Date.now() + newToken.expires_in * 1000).toISOString(),
          })
          .eq('user_id', config.user_id);
      } catch (err) {
        console.error('Erro ao renovar token:', err);
        return NextResponse.json({ ok: true });
      }
    }

    // Processar diferentes tipos de notificação
    if (topic === 'orders_v2') {
      // Uma venda foi realizada
      await processOrder(supabase, accessToken, resource, config.user_id);
    } else if (topic === 'items') {
      // Um item foi atualizado
      await processItemUpdate(supabase, accessToken, resource, config.user_id);
    }

    return NextResponse.json({ ok: true });
  } catch (err: any) {
    console.error('Erro no webhook ML:', err);
    return NextResponse.json({ ok: true }); // Sempre retorna OK
  }
}

async function processOrder(
  supabase: any, 
  accessToken: string, 
  resource: string,
  userId: string
) {
  try {
    // Buscar detalhes do pedido
    const response = await fetch(`https://api.mercadolibre.com${resource}`, {
      headers: {
        'Authorization': `Bearer ${accessToken}`,
      },
    });

    if (!response.ok) return;

    const order = await response.json();

    // Verificar se já processamos este pedido
    const { data: existingVenda } = await supabase
      .from('vendas')
      .select('id')
      .eq('ml_order_id', order.id.toString())
      .single();

    if (existingVenda) {
      console.log('Pedido já processado:', order.id);
      return;
    }

    // Processar cada item do pedido
    for (const orderItem of order.order_items) {
      const mlItemId = orderItem.item.id;
      const qtdVendida = orderItem.quantity;
      const valorFinal = orderItem.unit_price * qtdVendida;

      // Buscar produto vinculado no estoque
      const { data: produto } = await supabase
        .from('produtos')
        .select('*')
        .eq('ml_id', mlItemId)
        .eq('user_id', userId)
        .single();

      if (produto) {
        // Calcular lucro (usando taxas do Mercado Livre)
        const custoTotal = Number(produto.valor_pago) * qtdVendida;
        const taxaPercentual = produto.taxa_tipo === 'premium' ? 16 : 11;
        const taxaFixa = 6;
        const taxas = (valorFinal * taxaPercentual / 100) + taxaFixa;
        const lucroLiquido = valorFinal - custoTotal - taxas;

        // Registrar venda
        await supabase.from('vendas').insert({
          user_id: userId,
          produto_id: produto.id,
          produto_nome: produto.nome,
          qtd_vendida: qtdVendida,
          valor_final: valorFinal,
          custo_unitario: produto.valor_pago,
          taxa_percentual: taxaPercentual,
          taxa_fixa: taxaFixa,
          lucro_liquido: lucroLiquido,
          ml_order_id: order.id.toString(),
          data_venda: new Date(order.date_created).toISOString(),
        });

        // Atualizar estoque
        const novaQtd = Math.max(0, produto.quantidade - qtdVendida);
        await supabase
          .from('produtos')
          .update({ quantidade: novaQtd })
          .eq('id', produto.id);

        console.log(`Venda processada: ${produto.nome} x${qtdVendida}, Lucro: ${lucroLiquido}`);
      }
    }
  } catch (err) {
    console.error('Erro ao processar pedido:', err);
  }
}

async function processItemUpdate(
  supabase: any,
  accessToken: string,
  resource: string,
  userId: string
) {
  try {
    // Extrair ID do item do resource (/items/MLB123456)
    const itemId = resource.split('/').pop();
    
    if (!itemId) return;

    // Buscar detalhes do item
    const item = await getMLItemDetails(accessToken, itemId);

    // Atualizar produto vinculado
    const { data: produto } = await supabase
      .from('produtos')
      .select('id')
      .eq('ml_id', itemId)
      .eq('user_id', userId)
      .single();

    if (produto) {
      await supabase
        .from('produtos')
        .update({
          nome: item.title,
          valor_venda: item.price,
        })
        .eq('id', produto.id);

      console.log(`Produto atualizado do ML: ${item.title}`);
    }
  } catch (err) {
    console.error('Erro ao processar atualização de item:', err);
  }
}
</file>

<file path="src/app/login/layout.tsx">
import { ToastProvider } from '@/components/ui/Toast';

export default function LoginLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <ToastProvider>
      {children}
    </ToastProvider>
  );
}
</file>

<file path="src/app/login/page.tsx">
'use client';

import { useState } from 'react';
import { motion } from 'framer-motion';
import { Mail, Lock, Loader2, Eye, EyeOff } from 'lucide-react';
import { Button, Input, Card, useToast } from '@/components/ui';
import { getSupabaseClient } from '@/lib/supabase/client';
import { useRouter } from 'next/navigation';

export default function LoginPage() {
  const [isLogin, setIsLogin] = useState(true);
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [showPassword, setShowPassword] = useState(false);
  const [isLoading, setIsLoading] = useState(false);
  const { addToast } = useToast();
  const router = useRouter();

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!email || !password) {
      addToast({ type: 'error', title: 'Preencha todos os campos' });
      return;
    }

    setIsLoading(true);

    try {
      const supabase = getSupabaseClient();

      if (isLogin) {
        // Login
        const { error } = await supabase.auth.signInWithPassword({
          email,
          password,
        });

        if (error) throw error;

        addToast({ type: 'success', title: 'Login realizado!' });
        router.push('/dashboard');
      } else {
        // Cadastro
        const { error } = await supabase.auth.signUp({
          email,
          password,
        });

        if (error) throw error;

        addToast({ 
          type: 'success', 
          title: 'Conta criada!',
          description: 'Verifique seu email para confirmar.'
        });
        setIsLogin(true);
      }
    } catch (error: any) {
      console.error('Erro de autenticação:', error);
      
      let message = 'Erro ao processar';
      if (error.message?.includes('Invalid login')) {
        message = 'Email ou senha incorretos';
      } else if (error.message?.includes('User already registered')) {
        message = 'Este email já está cadastrado';
      } else if (error.message?.includes('Password should be')) {
        message = 'Senha deve ter no mínimo 6 caracteres';
      }
      
      addToast({ type: 'error', title: message });
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-primary-600 to-primary-800 flex items-center justify-center p-4">
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.4 }}
        className="w-full max-w-sm"
      >
        {/* Logo */}
        <div className="text-center mb-8">
          <h1 className="text-4xl font-bold text-white mb-2">LLControl</h1>
          <p className="text-primary-200">Gestão de estoque inteligente</p>
        </div>

        {/* Card */}
        <Card className="p-6">
          <h2 className="text-xl font-semibold text-gray-900 mb-6 text-center">
            {isLogin ? 'Entrar na conta' : 'Criar conta'}
          </h2>

          <form onSubmit={handleSubmit} className="space-y-4">
            {/* Email */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                Email
              </label>
              <div className="relative">
                <Mail className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
                <input
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  placeholder="seu@email.com"
                  className="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                />
              </div>
            </div>

            {/* Senha */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                Senha
              </label>
              <div className="relative">
                <Lock className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
                <input
                  type={showPassword ? 'text' : 'password'}
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  placeholder="••••••••"
                  className="w-full pl-10 pr-12 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                />
                <button
                  type="button"
                  onClick={() => setShowPassword(!showPassword)}
                  className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400"
                >
                  {showPassword ? <EyeOff className="w-5 h-5" /> : <Eye className="w-5 h-5" />}
                </button>
              </div>
            </div>

            {/* Submit Button */}
            <Button
              type="submit"
              className="w-full py-3"
              disabled={isLoading}
            >
              {isLoading ? (
                <Loader2 className="w-5 h-5 animate-spin" />
              ) : (
                isLogin ? 'Entrar' : 'Criar conta'
              )}
            </Button>
          </form>

          {/* Toggle */}
          <div className="mt-6 text-center">
            <button
              onClick={() => setIsLogin(!isLogin)}
              className="text-sm text-primary-600 hover:text-primary-700"
            >
              {isLogin ? 'Não tem conta? Criar agora' : 'Já tem conta? Entrar'}
            </button>
          </div>
        </Card>

        {/* Footer */}
        <p className="text-center text-primary-200 text-sm mt-6">
          Gestão simplificada para vendedores
        </p>
      </motion.div>
    </div>
  );
}
</file>

<file path="src/app/globals.css">
@tailwind base;
@tailwind components;
@tailwind utilities;

/* iOS PWA Styles */
:root {
  --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
  --safe-area-inset-top: env(safe-area-inset-top, 0px);
}

/* Disable text selection for app-like feel */
* {
  -webkit-tap-highlight-color: transparent;
  -webkit-touch-callout: none;
}

/* Allow text selection in inputs */
input,
textarea {
  -webkit-user-select: text;
  user-select: text;
}

/* Smooth scrolling */
html {
  scroll-behavior: smooth;
  -webkit-overflow-scrolling: touch;
}

/* Prevent overscroll bounce on iOS */
body {
  overscroll-behavior-y: none;
  overflow-x: hidden;
}

/* Hide scrollbars but allow scrolling */
.hide-scrollbar {
  -ms-overflow-style: none;
  scrollbar-width: none;
}

.hide-scrollbar::-webkit-scrollbar {
  display: none;
}

/* iOS-like glassmorphism */
.glass {
  background: rgba(255, 255, 255, 0.72);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
}

.glass-dark {
  background: rgba(0, 0, 0, 0.72);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
}

/* Active press effect for buttons */
.press-effect {
  transition: transform 0.1s ease-out;
}

.press-effect:active {
  transform: scale(0.95);
}

/* Slide animations */
@keyframes slide-up {
  from {
    transform: translateY(100%);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

@keyframes slide-down {
  from {
    transform: translateY(-20px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

/* Custom scrollbar for non-iOS */
@media (hover: hover) {
  ::-webkit-scrollbar {
    width: 6px;
    height: 6px;
  }

  ::-webkit-scrollbar-track {
    background: transparent;
  }

  ::-webkit-scrollbar-thumb {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 3px;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: rgba(0, 0, 0, 0.3);
  }
}

/* Input styles */
input[type='number']::-webkit-inner-spin-button,
input[type='number']::-webkit-outer-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

input[type='number'] {
  -moz-appearance: textfield;
}

/* Safe area padding classes */
.pb-safe {
  padding-bottom: max(1rem, env(safe-area-inset-bottom));
}

.pt-safe {
  padding-top: max(1rem, env(safe-area-inset-top));
}

/* Tab bar height accounting for safe area */
.mb-tab-bar {
  margin-bottom: calc(4rem + env(safe-area-inset-bottom, 0px));
}

/* Swipe action styles */
.swipe-container {
  overflow: hidden;
}

.swipe-content {
  transition: transform 0.2s ease-out;
}

/* Card shadow iOS-like */
.card-shadow {
  box-shadow: 
    0 1px 3px rgba(0, 0, 0, 0.04),
    0 4px 12px rgba(0, 0, 0, 0.06);
}

.card-shadow-lg {
  box-shadow: 
    0 2px 8px rgba(0, 0, 0, 0.04),
    0 8px 24px rgba(0, 0, 0, 0.08);
}
</file>

<file path="src/app/layout.tsx">
import type { Metadata, Viewport } from 'next';
import './globals.css';

export const metadata: Metadata = {
  title: 'LLControl',
  description: 'Gestão de Estoque e Vendas - Mercado Livre',
  manifest: '/manifest.json',
  appleWebApp: {
    capable: true,
    statusBarStyle: 'default',
    title: 'LLControl',
  },
  formatDetection: {
    telephone: false,
  },
  icons: {
    apple: '/icons/icon-192x192.png',
  },
};

export const viewport: Viewport = {
  width: 'device-width',
  initialScale: 1,
  maximumScale: 1,
  userScalable: false,
  viewportFit: 'cover',
  themeColor: '#3b82f6',
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="pt-BR">
      <head>
        <link rel="apple-touch-icon" href="/icons/icon-192x192.png" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="default" />
      </head>
      <body className="font-sans antialiased bg-gray-50 text-gray-900 min-h-screen overflow-x-hidden">
        {children}
      </body>
    </html>
  );
}
</file>

<file path="src/components/ui/Button.tsx">
'use client';

import { forwardRef, ButtonHTMLAttributes } from 'react';
import { motion, HTMLMotionProps } from 'framer-motion';
import { Loader2 } from 'lucide-react';
import { cn } from '@/lib/utils/helpers';

type ButtonVariant = 'primary' | 'secondary' | 'danger' | 'ghost' | 'outline';
type ButtonSize = 'sm' | 'md' | 'lg';

interface ButtonProps extends Omit<ButtonHTMLAttributes<HTMLButtonElement>, 'onAnimationStart' | 'onDrag' | 'onDragEnd' | 'onDragStart'> {
  variant?: ButtonVariant;
  size?: ButtonSize;
  isLoading?: boolean;
  leftIcon?: React.ReactNode;
  rightIcon?: React.ReactNode;
  fullWidth?: boolean;
}

const variants: Record<ButtonVariant, string> = {
  primary: 'bg-primary-600 text-white hover:bg-primary-700 active:bg-primary-800 shadow-sm',
  secondary: 'bg-gray-100 text-gray-900 hover:bg-gray-200 active:bg-gray-300',
  danger: 'bg-danger-600 text-white hover:bg-danger-700 active:bg-danger-800',
  ghost: 'bg-transparent text-gray-700 hover:bg-gray-100 active:bg-gray-200',
  outline: 'bg-transparent border-2 border-gray-300 text-gray-700 hover:border-gray-400 hover:bg-gray-50',
};

const sizes: Record<ButtonSize, string> = {
  sm: 'px-3 py-1.5 text-sm gap-1.5',
  md: 'px-4 py-2.5 text-base gap-2',
  lg: 'px-6 py-3 text-lg gap-2.5',
};

export const Button = forwardRef<HTMLButtonElement, ButtonProps>(
  (
    {
      className,
      variant = 'primary',
      size = 'md',
      isLoading = false,
      leftIcon,
      rightIcon,
      fullWidth = false,
      disabled,
      children,
      ...props
    },
    ref
  ) => {
    return (
      <motion.button
        ref={ref}
        whileTap={{ scale: 0.95 }}
        transition={{ type: 'spring', stiffness: 400, damping: 17 }}
        className={cn(
          'inline-flex items-center justify-center font-medium rounded-xl',
          'transition-colors duration-150 ease-out',
          'focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2',
          'disabled:opacity-50 disabled:cursor-not-allowed',
          variants[variant],
          sizes[size],
          fullWidth && 'w-full',
          className
        )}
        disabled={disabled || isLoading}
        {...(props as HTMLMotionProps<'button'>)}
      >
        {isLoading ? (
          <Loader2 className="w-5 h-5 animate-spin" />
        ) : (
          <>
            {leftIcon && <span className="flex-shrink-0">{leftIcon}</span>}
            {children}
            {rightIcon && <span className="flex-shrink-0">{rightIcon}</span>}
          </>
        )}
      </motion.button>
    );
  }
);

Button.displayName = 'Button';
</file>

<file path="src/components/ui/Card.tsx">
'use client';

import { ReactNode } from 'react';
import { motion } from 'framer-motion';
import { cn } from '@/lib/utils/helpers';

interface CardProps {
  children: ReactNode;
  className?: string;
  onClick?: () => void;
  animate?: boolean;
}

export function Card({ children, className, onClick, animate = false }: CardProps) {
  const Comp = animate ? motion.div : 'div';
  const animateProps = animate
    ? {
        initial: { opacity: 0, y: 10 },
        animate: { opacity: 1, y: 0 },
        transition: { duration: 0.2 },
      }
    : {};

  return (
    <Comp
      className={cn(
        'bg-white rounded-2xl p-4 card-shadow',
        onClick && 'cursor-pointer active:scale-[0.98] transition-transform',
        className
      )}
      onClick={onClick}
      {...animateProps}
    >
      {children}
    </Comp>
  );
}

interface CardHeaderProps {
  title: string;
  subtitle?: string;
  action?: ReactNode;
}

export function CardHeader({ title, subtitle, action }: CardHeaderProps) {
  return (
    <div className="flex items-start justify-between mb-3">
      <div>
        <h3 className="text-base font-semibold text-gray-900">{title}</h3>
        {subtitle && <p className="text-sm text-gray-500 mt-0.5">{subtitle}</p>}
      </div>
      {action && <div>{action}</div>}
    </div>
  );
}

interface StatCardProps {
  title: string;
  value: string | number;
  subtitle?: string;
  icon?: ReactNode;
  trend?: {
    value: number;
    isPositive: boolean;
  };
  variant?: 'default' | 'success' | 'warning' | 'danger';
}

const variantStyles = {
  default: 'bg-white',
  success: 'bg-success-50',
  warning: 'bg-warning-50',
  danger: 'bg-danger-50',
};

const variantIconBg = {
  default: 'bg-gray-100',
  success: 'bg-success-100',
  warning: 'bg-warning-100',
  danger: 'bg-danger-100',
};

const variantIconColor = {
  default: 'text-gray-600',
  success: 'text-success-600',
  warning: 'text-warning-600',
  danger: 'text-danger-600',
};

export function StatCard({ title, value, subtitle, icon, trend, variant = 'default' }: StatCardProps) {
  return (
    <Card className={cn('relative overflow-hidden', variantStyles[variant])}>
      <div className="flex items-start justify-between">
        <div className="flex-1">
          <p className="text-sm font-medium text-gray-500">{title}</p>
          <p className="mt-1 text-2xl font-bold text-gray-900">{value}</p>
          {subtitle && <p className="mt-0.5 text-sm text-gray-500">{subtitle}</p>}
          {trend && (
            <div className={cn(
              'mt-2 inline-flex items-center text-sm font-medium',
              trend.isPositive ? 'text-success-600' : 'text-danger-600'
            )}>
              <span>{trend.isPositive ? '↑' : '↓'}</span>
              <span className="ml-1">{Math.abs(trend.value)}%</span>
            </div>
          )}
        </div>
        {icon && (
          <div className={cn(
            'p-2 rounded-xl',
            variantIconBg[variant]
          )}>
            <div className={cn('w-6 h-6', variantIconColor[variant])}>
              {icon}
            </div>
          </div>
        )}
      </div>
    </Card>
  );
}
</file>

<file path="src/components/ui/ImageUpload.tsx">
'use client';

import { useRef, useState, ChangeEvent } from 'react';
import Image from 'next/image';
import { Camera, X, Loader2 } from 'lucide-react';
import { cn, compressImage } from '@/lib/utils/helpers';
import { getSupabaseClient } from '@/lib/supabase/client';

interface ImageUploadProps {
  value?: string;
  onChange: (url: string | null) => void;
  bucket?: string;
  folder?: string;
  maxSize?: number;
  className?: string;
}

export function ImageUpload({
  value,
  onChange,
  bucket = 'produtos',
  folder = '',
  maxSize = 5 * 1024 * 1024, // 5MB
  className,
}: ImageUploadProps) {
  const inputRef = useRef<HTMLInputElement>(null);
  const [isUploading, setIsUploading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const handleClick = () => {
    inputRef.current?.click();
  };

  const handleChange = async (e: ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    // Validate file size
    if (file.size > maxSize) {
      setError(`Arquivo muito grande. Máximo: ${maxSize / (1024 * 1024)}MB`);
      return;
    }

    // Validate file type
    if (!file.type.startsWith('image/')) {
      setError('Apenas imagens são permitidas');
      return;
    }

    setError(null);
    setIsUploading(true);

    try {
      // Compress image before upload
      const compressedBlob = await compressImage(file, 800, 0.8);
      
      // Generate unique filename
      const timestamp = Date.now();
      const ext = 'jpg'; // Always save as jpg after compression
      const filename = folder 
        ? `${folder}/${timestamp}.${ext}`
        : `${timestamp}.${ext}`;

      const supabase = getSupabaseClient();
      
      // Upload to Supabase Storage
      const { data, error: uploadError } = await supabase.storage
        .from(bucket)
        .upload(filename, compressedBlob, {
          contentType: 'image/jpeg',
          upsert: true,
        });

      if (uploadError) throw uploadError;

      // Get public URL
      const { data: { publicUrl } } = supabase.storage
        .from(bucket)
        .getPublicUrl(data.path);

      onChange(publicUrl);
    } catch (err) {
      console.error('Upload error:', err);
      setError('Erro ao fazer upload da imagem');
    } finally {
      setIsUploading(false);
      // Reset input
      if (inputRef.current) {
        inputRef.current.value = '';
      }
    }
  };

  const handleRemove = () => {
    onChange(null);
    setError(null);
  };

  return (
    <div className={cn('w-full', className)}>
      <input
        ref={inputRef}
        type="file"
        accept="image/*"
        capture="environment" // Opens camera on iOS
        onChange={handleChange}
        className="hidden"
      />

      {value ? (
        <div className="relative aspect-square w-full max-w-[200px] mx-auto rounded-2xl overflow-hidden bg-gray-100">
          <Image
            src={value}
            alt="Produto"
            fill
            className="object-cover"
            sizes="200px"
          />
          <button
            onClick={handleRemove}
            className="absolute top-2 right-2 p-1.5 bg-black/50 rounded-full text-white hover:bg-black/70 transition-colors"
          >
            <X className="w-4 h-4" />
          </button>
        </div>
      ) : (
        <button
          onClick={handleClick}
          disabled={isUploading}
          className={cn(
            'w-full aspect-square max-w-[200px] mx-auto',
            'flex flex-col items-center justify-center gap-2',
            'border-2 border-dashed border-gray-300 rounded-2xl',
            'bg-gray-50 text-gray-500',
            'hover:border-primary-400 hover:bg-primary-50 hover:text-primary-600',
            'transition-colors duration-200',
            'disabled:opacity-50 disabled:cursor-not-allowed'
          )}
        >
          {isUploading ? (
            <>
              <Loader2 className="w-8 h-8 animate-spin" />
              <span className="text-sm">Enviando...</span>
            </>
          ) : (
            <>
              <Camera className="w-8 h-8" />
              <span className="text-sm font-medium">Tirar Foto</span>
            </>
          )}
        </button>
      )}

      {error && (
        <p className="mt-2 text-sm text-danger-600 text-center">{error}</p>
      )}
    </div>
  );
}
</file>

<file path="src/components/ui/index.ts">
export { Button } from './Button';
export { Input } from './Input';
export { Card, CardHeader, StatCard } from './Card';
export { Modal, ConfirmModal } from './Modal';
export { SwipeableItem } from './SwipeableItem';
export { ToastProvider, useToast } from './Toast';
export { Tabs, TabContent } from './Tabs';
export { ImageUpload } from './ImageUpload';
</file>

<file path="src/components/ui/Input.tsx">
'use client';

import { forwardRef, InputHTMLAttributes } from 'react';
import { cn } from '@/lib/utils/helpers';

interface InputProps extends InputHTMLAttributes<HTMLInputElement> {
  label?: string;
  error?: string;
  hint?: string;
  leftIcon?: React.ReactNode;
  rightElement?: React.ReactNode;
}

export const Input = forwardRef<HTMLInputElement, InputProps>(
  ({ className, label, error, hint, leftIcon, rightElement, type, id, ...props }, ref) => {
    const inputId = id || label?.toLowerCase().replace(/\s/g, '-');

    return (
      <div className="w-full">
        {label && (
          <label
            htmlFor={inputId}
            className="block text-sm font-medium text-gray-700 mb-1.5"
          >
            {label}
          </label>
        )}
        <div className="relative">
          {leftIcon && (
            <div className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
              {leftIcon}
            </div>
          )}
          <input
            ref={ref}
            id={inputId}
            type={type}
            className={cn(
              'w-full px-4 py-3 text-base',
              'bg-white border border-gray-200 rounded-xl',
              'placeholder:text-gray-400',
              'transition-all duration-150',
              'focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent',
              'disabled:bg-gray-50 disabled:text-gray-500 disabled:cursor-not-allowed',
              leftIcon && 'pl-10',
              rightElement && 'pr-10',
              error && 'border-danger-500 focus:ring-danger-500',
              className
            )}
            {...props}
          />
          {rightElement && (
            <div className="absolute right-3 top-1/2 -translate-y-1/2">
              {rightElement}
            </div>
          )}
        </div>
        {error && <p className="mt-1.5 text-sm text-danger-600">{error}</p>}
        {hint && !error && <p className="mt-1.5 text-sm text-gray-500">{hint}</p>}
      </div>
    );
  }
);

Input.displayName = 'Input';
</file>

<file path="src/components/ui/Modal.tsx">
'use client';

import { Fragment, ReactNode } from 'react';
import * as DialogPrimitive from '@radix-ui/react-dialog';
import { motion, AnimatePresence } from 'framer-motion';
import { X } from 'lucide-react';
import { cn } from '@/lib/utils/helpers';

interface ModalProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  children: ReactNode;
  title?: string;
  description?: string;
}

export function Modal({ open, onOpenChange, children, title, description }: ModalProps) {
  return (
    <DialogPrimitive.Root open={open} onOpenChange={onOpenChange}>
      <AnimatePresence>
        {open && (
          <DialogPrimitive.Portal forceMount>
            <DialogPrimitive.Overlay asChild>
              <motion.div
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
                exit={{ opacity: 0 }}
                transition={{ duration: 0.2 }}
                className="fixed inset-0 z-50 bg-black/40 backdrop-blur-sm"
              />
            </DialogPrimitive.Overlay>
            <DialogPrimitive.Content asChild>
              <motion.div
                initial={{ opacity: 0, y: '100%' }}
                animate={{ opacity: 1, y: 0 }}
                exit={{ opacity: 0, y: '100%' }}
                transition={{ type: 'spring', damping: 25, stiffness: 300 }}
                className={cn(
                  'fixed bottom-0 left-0 right-0 z-50',
                  'bg-white rounded-t-3xl',
                  'max-h-[90vh] overflow-y-auto',
                  'pb-[env(safe-area-inset-bottom)]',
                  'focus:outline-none'
                )}
              >
                {/* Handle bar */}
                <div className="sticky top-0 bg-white pt-3 pb-2 flex justify-center">
                  <div className="w-10 h-1 bg-gray-300 rounded-full" />
                </div>

                {/* Header */}
                {(title || description) && (
                  <div className="px-6 pb-4 border-b border-gray-100">
                    {title && (
                      <DialogPrimitive.Title className="text-lg font-semibold text-gray-900">
                        {title}
                      </DialogPrimitive.Title>
                    )}
                    {description && (
                      <DialogPrimitive.Description className="mt-1 text-sm text-gray-500">
                        {description}
                      </DialogPrimitive.Description>
                    )}
                  </div>
                )}

                {/* Close button */}
                <DialogPrimitive.Close asChild>
                  <button
                    className="absolute top-4 right-4 p-2 rounded-full hover:bg-gray-100 transition-colors"
                    aria-label="Fechar"
                  >
                    <X className="w-5 h-5 text-gray-500" />
                  </button>
                </DialogPrimitive.Close>

                {/* Content */}
                <div className="px-6 py-4">{children}</div>
              </motion.div>
            </DialogPrimitive.Content>
          </DialogPrimitive.Portal>
        )}
      </AnimatePresence>
    </DialogPrimitive.Root>
  );
}

interface ConfirmModalProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  title: string;
  description?: string;
  confirmText?: string;
  cancelText?: string;
  onConfirm: () => void;
  variant?: 'danger' | 'warning' | 'default';
  isLoading?: boolean;
}

export function ConfirmModal({
  open,
  onOpenChange,
  title,
  description,
  confirmText = 'Confirmar',
  cancelText = 'Cancelar',
  onConfirm,
  variant = 'default',
  isLoading,
}: ConfirmModalProps) {
  const buttonVariants = {
    danger: 'bg-danger-600 hover:bg-danger-700 text-white',
    warning: 'bg-warning-600 hover:bg-warning-700 text-white',
    default: 'bg-primary-600 hover:bg-primary-700 text-white',
  };

  return (
    <Modal open={open} onOpenChange={onOpenChange} title={title} description={description}>
      <div className="flex gap-3 mt-4">
        <button
          onClick={() => onOpenChange(false)}
          className="flex-1 py-3 px-4 bg-gray-100 text-gray-700 font-medium rounded-xl active:scale-95 transition-transform"
        >
          {cancelText}
        </button>
        <button
          onClick={onConfirm}
          disabled={isLoading}
          className={cn(
            'flex-1 py-3 px-4 font-medium rounded-xl active:scale-95 transition-transform',
            'disabled:opacity-50 disabled:cursor-not-allowed',
            buttonVariants[variant]
          )}
        >
          {isLoading ? 'Aguarde...' : confirmText}
        </button>
      </div>
    </Modal>
  );
}
</file>

<file path="src/components/ui/SwipeableItem.tsx">
'use client';

import { useState, useRef, ReactNode } from 'react';
import { motion, useMotionValue, useTransform, PanInfo } from 'framer-motion';
import { Trash2, Edit, ShoppingCart } from 'lucide-react';
import { cn, hapticFeedback } from '@/lib/utils/helpers';

interface SwipeAction {
  icon: ReactNode;
  label: string;
  onClick: () => void;
  variant: 'danger' | 'primary' | 'success';
}

interface SwipeableItemProps {
  children: ReactNode;
  onDelete?: () => void;
  onEdit?: () => void;
  onSell?: () => void;
  className?: string;
}

const ACTION_WIDTH = 80;
const SWIPE_THRESHOLD = 60;

export function SwipeableItem({
  children,
  onDelete,
  onEdit,
  onSell,
  className,
}: SwipeableItemProps) {
  const [isOpen, setIsOpen] = useState(false);
  const x = useMotionValue(0);
  const constraintsRef = useRef<HTMLDivElement>(null);

  const actions: SwipeAction[] = [];
  
  if (onSell) {
    actions.push({
      icon: <ShoppingCart className="w-5 h-5" />,
      label: 'Vender',
      onClick: onSell,
      variant: 'success',
    });
  }
  
  if (onEdit) {
    actions.push({
      icon: <Edit className="w-5 h-5" />,
      label: 'Editar',
      onClick: onEdit,
      variant: 'primary',
    });
  }

  if (onDelete) {
    actions.push({
      icon: <Trash2 className="w-5 h-5" />,
      label: 'Excluir',
      onClick: onDelete,
      variant: 'danger',
    });
  }

  const maxDrag = actions.length * ACTION_WIDTH;

  const handleDragEnd = (_: MouseEvent | TouchEvent | PointerEvent, info: PanInfo) => {
    const shouldOpen = info.offset.x < -SWIPE_THRESHOLD;
    setIsOpen(shouldOpen);
    
    if (shouldOpen && Math.abs(info.offset.x) > SWIPE_THRESHOLD) {
      hapticFeedback('light');
    }
  };

  const variantColors = {
    danger: 'bg-danger-500 text-white',
    primary: 'bg-primary-500 text-white',
    success: 'bg-success-500 text-white',
  };

  return (
    <div ref={constraintsRef} className={cn('relative overflow-hidden', className)}>
      {/* Actions background */}
      <div className="absolute right-0 top-0 bottom-0 flex">
        {actions.map((action, index) => (
          <motion.button
            key={index}
            onClick={() => {
              hapticFeedback('medium');
              action.onClick();
              setIsOpen(false);
            }}
            className={cn(
              'flex flex-col items-center justify-center',
              variantColors[action.variant]
            )}
            style={{ width: ACTION_WIDTH }}
          >
            {action.icon}
            <span className="text-xs mt-1">{action.label}</span>
          </motion.button>
        ))}
      </div>

      {/* Swipeable content */}
      <motion.div
        drag="x"
        dragConstraints={{ left: -maxDrag, right: 0 }}
        dragElastic={0.1}
        onDragEnd={handleDragEnd}
        animate={{ x: isOpen ? -maxDrag : 0 }}
        transition={{ type: 'spring', stiffness: 500, damping: 30 }}
        style={{ x }}
        className="relative bg-white"
      >
        {children}
      </motion.div>
    </div>
  );
}
</file>

<file path="src/components/ui/Tabs.tsx">
'use client';

import * as React from 'react';
import * as TabsPrimitive from '@radix-ui/react-tabs';
import { motion } from 'framer-motion';
import { cn } from '@/lib/utils/helpers';

interface TabsProps {
  tabs: { value: string; label: string }[];
  defaultValue?: string;
  value?: string;
  onValueChange?: (value: string) => void;
  children: React.ReactNode;
}

export function Tabs({ tabs, defaultValue, value, onValueChange, children }: TabsProps) {
  const [activeTab, setActiveTab] = React.useState(defaultValue || tabs[0]?.value);
  const currentValue = value ?? activeTab;

  const handleValueChange = (newValue: string) => {
    setActiveTab(newValue);
    onValueChange?.(newValue);
  };

  return (
    <TabsPrimitive.Root value={currentValue} onValueChange={handleValueChange}>
      <TabsPrimitive.List className="flex bg-gray-100 p-1 rounded-xl mb-4">
        {tabs.map((tab) => (
          <TabsPrimitive.Trigger
            key={tab.value}
            value={tab.value}
            className={cn(
              'relative flex-1 py-2 px-4 text-sm font-medium rounded-lg',
              'transition-colors duration-200',
              'focus:outline-none',
              currentValue === tab.value ? 'text-gray-900' : 'text-gray-500'
            )}
          >
            {currentValue === tab.value && (
              <motion.div
                layoutId="activeTabBg"
                className="absolute inset-0 bg-white rounded-lg shadow-sm"
                transition={{ type: 'spring', stiffness: 500, damping: 30 }}
              />
            )}
            <span className="relative z-10">{tab.label}</span>
          </TabsPrimitive.Trigger>
        ))}
      </TabsPrimitive.List>
      {children}
    </TabsPrimitive.Root>
  );
}

interface TabContentProps {
  value: string;
  children: React.ReactNode;
}

export function TabContent({ value, children }: TabContentProps) {
  return (
    <TabsPrimitive.Content value={value} asChild>
      <motion.div
        initial={{ opacity: 0, y: 10 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.2 }}
      >
        {children}
      </motion.div>
    </TabsPrimitive.Content>
  );
}
</file>

<file path="src/components/ui/Toast.tsx">
'use client';

import * as React from 'react';
import * as ToastPrimitive from '@radix-ui/react-toast';
import { motion, AnimatePresence } from 'framer-motion';
import { X, CheckCircle, AlertCircle, Info, AlertTriangle } from 'lucide-react';
import { cn } from '@/lib/utils/helpers';

type ToastType = 'success' | 'error' | 'info' | 'warning';

interface Toast {
  id: string;
  type: ToastType;
  title: string;
  description?: string;
}

interface ToastContextType {
  toasts: Toast[];
  addToast: (toast: Omit<Toast, 'id'>) => void;
  removeToast: (id: string) => void;
}

const ToastContext = React.createContext<ToastContextType | undefined>(undefined);

export function useToast() {
  const context = React.useContext(ToastContext);
  if (!context) {
    throw new Error('useToast must be used within a ToastProvider');
  }
  return context;
}

const icons: Record<ToastType, React.ReactNode> = {
  success: <CheckCircle className="w-5 h-5 text-success-600" />,
  error: <AlertCircle className="w-5 h-5 text-danger-600" />,
  info: <Info className="w-5 h-5 text-primary-600" />,
  warning: <AlertTriangle className="w-5 h-5 text-warning-600" />,
};

const bgColors: Record<ToastType, string> = {
  success: 'bg-success-50 border-success-200',
  error: 'bg-danger-50 border-danger-200',
  info: 'bg-primary-50 border-primary-200',
  warning: 'bg-warning-50 border-warning-200',
};

export function ToastProvider({ children }: { children: React.ReactNode }) {
  const [toasts, setToasts] = React.useState<Toast[]>([]);

  const addToast = React.useCallback((toast: Omit<Toast, 'id'>) => {
    const id = Math.random().toString(36).substring(2, 9);
    setToasts((prev) => [...prev, { ...toast, id }]);

    // Auto remove after 4 seconds
    setTimeout(() => {
      setToasts((prev) => prev.filter((t) => t.id !== id));
    }, 4000);
  }, []);

  const removeToast = React.useCallback((id: string) => {
    setToasts((prev) => prev.filter((t) => t.id !== id));
  }, []);

  return (
    <ToastContext.Provider value={{ toasts, addToast, removeToast }}>
      <ToastPrimitive.Provider swipeDirection="right">
        {children}
        <ToastPrimitive.Viewport className="fixed top-4 right-4 left-4 z-[100] flex flex-col gap-2 outline-none" />
        <AnimatePresence>
          {toasts.map((toast) => (
            <ToastPrimitive.Root key={toast.id} asChild>
              <motion.div
                initial={{ opacity: 0, y: -20, scale: 0.95 }}
                animate={{ opacity: 1, y: 0, scale: 1 }}
                exit={{ opacity: 0, y: -20, scale: 0.95 }}
                transition={{ type: 'spring', stiffness: 500, damping: 30 }}
                className={cn(
                  'fixed top-4 left-4 right-4 z-[100]',
                  'flex items-start gap-3 p-4',
                  'border rounded-xl shadow-lg',
                  bgColors[toast.type]
                )}
              >
                <div className="flex-shrink-0">{icons[toast.type]}</div>
                <div className="flex-1 min-w-0">
                  <ToastPrimitive.Title className="text-sm font-semibold text-gray-900">
                    {toast.title}
                  </ToastPrimitive.Title>
                  {toast.description && (
                    <ToastPrimitive.Description className="mt-1 text-sm text-gray-600">
                      {toast.description}
                    </ToastPrimitive.Description>
                  )}
                </div>
                <ToastPrimitive.Close asChild>
                  <button
                    onClick={() => removeToast(toast.id)}
                    className="flex-shrink-0 p-1 rounded-full hover:bg-black/5 transition-colors"
                  >
                    <X className="w-4 h-4 text-gray-500" />
                  </button>
                </ToastPrimitive.Close>
              </motion.div>
            </ToastPrimitive.Root>
          ))}
        </AnimatePresence>
      </ToastPrimitive.Provider>
    </ToastContext.Provider>
  );
}
</file>

<file path="src/lib/utils/calculos.ts">
import { TaxaTipo, CalculoLucro } from '@/types/database';

// Configurações padrão das taxas do Mercado Livre
export const TAXAS_PADRAO = {
  classico: 11, // 11%
  premium: 16,  // 16%
  taxaFixaLimite: 79.00, // Valor abaixo do qual aplica taxa fixa
  taxaFixaValor: 6.00,   // Taxa fixa de R$ 6,00
};

interface TaxasConfig {
  taxaClassico?: number;
  taxaPremium?: number;
  taxaFixaLimite?: number;
  taxaFixaValor?: number;
}

/**
 * Calcula a taxa percentual baseada no tipo de anúncio
 */
export function getTaxaPercentual(
  taxaTipo: TaxaTipo,
  config?: TaxasConfig
): number {
  if (taxaTipo === 'premium') {
    return config?.taxaPremium ?? TAXAS_PADRAO.premium;
  }
  return config?.taxaClassico ?? TAXAS_PADRAO.classico;
}

/**
 * Calcula a taxa fixa se o valor de venda for menor que o limite
 */
export function getTaxaFixa(
  valorVenda: number,
  config?: TaxasConfig
): number {
  const limite = config?.taxaFixaLimite ?? TAXAS_PADRAO.taxaFixaLimite;
  const valorFixo = config?.taxaFixaValor ?? TAXAS_PADRAO.taxaFixaValor;
  
  return valorVenda < limite ? valorFixo : 0;
}

/**
 * Calcula o valor total das taxas do Mercado Livre
 */
export function calcularTaxasML(
  valorVenda: number,
  taxaTipo: TaxaTipo,
  config?: TaxasConfig
): { taxaPercentual: number; valorTaxaPercentual: number; taxaFixa: number; totalTaxas: number } {
  const taxaPercentual = getTaxaPercentual(taxaTipo, config);
  const valorTaxaPercentual = (valorVenda * taxaPercentual) / 100;
  const taxaFixa = getTaxaFixa(valorVenda, config);
  const totalTaxas = valorTaxaPercentual + taxaFixa;

  return {
    taxaPercentual,
    valorTaxaPercentual,
    taxaFixa,
    totalTaxas,
  };
}

/**
 * Calcula o lucro líquido por unidade
 * Fórmula: valor_venda - valor_pago - (Taxa ML %) - (Taxa fixa se < R$ 79)
 */
export function calcularLucroUnitario(
  valorVenda: number,
  valorPago: number,
  taxaTipo: TaxaTipo,
  config?: TaxasConfig
): CalculoLucro {
  const { taxaPercentual, totalTaxas, taxaFixa } = calcularTaxasML(
    valorVenda,
    taxaTipo,
    config
  );

  const lucroUnitario = valorVenda - valorPago - totalTaxas;
  const margemPercentual = valorVenda > 0 
    ? (lucroUnitario / valorVenda) * 100 
    : 0;

  return {
    valorVenda,
    valorPago,
    taxaTipo,
    taxaPercentual,
    taxaFixa,
    lucroUnitario,
    margemPercentual,
  };
}

/**
 * Calcula o lucro total de uma venda com múltiplas unidades
 */
export function calcularLucroVenda(
  valorUnitario: number,
  custoUnitario: number,
  quantidade: number,
  taxaTipo: TaxaTipo,
  config?: TaxasConfig
): {
  valorFinal: number;
  custoTotal: number;
  totalTaxas: number;
  lucroLiquido: number;
  taxaPercentual: number;
  taxaFixa: number;
} {
  const valorFinal = valorUnitario * quantidade;
  const custoTotal = custoUnitario * quantidade;
  
  // A taxa fixa é aplicada por pedido, não por unidade
  const { taxaPercentual, valorTaxaPercentual, taxaFixa } = calcularTaxasML(
    valorFinal,
    taxaTipo,
    config
  );
  
  // Taxa fixa é aplicada uma vez por pedido
  const taxaFixaTotal = valorFinal < (config?.taxaFixaLimite ?? TAXAS_PADRAO.taxaFixaLimite) 
    ? taxaFixa 
    : 0;
  
  const totalTaxas = valorTaxaPercentual + taxaFixaTotal;
  const lucroLiquido = valorFinal - custoTotal - totalTaxas;

  return {
    valorFinal,
    custoTotal,
    totalTaxas,
    lucroLiquido,
    taxaPercentual,
    taxaFixa: taxaFixaTotal,
  };
}

/**
 * Formata valor monetário em Real brasileiro
 */
export function formatarMoeda(valor: number): string {
  return new Intl.NumberFormat('pt-BR', {
    style: 'currency',
    currency: 'BRL',
  }).format(valor);
}

/**
 * Formata percentual
 */
export function formatarPercentual(valor: number, decimais: number = 1): string {
  return `${valor.toFixed(decimais)}%`;
}

/**
 * Retorna a cor baseada no lucro (positivo, negativo, neutro)
 */
export function getCorLucro(lucro: number): string {
  if (lucro > 0) return 'text-success-600';
  if (lucro < 0) return 'text-danger-600';
  return 'text-gray-500';
}

/**
 * Retorna a cor de fundo baseada no lucro
 */
export function getBgCorLucro(lucro: number): string {
  if (lucro > 0) return 'bg-success-50';
  if (lucro < 0) return 'bg-danger-50';
  return 'bg-gray-50';
}
</file>

<file path="src/lib/utils/datas.ts">
import {
  startOfDay,
  endOfDay,
  startOfWeek,
  endOfWeek,
  startOfMonth,
  endOfMonth,
  subDays,
  format,
  parseISO,
  isToday,
  isYesterday,
  differenceInDays,
} from 'date-fns';
import { ptBR } from 'date-fns/locale';

export type PeriodoFiltro = 'hoje' | 'semana' | 'mes';

/**
 * Retorna o range de datas para o período especificado
 */
export function getDateRange(periodo: PeriodoFiltro): { inicio: Date; fim: Date } {
  const agora = new Date();

  switch (periodo) {
    case 'hoje':
      return {
        inicio: startOfDay(agora),
        fim: endOfDay(agora),
      };
    case 'semana':
      return {
        inicio: startOfWeek(agora, { weekStartsOn: 0 }),
        fim: endOfWeek(agora, { weekStartsOn: 0 }),
      };
    case 'mes':
      return {
        inicio: startOfMonth(agora),
        fim: endOfMonth(agora),
      };
    default:
      return {
        inicio: startOfDay(agora),
        fim: endOfDay(agora),
      };
  }
}

/**
 * Retorna os últimos N dias para gráficos
 */
export function getUltimosDias(dias: number): Date[] {
  const resultado: Date[] = [];
  const hoje = new Date();

  for (let i = dias - 1; i >= 0; i--) {
    resultado.push(subDays(hoje, i));
  }

  return resultado;
}

/**
 * Formata data para exibição amigável
 */
export function formatarData(data: string | Date, formatoCompleto: boolean = false): string {
  const dataObj = typeof data === 'string' ? parseISO(data) : data;

  if (isToday(dataObj)) {
    return 'Hoje';
  }

  if (isYesterday(dataObj)) {
    return 'Ontem';
  }

  if (formatoCompleto) {
    return format(dataObj, "d 'de' MMMM 'de' yyyy", { locale: ptBR });
  }

  const diasAtras = differenceInDays(new Date(), dataObj);
  if (diasAtras < 7) {
    return format(dataObj, 'EEEE', { locale: ptBR });
  }

  return format(dataObj, 'dd/MM/yyyy', { locale: ptBR });
}

/**
 * Formata data para o formato do banco de dados
 */
export function formatarParaBanco(data: Date): string {
  return data.toISOString();
}

/**
 * Formata hora
 */
export function formatarHora(data: string | Date): string {
  const dataObj = typeof data === 'string' ? parseISO(data) : data;
  return format(dataObj, 'HH:mm', { locale: ptBR });
}

/**
 * Formata data e hora juntos
 */
export function formatarDataHora(data: string | Date): string {
  const dataObj = typeof data === 'string' ? parseISO(data) : data;
  return format(dataObj, "dd/MM/yyyy 'às' HH:mm", { locale: ptBR });
}

/**
 * Retorna nome do dia da semana abreviado
 */
export function getDiaSemanaAbreviado(data: Date): string {
  return format(data, 'EEE', { locale: ptBR });
}

/**
 * Retorna nome do mês
 */
export function getNomeMes(data: Date): string {
  return format(data, 'MMMM', { locale: ptBR });
}

/**
 * Gera labels para gráfico semanal
 */
export function gerarLabelsSemanais(): string[] {
  const dias = getUltimosDias(7);
  return dias.map((dia) => getDiaSemanaAbreviado(dia));
}
</file>

<file path="src/lib/utils/helpers.ts">
import { clsx, type ClassValue } from 'clsx';
import { twMerge } from 'tailwind-merge';

/**
 * Merge Tailwind classes with clsx
 */
export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs));
}

/**
 * Simula feedback háptico no iOS
 * Usa a API de vibração quando disponível
 */
export function hapticFeedback(type: 'light' | 'medium' | 'heavy' = 'light') {
  if (typeof navigator !== 'undefined' && 'vibrate' in navigator) {
    const durations = {
      light: 10,
      medium: 20,
      heavy: 30,
    };
    navigator.vibrate(durations[type]);
  }
}

/**
 * Delay helper para animações
 */
export function delay(ms: number): Promise<void> {
  return new Promise((resolve) => setTimeout(resolve, ms));
}

/**
 * Debounce function
 */
export function debounce<T extends (...args: unknown[]) => unknown>(
  func: T,
  wait: number
): (...args: Parameters<T>) => void {
  let timeout: NodeJS.Timeout | null = null;

  return function executedFunction(...args: Parameters<T>) {
    const later = () => {
      timeout = null;
      func(...args);
    };

    if (timeout) {
      clearTimeout(timeout);
    }
    timeout = setTimeout(later, wait);
  };
}

/**
 * Gera um ID único
 */
export function generateId(): string {
  return Math.random().toString(36).substring(2, 15);
}

/**
 * Verifica se está rodando no iOS
 */
export function isIOS(): boolean {
  if (typeof window === 'undefined') return false;
  return /iPad|iPhone|iPod/.test(navigator.userAgent);
}

/**
 * Verifica se está em modo PWA standalone
 */
export function isStandalone(): boolean {
  if (typeof window === 'undefined') return false;
  return (
    window.matchMedia('(display-mode: standalone)').matches ||
    ('standalone' in navigator && (navigator as { standalone?: boolean }).standalone === true)
  );
}

/**
 * Trunca texto com ellipsis
 */
export function truncate(text: string, maxLength: number): string {
  if (text.length <= maxLength) return text;
  return text.slice(0, maxLength - 3) + '...';
}

/**
 * Capitaliza primeira letra
 */
export function capitalize(text: string): string {
  return text.charAt(0).toUpperCase() + text.slice(1).toLowerCase();
}

/**
 * Formata número com separadores de milhar
 */
export function formatNumber(value: number): string {
  return new Intl.NumberFormat('pt-BR').format(value);
}

/**
 * Comprime imagem antes do upload
 */
export async function compressImage(
  file: File,
  maxWidth: number = 800,
  quality: number = 0.8
): Promise<Blob> {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = (event) => {
      const img = new Image();
      img.src = event.target?.result as string;
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        let { width, height } = img;
        
        if (width > maxWidth) {
          height = (height * maxWidth) / width;
          width = maxWidth;
        }
        
        canvas.width = width;
        canvas.height = height;
        
        ctx?.drawImage(img, 0, 0, width, height);
        
        canvas.toBlob(
          (blob) => {
            if (blob) {
              resolve(blob);
            } else {
              reject(new Error('Failed to compress image'));
            }
          },
          'image/jpeg',
          quality
        );
      };
      img.onerror = reject;
    };
    reader.onerror = reject;
  });
}
</file>

<file path="supabase/schema.sql">
-- =====================================================
-- LLControl - Schema SQL para Supabase
-- Versão: 1.0
-- =====================================================

-- Habilitar extensão UUID
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- =====================================================
-- TABELA: produtos
-- Armazena informações dos produtos do inventário
-- =====================================================
CREATE TABLE produtos (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  nome TEXT NOT NULL,
  descricao TEXT,
  foto_url TEXT,
  quantidade INT DEFAULT 0 CHECK (quantidade >= 0),
  valor_pago DECIMAL(10,2) NOT NULL CHECK (valor_pago >= 0),
  valor_venda DECIMAL(10,2) NOT NULL CHECK (valor_venda >= 0),
  taxa_tipo TEXT DEFAULT 'classico' CHECK (taxa_tipo IN ('classico', 'premium')),
  ml_id TEXT, -- ID do anúncio no Mercado Livre
  ativo BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Índices para performance
CREATE INDEX idx_produtos_user_id ON produtos(user_id);
CREATE INDEX idx_produtos_ml_id ON produtos(ml_id);
CREATE INDEX idx_produtos_ativo ON produtos(ativo);

-- =====================================================
-- TABELA: vendas
-- Histórico de vendas para análise D/S/M
-- =====================================================
CREATE TABLE vendas (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  produto_id UUID REFERENCES produtos(id) ON DELETE SET NULL,
  produto_nome TEXT NOT NULL, -- Snapshot do nome no momento da venda
  qtd_vendida INT NOT NULL CHECK (qtd_vendida > 0),
  valor_unitario DECIMAL(10,2) NOT NULL,
  valor_final DECIMAL(10,2) NOT NULL,
  custo_unitario DECIMAL(10,2) NOT NULL,
  taxa_tipo TEXT NOT NULL CHECK (taxa_tipo IN ('classico', 'premium')),
  taxa_percentual DECIMAL(5,2) NOT NULL,
  taxa_fixa DECIMAL(10,2) DEFAULT 0,
  lucro_liquido DECIMAL(10,2) NOT NULL,
  ml_order_id TEXT, -- ID do pedido no Mercado Livre
  origem TEXT DEFAULT 'manual' CHECK (origem IN ('manual', 'mercadolivre')),
  data_venda TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Índices para performance nas queries de dashboard
CREATE INDEX idx_vendas_user_id ON vendas(user_id);
CREATE INDEX idx_vendas_data ON vendas(data_venda);
CREATE INDEX idx_vendas_produto_id ON vendas(produto_id);
CREATE INDEX idx_vendas_user_data ON vendas(user_id, data_venda);

-- =====================================================
-- TABELA: configuracoes
-- Configurações do usuário (taxas personalizadas, metas)
-- =====================================================
CREATE TABLE configuracoes (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE UNIQUE,
  taxa_classico DECIMAL(5,2) DEFAULT 11.00,
  taxa_premium DECIMAL(5,2) DEFAULT 16.00,
  taxa_fixa_limite DECIMAL(10,2) DEFAULT 79.00, -- Valor abaixo do qual aplica taxa fixa
  taxa_fixa_valor DECIMAL(10,2) DEFAULT 6.00,
  meta_diaria DECIMAL(10,2) DEFAULT 0,
  meta_mensal DECIMAL(10,2) DEFAULT 0,
  ml_access_token TEXT,
  ml_refresh_token TEXT,
  ml_user_id TEXT,
  ml_token_expires_at TIMESTAMP WITH TIME ZONE,
  notificacoes_ativas BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_configuracoes_user_id ON configuracoes(user_id);

-- =====================================================
-- FUNÇÕES E TRIGGERS
-- =====================================================

-- Função para atualizar updated_at automaticamente
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger para produtos
CREATE TRIGGER trigger_produtos_updated_at
  BEFORE UPDATE ON produtos
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- Trigger para configuracoes
CREATE TRIGGER trigger_configuracoes_updated_at
  BEFORE UPDATE ON configuracoes
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- Função para decrementar estoque automaticamente após venda
CREATE OR REPLACE FUNCTION decrementar_estoque()
RETURNS TRIGGER AS $$
BEGIN
  UPDATE produtos
  SET quantidade = quantidade - NEW.qtd_vendida
  WHERE id = NEW.produto_id
    AND quantidade >= NEW.qtd_vendida;
  
  IF NOT FOUND THEN
    RAISE EXCEPTION 'Estoque insuficiente para o produto';
  END IF;
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_decrementar_estoque
  AFTER INSERT ON vendas
  FOR EACH ROW
  WHEN (NEW.produto_id IS NOT NULL)
  EXECUTE FUNCTION decrementar_estoque();

-- =====================================================
-- ROW LEVEL SECURITY (RLS)
-- =====================================================

-- Habilitar RLS
ALTER TABLE produtos ENABLE ROW LEVEL SECURITY;
ALTER TABLE vendas ENABLE ROW LEVEL SECURITY;
ALTER TABLE configuracoes ENABLE ROW LEVEL SECURITY;

-- Políticas para produtos
CREATE POLICY "Usuários podem ver seus próprios produtos"
  ON produtos FOR SELECT
  USING (auth.uid() = user_id);

CREATE POLICY "Usuários podem criar seus próprios produtos"
  ON produtos FOR INSERT
  WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Usuários podem atualizar seus próprios produtos"
  ON produtos FOR UPDATE
  USING (auth.uid() = user_id);

CREATE POLICY "Usuários podem deletar seus próprios produtos"
  ON produtos FOR DELETE
  USING (auth.uid() = user_id);

-- Políticas para vendas
CREATE POLICY "Usuários podem ver suas próprias vendas"
  ON vendas FOR SELECT
  USING (auth.uid() = user_id);

CREATE POLICY "Usuários podem criar suas próprias vendas"
  ON vendas FOR INSERT
  WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Usuários podem deletar suas próprias vendas"
  ON vendas FOR DELETE
  USING (auth.uid() = user_id);

-- Políticas para configuracoes
CREATE POLICY "Usuários podem ver suas próprias configurações"
  ON configuracoes FOR SELECT
  USING (auth.uid() = user_id);

CREATE POLICY "Usuários podem criar suas próprias configurações"
  ON configuracoes FOR INSERT
  WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Usuários podem atualizar suas próprias configurações"
  ON configuracoes FOR UPDATE
  USING (auth.uid() = user_id);

-- =====================================================
-- STORAGE BUCKET
-- =====================================================
-- Execute isso no Supabase Dashboard > Storage:
-- 1. Criar bucket "produtos" (público)
-- 2. Adicionar política de upload para usuários autenticados

-- Política de Storage (executar via SQL Editor):
-- INSERT INTO storage.buckets (id, name, public) VALUES ('produtos', 'produtos', true);

-- CREATE POLICY "Usuários autenticados podem fazer upload"
--   ON storage.objects FOR INSERT
--   WITH CHECK (bucket_id = 'produtos' AND auth.role() = 'authenticated');

-- CREATE POLICY "Qualquer um pode ver imagens de produtos"
--   ON storage.objects FOR SELECT
--   USING (bucket_id = 'produtos');

-- CREATE POLICY "Usuários podem deletar suas próprias imagens"
--   ON storage.objects FOR DELETE
--   USING (bucket_id = 'produtos' AND auth.uid()::text = (storage.foldername(name))[1]);
</file>

<file path=".env.example">
# Variáveis de Ambiente - LLControl

# Supabase
NEXT_PUBLIC_SUPABASE_URL=sua_supabase_url_aqui
NEXT_PUBLIC_SUPABASE_ANON_KEY=sua_supabase_anon_key_aqui
SUPABASE_SERVICE_ROLE_KEY=sua_service_role_key_aqui

# Mercado Livre (opcional - para integração)
ML_APP_ID=seu_app_id_mercadolivre
ML_CLIENT_SECRET=seu_client_secret_mercadolivre
ML_REDIRECT_URI=https://seu-dominio.vercel.app/api/ml-callback

# URL base da aplicação
NEXT_PUBLIC_APP_URL=http://localhost:3000
</file>

<file path=".gitignore">
# dependencies
/node_modules
/.pnp
.pnp.js

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# local env files
.env*.local

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts

# PWA
public/sw.js
public/workbox-*.js
public/sw.js.map
public/workbox-*.js.map
</file>

<file path="next.config.js">
/** @type {import('next').NextConfig} */
const nextConfig = {
  reactStrictMode: true,
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: '*.supabase.co',
        pathname: '/storage/v1/object/public/**',
      },
    ],
  },
};

module.exports = nextConfig;
</file>

<file path="package.json">
{
  "name": "llcontrol",
  "version": "1.0.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  },
  "dependencies": {
    "@radix-ui/react-dialog": "^1.1.2",
    "@radix-ui/react-select": "^2.1.2",
    "@radix-ui/react-switch": "^1.1.1",
    "@radix-ui/react-tabs": "^1.1.1",
    "@radix-ui/react-toast": "^1.2.2",
    "@supabase/ssr": "^0.5.1",
    "@supabase/supabase-js": "^2.45.4",
    "clsx": "^2.1.1",
    "date-fns": "^4.1.0",
    "date-fns-tz": "^3.2.0",
    "framer-motion": "^11.11.7",
    "lucide-react": "^0.453.0",
    "next": "^14.2.18",
    "react": "^18.3.1",
    "react-dom": "^18.3.1",
    "recharts": "^2.13.0",
    "tailwind-merge": "^2.5.4"
  },
  "devDependencies": {
    "@types/node": "^22.7.9",
    "@types/react": "^18.3.12",
    "@types/react-dom": "^18.3.1",
    "autoprefixer": "^10.4.20",
    "eslint": "^8.57.1",
    "eslint-config-next": "14.2.15",
    "next-pwa": "^5.6.0",
    "postcss": "^8.4.47",
    "tailwindcss": "^3.4.14",
    "typescript": "^5.6.3"
  }
}
</file>

<file path="postcss.config.js">
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
};
</file>

<file path="README.md">
# LLControl

Gestão de Estoque e Vendas integrado com Mercado Livre.

## 🚀 Stack Tecnológica

- **Framework:** Next.js 14+ (App Router)
- **Estilização:** Tailwind CSS + Framer Motion
- **Backend/Banco:** Supabase (Auth, PostgreSQL, Storage)
- **PWA:** next-pwa
- **Iconografia:** Lucide React
- **Componentes:** Radix UI

## 📱 Funcionalidades

- ✅ Dashboard com visões Diária/Semanal/Mensal
- ✅ Gestão de Estoque com upload de fotos
- ✅ Cálculo automático de taxas do Mercado Livre
- ✅ Registro de vendas manuais com swipe-to-action
- ✅ Histórico de vendas agrupado por data
- ✅ Configurações de taxas e metas
- ✅ PWA com suporte offline
- ✅ Webhook para integração com Mercado Livre

## 🛠️ Instalação

### 1. Clone e instale as dependências

```bash
cd llcontrol
npm install
```

### 2. Configure o Supabase

1. Crie um projeto no [Supabase](https://supabase.com)
2. Execute o schema SQL em `supabase/schema.sql`
3. Crie um bucket chamado `produtos` no Storage (público)
4. Copie as credenciais para o arquivo `.env.local`

### 3. Configure as variáveis de ambiente

```bash
cp .env.example .env.local
```

Edite o `.env.local` com suas credenciais:

```env
NEXT_PUBLIC_SUPABASE_URL=https://xxxxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOi...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOi...
```

### 4. Rode o projeto

```bash
npm run dev
```

Acesse [http://localhost:3000](http://localhost:3000)

## 📂 Estrutura do Projeto

```
llcontrol/
├── public/
│   ├── manifest.json       # PWA manifest
│   └── icons/              # Ícones do app
├── src/
│   ├── app/
│   │   ├── (app)/          # Rotas com Tab Bar
│   │   │   ├── dashboard/  # Dashboard analítico
│   │   │   ├── estoque/    # Gestão de inventário
│   │   │   ├── vendas/     # Histórico de vendas
│   │   │   └── ajustes/    # Configurações
│   │   ├── api/
│   │   │   └── ml-webhook/ # Webhook Mercado Livre
│   │   ├── layout.tsx      # Layout raiz
│   │   └── globals.css     # Estilos globais
│   ├── components/
│   │   ├── navigation/     # Tab Bar
│   │   └── ui/             # Componentes reutilizáveis
│   ├── lib/
│   │   ├── supabase/       # Cliente Supabase
│   │   └── utils/          # Funções utilitárias
│   └── types/              # Tipos TypeScript
├── supabase/
│   └── schema.sql          # Schema do banco
└── package.json
```

## 💰 Cálculo de Taxas

O app calcula automaticamente:

- **Taxa Clássico:** 11% (configurável)
- **Taxa Premium:** 16% (configurável)
- **Taxa Fixa:** R$ 6,00 em vendas < R$ 79,00

**Fórmula do Lucro:**
```
Lucro = Valor Venda - Custo - (Valor × Taxa%) - Taxa Fixa
```

## 🔗 Integração Mercado Livre

1. Crie um app em [Mercado Livre Developers](https://developers.mercadolibre.com)
2. Configure o webhook: `https://seu-dominio.vercel.app/api/ml-webhook`
3. Conecte sua conta na página de Ajustes

O app escuta eventos de `orders` e atualiza automaticamente:
- Estoque do produto
- Registro de venda
- Cálculo de lucro

## 🎨 Design iOS-Native

- Tab Bar inferior com glassmorphism
- Transições suaves com Framer Motion
- Swipe-to-action para ações rápidas
- Feedback háptico simulado
- Safe area para notch do iPhone
- Modais slide-up

## 📦 Deploy na Vercel

[![Deploy with Vercel](https://vercel.com/button)](https://vercel.com/new/clone?repository-url=https://github.com/seu-usuario/llcontrol)

1. Conecte seu repositório
2. Configure as variáveis de ambiente
3. Deploy automático!

## 📄 Licença

MIT
</file>

<file path="supabase_ml_schema.sql">
-- SQL para adicionar campos de integração com Mercado Livre
-- Execute este SQL no Supabase Dashboard > SQL Editor

-- Adicionar colunas na tabela configuracoes para ML
ALTER TABLE configuracoes 
ADD COLUMN IF NOT EXISTS ml_user_id TEXT,
ADD COLUMN IF NOT EXISTS ml_access_token TEXT,
ADD COLUMN IF NOT EXISTS ml_refresh_token TEXT,
ADD COLUMN IF NOT EXISTS ml_token_expires TIMESTAMP WITH TIME ZONE,
ADD COLUMN IF NOT EXISTS ml_nickname TEXT;

-- Adicionar coluna ml_order_id na tabela vendas (para evitar duplicatas)
ALTER TABLE vendas 
ADD COLUMN IF NOT EXISTS ml_order_id TEXT;

-- Criar índice para busca rápida por ml_id nos produtos
CREATE INDEX IF NOT EXISTS idx_produtos_ml_id ON produtos(ml_id);

-- Criar índice para busca por ml_order_id nas vendas
CREATE INDEX IF NOT EXISTS idx_vendas_ml_order_id ON vendas(ml_order_id);

-- Criar índice para busca por ml_user_id nas configuracoes
CREATE INDEX IF NOT EXISTS idx_configuracoes_ml_user_id ON configuracoes(ml_user_id);
</file>

<file path="tailwind.config.ts">
import type { Config } from 'tailwindcss';

const config: Config = {
  content: [
    './src/pages/**/*.{js,ts,jsx,tsx,mdx}',
    './src/components/**/*.{js,ts,jsx,tsx,mdx}',
    './src/app/**/*.{js,ts,jsx,tsx,mdx}',
  ],
  theme: {
    extend: {
      colors: {
        primary: {
          50: '#eff6ff',
          100: '#dbeafe',
          200: '#bfdbfe',
          300: '#93c5fd',
          400: '#60a5fa',
          500: '#3b82f6',
          600: '#2563eb',
          700: '#1d4ed8',
          800: '#1e40af',
          900: '#1e3a8a',
          950: '#172554',
        },
        success: {
          50: '#f0fdf4',
          100: '#dcfce7',
          500: '#22c55e',
          600: '#16a34a',
        },
        warning: {
          50: '#fffbeb',
          100: '#fef3c7',
          500: '#f59e0b',
          600: '#d97706',
        },
        danger: {
          50: '#fef2f2',
          100: '#fee2e2',
          500: '#ef4444',
          600: '#dc2626',
        },
      },
      fontFamily: {
        sans: [
          '-apple-system',
          'BlinkMacSystemFont',
          'SF Pro Display',
          'Segoe UI',
          'Roboto',
          'Helvetica Neue',
          'Arial',
          'sans-serif',
        ],
      },
      animation: {
        'slide-up': 'slideUp 0.3s ease-out',
        'slide-down': 'slideDown 0.3s ease-out',
        'fade-in': 'fadeIn 0.2s ease-out',
        'scale-in': 'scaleIn 0.2s ease-out',
      },
      keyframes: {
        slideUp: {
          '0%': { transform: 'translateY(100%)', opacity: '0' },
          '100%': { transform: 'translateY(0)', opacity: '1' },
        },
        slideDown: {
          '0%': { transform: 'translateY(-10px)', opacity: '0' },
          '100%': { transform: 'translateY(0)', opacity: '1' },
        },
        fadeIn: {
          '0%': { opacity: '0' },
          '100%': { opacity: '1' },
        },
        scaleIn: {
          '0%': { transform: 'scale(0.95)', opacity: '0' },
          '100%': { transform: 'scale(1)', opacity: '1' },
        },
      },
      backdropBlur: {
        xs: '2px',
      },
    },
  },
  plugins: [],
};

export default config;
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "lib": [
      "dom",
      "dom.iterable",
      "esnext"
    ],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": [
        "./src/*"
      ]
    },
    "target": "ES2017"
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts"
  ],
  "exclude": [
    "node_modules"
  ]
}
</file>

<file path="src/app/(app)/estoque/components/ProdutoForm.tsx">
'use client';

import { useState, useEffect } from 'react';
import { motion } from 'framer-motion';
import { 
  Button, 
  Input, 
  ImageUpload,
  useToast 
} from '@/components/ui';
import { 
  formatarMoeda, 
  formatarPercentual, 
  calcularLucroUnitario 
} from '@/lib/utils/calculos';
import { getSupabaseClient } from '@/lib/supabase/client';
import { Produto, ProdutoInsert, TaxaTipo } from '@/types/database';
import { hapticFeedback } from '@/lib/utils/helpers';

interface ProdutoFormProps {
  produto?: Produto | null;
  onSuccess: () => void;
  onCancel: () => void;
}

export default function ProdutoForm({ produto, onSuccess, onCancel }: ProdutoFormProps) {
  const [isLoading, setIsLoading] = useState(false);
  const [formData, setFormData] = useState({
    nome: '',
    quantidade: '',
    valor_pago: '',
    valor_venda: '',
    taxa_tipo: 'classico' as TaxaTipo,
    foto_url: '',
  });

  const { addToast } = useToast();

  useEffect(() => {
    if (produto) {
      setFormData({
        nome: produto.nome,
        quantidade: produto.quantidade.toString(),
        valor_pago: produto.valor_pago.toString(),
        valor_venda: produto.valor_venda.toString(),
        taxa_tipo: produto.taxa_tipo,
        foto_url: produto.foto_url || '',
      });
    }
  }, [produto]);

  const valorPago = parseFloat(formData.valor_pago) || 0;
  const valorVenda = parseFloat(formData.valor_venda) || 0;

  const calculo = calcularLucroUnitario(valorVenda, valorPago, formData.taxa_tipo);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!formData.nome.trim()) {
      addToast({ type: 'error', title: 'Nome é obrigatório' });
      return;
    }

    if (valorPago <= 0 || valorVenda <= 0) {
      addToast({ type: 'error', title: 'Valores devem ser maiores que zero' });
      return;
    }

    setIsLoading(true);

    try {
      const supabase = getSupabaseClient();
      const { data: { user } } = await supabase.auth.getUser();

      if (!user) {
        addToast({ type: 'error', title: 'Usuário não autenticado' });
        return;
      }

      const produtoData = {
        nome: formData.nome.trim(),
        quantidade: parseInt(formData.quantidade) || 0,
        valor_pago: valorPago,
        valor_venda: valorVenda,
        taxa_tipo: formData.taxa_tipo,
        foto_url: formData.foto_url || null,
        user_id: user.id,
      };

      if (produto) {
        // Update
        const { error } = await supabase
          .from('produtos')
          .update(produtoData)
          .eq('id', produto.id);

        if (error) throw error;

        hapticFeedback('medium');
        addToast({ type: 'success', title: 'Produto atualizado!' });
      } else {
        // Insert
        const { error } = await supabase
          .from('produtos')
          .insert(produtoData as any);

        if (error) throw error;

        hapticFeedback('medium');
        addToast({ type: 'success', title: 'Produto cadastrado!' });
      }

      onSuccess();
    } catch (error) {
      console.error('Erro ao salvar produto:', error);
      addToast({
        type: 'error',
        title: 'Erro ao salvar produto',
        description: 'Tente novamente',
      });
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      {/* Image Upload */}
      <div className="flex justify-center">
        <ImageUpload
          value={formData.foto_url}
          onChange={(url) => setFormData((prev) => ({ ...prev, foto_url: url || '' }))}
        />
      </div>

      {/* Nome */}
      <Input
        label="Nome do Produto"
        placeholder="Ex: Camiseta Nike"
        value={formData.nome}
        onChange={(e) => setFormData((prev) => ({ ...prev, nome: e.target.value }))}
        required
      />

      {/* Quantidade */}
      <Input
        label="Quantidade Comprada"
        type="number"
        placeholder="0"
        min="0"
        value={formData.quantidade}
        onChange={(e) => setFormData((prev) => ({ ...prev, quantidade: e.target.value }))}
      />

      {/* Valores */}
      <div className="grid grid-cols-2 gap-3">
        <Input
          label="Custo Unitário (R$)"
          type="number"
          placeholder="0,00"
          step="0.01"
          min="0"
          value={formData.valor_pago}
          onChange={(e) => setFormData((prev) => ({ ...prev, valor_pago: e.target.value }))}
          required
        />
        <Input
          label="Preço de Venda (R$)"
          type="number"
          placeholder="0,00"
          step="0.01"
          min="0"
          value={formData.valor_venda}
          onChange={(e) => setFormData((prev) => ({ ...prev, valor_venda: e.target.value }))}
          required
        />
      </div>

      {/* Tipo de Taxa */}
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-2">
          Tipo de Anúncio Mercado Livre
        </label>
        <div className="grid grid-cols-2 gap-3">
          <button
            type="button"
            onClick={() => setFormData((prev) => ({ ...prev, taxa_tipo: 'classico' }))}
            className={`p-3 rounded-xl border-2 transition-all ${
              formData.taxa_tipo === 'classico'
                ? 'border-primary-500 bg-primary-50'
                : 'border-gray-200 bg-white'
            }`}
          >
            <span className={`font-medium ${
              formData.taxa_tipo === 'classico' ? 'text-primary-700' : 'text-gray-700'
            }`}>
              Clássico
            </span>
            <span className="block text-sm text-gray-500 mt-0.5">11% de taxa</span>
          </button>
          <button
            type="button"
            onClick={() => setFormData((prev) => ({ ...prev, taxa_tipo: 'premium' }))}
            className={`p-3 rounded-xl border-2 transition-all ${
              formData.taxa_tipo === 'premium'
                ? 'border-primary-500 bg-primary-50'
                : 'border-gray-200 bg-white'
            }`}
          >
            <span className={`font-medium ${
              formData.taxa_tipo === 'premium' ? 'text-primary-700' : 'text-gray-700'
            }`}>
              Premium
            </span>
            <span className="block text-sm text-gray-500 mt-0.5">16% de taxa</span>
          </button>
        </div>
      </div>

      {/* Preview de Cálculos */}
      {valorVenda > 0 && valorPago > 0 && (
        <motion.div
          initial={{ opacity: 0, height: 0 }}
          animate={{ opacity: 1, height: 'auto' }}
          className="p-4 bg-gray-50 rounded-xl space-y-2"
        >
          <div className="flex justify-between text-sm">
            <span className="text-gray-600">Taxa ML ({calculo.taxaPercentual}%)</span>
            <span className="text-gray-900">
              - {formatarMoeda((valorVenda * calculo.taxaPercentual) / 100)}
            </span>
          </div>
          {calculo.taxaFixa > 0 && (
            <div className="flex justify-between text-sm">
              <span className="text-gray-600">Taxa Fixa</span>
              <span className="text-gray-900">- {formatarMoeda(calculo.taxaFixa)}</span>
            </div>
          )}
          <div className="border-t border-gray-200 pt-2 flex justify-between">
            <span className="font-medium text-gray-700">Lucro por Unidade</span>
            <span className={`font-bold ${
              calculo.lucroUnitario >= 0 ? 'text-success-600' : 'text-danger-600'
            }`}>
              {formatarMoeda(calculo.lucroUnitario)}
            </span>
          </div>
          <div className="flex justify-between">
            <span className="font-medium text-gray-700">Margem</span>
            <span className={`font-bold ${
              calculo.margemPercentual >= 0 ? 'text-success-600' : 'text-danger-600'
            }`}>
              {formatarPercentual(calculo.margemPercentual)}
            </span>
          </div>
        </motion.div>
      )}

      {/* Actions */}
      <div className="flex gap-3 pt-4">
        <Button
          type="button"
          variant="secondary"
          fullWidth
          onClick={onCancel}
        >
          Cancelar
        </Button>
        <Button
          type="submit"
          fullWidth
          isLoading={isLoading}
        >
          {produto ? 'Salvar' : 'Cadastrar'}
        </Button>
      </div>
    </form>
  );
}
</file>

<file path="src/app/(app)/estoque/components/VendaRapidaModal.tsx">
'use client';

import { useState } from 'react';
import { motion } from 'framer-motion';
import { Minus, Plus, ShoppingCart } from 'lucide-react';
import { Modal, Button, useToast } from '@/components/ui';
import { 
  formatarMoeda, 
  calcularLucroVenda 
} from '@/lib/utils/calculos';
import { getSupabaseClient } from '@/lib/supabase/client';
import { Produto, VendaInsert } from '@/types/database';
import { hapticFeedback } from '@/lib/utils/helpers';

interface VendaRapidaModalProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  produto: Produto;
  onSuccess: () => void;
}

export default function VendaRapidaModal({
  open,
  onOpenChange,
  produto,
  onSuccess,
}: VendaRapidaModalProps) {
  const [quantidade, setQuantidade] = useState(1);
  const [isLoading, setIsLoading] = useState(false);
  const { addToast } = useToast();

  const calculo = calcularLucroVenda(
    produto.valor_venda,
    produto.valor_pago,
    quantidade,
    produto.taxa_tipo
  );

  const handleQuantidadeChange = (delta: number) => {
    const novaQuantidade = quantidade + delta;
    if (novaQuantidade >= 1 && novaQuantidade <= produto.quantidade) {
      setQuantidade(novaQuantidade);
      hapticFeedback('light');
    }
  };

  const handleConfirmar = async () => {
    if (quantidade > produto.quantidade) {
      addToast({
        type: 'error',
        title: 'Estoque insuficiente',
        description: `Disponível: ${produto.quantidade} un.`,
      });
      return;
    }

    setIsLoading(true);

    try {
      const supabase = getSupabaseClient();
      const { data: { user } } = await supabase.auth.getUser();

      if (!user) {
        addToast({ type: 'error', title: 'Usuário não autenticado' });
        return;
      }

      const vendaData = {
        produto_id: produto.id,
        produto_nome: produto.nome,
        qtd_vendida: quantidade,
        valor_unitario: produto.valor_venda,
        valor_final: calculo.valorFinal,
        custo_unitario: produto.valor_pago,
        taxa_tipo: produto.taxa_tipo,
        taxa_percentual: calculo.taxaPercentual,
        taxa_fixa: calculo.taxaFixa,
        lucro_liquido: calculo.lucroLiquido,
        origem: 'manual',
        user_id: user.id,
      };

      const { error } = await supabase.from('vendas').insert(vendaData as any);

      if (error) throw error;

      hapticFeedback('heavy');
      addToast({
        type: 'success',
        title: 'Venda registrada!',
        description: `Lucro: ${formatarMoeda(calculo.lucroLiquido)}`,
      });

      onSuccess();
    } catch (error) {
      console.error('Erro ao registrar venda:', error);
      addToast({
        type: 'error',
        title: 'Erro ao registrar venda',
        description: 'Tente novamente',
      });
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <Modal
      open={open}
      onOpenChange={onOpenChange}
      title="Registrar Venda"
      description={produto.nome}
    >
      <div className="space-y-6">
        {/* Quantidade Selector */}
        <div className="flex items-center justify-center gap-4">
          <button
            onClick={() => handleQuantidadeChange(-1)}
            disabled={quantidade <= 1}
            className="w-12 h-12 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 disabled:opacity-40 active:scale-90 transition-transform"
          >
            <Minus className="w-5 h-5" />
          </button>
          
          <div className="text-center">
            <motion.span
              key={quantidade}
              initial={{ scale: 0.8, opacity: 0 }}
              animate={{ scale: 1, opacity: 1 }}
              className="text-4xl font-bold text-gray-900"
            >
              {quantidade}
            </motion.span>
            <p className="text-sm text-gray-500 mt-1">
              de {produto.quantidade} disponíveis
            </p>
          </div>
          
          <button
            onClick={() => handleQuantidadeChange(1)}
            disabled={quantidade >= produto.quantidade}
            className="w-12 h-12 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 disabled:opacity-40 active:scale-90 transition-transform"
          >
            <Plus className="w-5 h-5" />
          </button>
        </div>

        {/* Resumo */}
        <div className="bg-gray-50 rounded-xl p-4 space-y-3">
          <div className="flex justify-between text-sm">
            <span className="text-gray-600">Valor da Venda</span>
            <span className="font-medium text-gray-900">
              {formatarMoeda(calculo.valorFinal)}
            </span>
          </div>
          <div className="flex justify-between text-sm">
            <span className="text-gray-600">Custo dos Produtos</span>
            <span className="text-gray-900">
              - {formatarMoeda(calculo.custoTotal)}
            </span>
          </div>
          <div className="flex justify-between text-sm">
            <span className="text-gray-600">Taxas ML ({calculo.taxaPercentual}%)</span>
            <span className="text-gray-900">
              - {formatarMoeda(calculo.totalTaxas)}
            </span>
          </div>
          <div className="border-t border-gray-200 pt-3 flex justify-between">
            <span className="font-semibold text-gray-900">Lucro Líquido</span>
            <span className={`text-xl font-bold ${
              calculo.lucroLiquido >= 0 ? 'text-success-600' : 'text-danger-600'
            }`}>
              {formatarMoeda(calculo.lucroLiquido)}
            </span>
          </div>
        </div>

        {/* Actions */}
        <div className="flex gap-3">
          <Button
            variant="secondary"
            fullWidth
            onClick={() => onOpenChange(false)}
          >
            Cancelar
          </Button>
          <Button
            fullWidth
            isLoading={isLoading}
            leftIcon={<ShoppingCart className="w-5 h-5" />}
            onClick={handleConfirmar}
          >
            Confirmar Venda
          </Button>
        </div>
      </div>
    </Modal>
  );
}
</file>

<file path="src/app/(app)/estoque/page.tsx">
'use client';

import { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { Plus, Search, Package, AlertCircle } from 'lucide-react';
import { 
  Button, 
  Input, 
  Card, 
  Modal, 
  SwipeableItem, 
  ConfirmModal,
  ImageUpload,
  useToast 
} from '@/components/ui';
import { 
  formatarMoeda, 
  formatarPercentual, 
  calcularLucroUnitario,
  getCorLucro,
  getBgCorLucro 
} from '@/lib/utils/calculos';
import { getSupabaseClient } from '@/lib/supabase/client';
import { Produto, ProdutoInsert, TaxaTipo } from '@/types/database';
import { hapticFeedback } from '@/lib/utils/helpers';
import ProdutoForm from './components/ProdutoForm';
import VendaRapidaModal from './components/VendaRapidaModal';

export default function EstoquePage() {
  const [produtos, setProdutos] = useState<Produto[]>([]);
  const [filteredProdutos, setFilteredProdutos] = useState<Produto[]>([]);
  const [searchQuery, setSearchQuery] = useState('');
  const [isLoading, setIsLoading] = useState(true);
  const [showAddModal, setShowAddModal] = useState(false);
  const [showDeleteModal, setShowDeleteModal] = useState(false);
  const [showVendaModal, setShowVendaModal] = useState(false);
  const [selectedProduto, setSelectedProduto] = useState<Produto | null>(null);
  const [editingProduto, setEditingProduto] = useState<Produto | null>(null);

  const { addToast } = useToast();

  useEffect(() => {
    carregarProdutos();
  }, []);

  useEffect(() => {
    if (searchQuery.trim()) {
      const filtered = produtos.filter((p) =>
        p.nome.toLowerCase().includes(searchQuery.toLowerCase())
      );
      setFilteredProdutos(filtered);
    } else {
      setFilteredProdutos(produtos);
    }
  }, [searchQuery, produtos]);

  const carregarProdutos = async () => {
    try {
      const supabase = getSupabaseClient();
      const { data, error } = await supabase
        .from('produtos')
        .select('*')
        .eq('ativo', true)
        .order('created_at', { ascending: false });

      if (error) throw error;
      setProdutos(data || []);
    } catch (error) {
      console.error('Erro ao carregar produtos:', error);
      addToast({
        type: 'error',
        title: 'Erro ao carregar produtos',
        description: 'Tente novamente mais tarde',
      });
    } finally {
      setIsLoading(false);
    }
  };

  const handleDelete = async () => {
    if (!selectedProduto) return;

    try {
      const supabase = getSupabaseClient();
      const { error } = await supabase
        .from('produtos')
        .update({ ativo: false })
        .eq('id', selectedProduto.id);

      if (error) throw error;

      hapticFeedback('medium');
      setProdutos((prev) => prev.filter((p) => p.id !== selectedProduto.id));
      addToast({
        type: 'success',
        title: 'Produto excluído',
      });
    } catch (error) {
      console.error('Erro ao excluir produto:', error);
      addToast({
        type: 'error',
        title: 'Erro ao excluir produto',
      });
    } finally {
      setShowDeleteModal(false);
      setSelectedProduto(null);
    }
  };

  const handleVendaRapida = (produto: Produto) => {
    setSelectedProduto(produto);
    setShowVendaModal(true);
  };

  const handleVendaConfirmada = () => {
    carregarProdutos();
    setShowVendaModal(false);
    setSelectedProduto(null);
  };

  const handleEdit = (produto: Produto) => {
    setEditingProduto(produto);
    setShowAddModal(true);
  };

  const handleProdutoSaved = () => {
    carregarProdutos();
    setShowAddModal(false);
    setEditingProduto(null);
  };

  const estoqueTotal = produtos.reduce((acc, p) => acc + p.quantidade, 0);
  const valorEstoque = produtos.reduce((acc, p) => acc + (p.quantidade * p.valor_pago), 0);

  return (
    <div className="min-h-screen bg-gray-50 pt-safe">
      {/* Header */}
      <div className="bg-white px-4 pt-6 pb-4 border-b border-gray-100">
        <div className="flex items-center justify-between mb-4">
          <div>
            <h1 className="text-2xl font-bold text-gray-900">Estoque</h1>
            <p className="text-sm text-gray-500 mt-0.5">
              {estoqueTotal} itens • {formatarMoeda(valorEstoque)} em estoque
            </p>
          </div>
          <Button
            size="sm"
            leftIcon={<Plus className="w-4 h-4" />}
            onClick={() => setShowAddModal(true)}
          >
            Novo
          </Button>
        </div>

        {/* Search */}
        <Input
          placeholder="Buscar produto..."
          value={searchQuery}
          onChange={(e) => setSearchQuery(e.target.value)}
          leftIcon={<Search className="w-5 h-5" />}
        />
      </div>

      {/* Products List */}
      <div className="px-4 py-4 space-y-3">
        {isLoading ? (
          <div className="flex items-center justify-center py-12">
            <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600" />
          </div>
        ) : filteredProdutos.length === 0 ? (
          <div className="flex flex-col items-center justify-center py-12 text-center">
            <Package className="w-12 h-12 text-gray-300 mb-3" />
            <p className="text-gray-500 font-medium">Nenhum produto encontrado</p>
            <p className="text-sm text-gray-400 mt-1">
              {searchQuery ? 'Tente outra busca' : 'Adicione seu primeiro produto'}
            </p>
          </div>
        ) : (
          <AnimatePresence>
            {filteredProdutos.map((produto, index) => {
              const calculo = calcularLucroUnitario(
                produto.valor_venda,
                produto.valor_pago,
                produto.taxa_tipo
              );

              return (
                <motion.div
                  key={produto.id}
                  initial={{ opacity: 0, y: 20 }}
                  animate={{ opacity: 1, y: 0 }}
                  exit={{ opacity: 0, x: -100 }}
                  transition={{ delay: index * 0.05 }}
                >
                  <SwipeableItem
                    onDelete={() => {
                      setSelectedProduto(produto);
                      setShowDeleteModal(true);
                    }}
                    onEdit={() => handleEdit(produto)}
                    onSell={() => handleVendaRapida(produto)}
                  >
                    <Card 
                      className="flex items-center gap-3 cursor-pointer active:bg-gray-50 transition-colors"
                      onClick={() => handleEdit(produto)}
                    >
                      {/* Product Image */}
                      <div className="w-16 h-16 rounded-xl bg-gray-100 overflow-hidden flex-shrink-0">
                        {produto.foto_url ? (
                          <img
                            src={produto.foto_url}
                            alt={produto.nome}
                            className="w-full h-full object-cover"
                          />
                        ) : (
                          <div className="w-full h-full flex items-center justify-center">
                            <Package className="w-6 h-6 text-gray-400" />
                          </div>
                        )}
                      </div>

                      {/* Product Info */}
                      <div className="flex-1 min-w-0">
                        <h3 className="font-semibold text-gray-900 truncate">
                          {produto.nome}
                        </h3>
                        <div className="flex items-center gap-2 mt-1">
                          <span className="text-sm text-gray-500">
                            {formatarMoeda(produto.valor_venda)}
                          </span>
                          <span className="text-xs text-gray-400">•</span>
                          <span className={`text-sm font-medium ${getCorLucro(calculo.lucroUnitario)}`}>
                            Lucro: {formatarMoeda(calculo.lucroUnitario)}
                          </span>
                        </div>
                        <div className="flex items-center gap-2 mt-1">
                          <span className={`text-xs px-2 py-0.5 rounded-full ${
                            produto.quantidade > 5 
                              ? 'bg-success-100 text-success-700'
                              : produto.quantidade > 0
                              ? 'bg-warning-100 text-warning-700'
                              : 'bg-danger-100 text-danger-700'
                          }`}>
                            {produto.quantidade} un.
                          </span>
                          <span className="text-xs text-gray-400 uppercase">
                            {produto.taxa_tipo}
                          </span>
                        </div>
                      </div>

                      {/* Margin Badge */}
                      <div className={`px-2 py-1 rounded-lg ${getBgCorLucro(calculo.lucroUnitario)}`}>
                        <span className={`text-sm font-bold ${getCorLucro(calculo.lucroUnitario)}`}>
                          {formatarPercentual(calculo.margemPercentual)}
                        </span>
                      </div>
                    </Card>
                  </SwipeableItem>
                </motion.div>
              );
            })}
          </AnimatePresence>
        )}
      </div>

      {/* Add/Edit Product Modal */}
      <Modal
        open={showAddModal}
        onOpenChange={(open) => {
          setShowAddModal(open);
          if (!open) setEditingProduto(null);
        }}
        title={editingProduto ? 'Editar Produto' : 'Novo Produto'}
      >
        <ProdutoForm
          produto={editingProduto}
          onSuccess={handleProdutoSaved}
          onCancel={() => {
            setShowAddModal(false);
            setEditingProduto(null);
          }}
        />
      </Modal>

      {/* Delete Confirmation Modal */}
      <ConfirmModal
        open={showDeleteModal}
        onOpenChange={setShowDeleteModal}
        title="Excluir Produto"
        description={`Tem certeza que deseja excluir "${selectedProduto?.nome}"?`}
        confirmText="Excluir"
        variant="danger"
        onConfirm={handleDelete}
      />

      {/* Venda Rápida Modal */}
      {selectedProduto && (
        <VendaRapidaModal
          open={showVendaModal}
          onOpenChange={setShowVendaModal}
          produto={selectedProduto}
          onSuccess={handleVendaConfirmada}
        />
      )}
    </div>
  );
}
</file>

<file path="src/app/(app)/mercadolivre/page.tsx">
'use client';

import { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import {
  Package,
  ShoppingCart,
  MessageCircle,
  TrendingUp,
  DollarSign,
  AlertCircle,
  RefreshCw,
  ExternalLink,
  ChevronRight,
  Star,
  Clock,
  CheckCircle,
  XCircle,
  HelpCircle,
  Truck,
  Eye,
  BarChart3,
  Users,
  Bell,
  Search
} from 'lucide-react';
import { Card, Button, useToast } from '@/components/ui';
import { formatarMoeda } from '@/lib/utils/calculos';
import { getSupabaseClient } from '@/lib/supabase/client';
import { cn } from '@/lib/utils/helpers';

interface MLAnuncio {
  id: string;
  title: string;
  price: number;
  available_quantity: number;
  sold_quantity: number;
  thumbnail: string;
  permalink: string;
  status: string;
  health?: number;
  visits?: number;
}

interface MLVenda {
  id: number;
  status: string;
  date_created: string;
  total_amount: number;
  buyer: {
    nickname: string;
  };
  order_items: {
    item: { title: string };
    quantity: number;
    unit_price: number;
  }[];
}

interface MLPergunta {
  id: number;
  text: string;
  status: string;
  date_created: string;
  item_id: string;
}

interface MLMensagem {
  id: string;
  text: string;
  date_created: string;
  from: { user_id: number };
}

interface MLResumo {
  totalAnuncios: number;
  anunciosAtivos: number;
  totalVendas30d: number;
  faturamento30d: number;
  perguntasPendentes: number;
  mensagensNaoLidas: number;
  reputacao: number;
  visitas30d: number;
}

type TabType = 'resumo' | 'anuncios' | 'vendas' | 'mensagens' | 'perguntas';

export default function MercadoLivrePage() {
  const [activeTab, setActiveTab] = useState<TabType>('resumo');
  const [isLoading, setIsLoading] = useState(true);
  const [isRefreshing, setIsRefreshing] = useState(false);
  const [mlConnected, setMlConnected] = useState(false);
  const [mlNickname, setMlNickname] = useState('');
  const [userId, setUserId] = useState('');
  
  const [resumo, setResumo] = useState<MLResumo>({
    totalAnuncios: 0,
    anunciosAtivos: 0,
    totalVendas30d: 0,
    faturamento30d: 0,
    perguntasPendentes: 0,
    mensagensNaoLidas: 0,
    reputacao: 0,
    visitas30d: 0,
  });
  
  const [anuncios, setAnuncios] = useState<MLAnuncio[]>([]);
  const [vendas, setVendas] = useState<MLVenda[]>([]);
  const [perguntas, setPerguntas] = useState<MLPergunta[]>([]);

  const { addToast } = useToast();

  useEffect(() => {
    checkMLConnection();
  }, []);

  const checkMLConnection = async () => {
    try {
      const supabase = getSupabaseClient();
      const { data: { user } } = await supabase.auth.getUser();
      
      if (user) {
        setUserId(user.id);
        
        const { data: config } = await supabase
          .from('configuracoes')
          .select('ml_user_id, ml_nickname, ml_access_token')
          .eq('user_id', user.id)
          .single();
        
        if (config?.ml_access_token) {
          setMlConnected(true);
          setMlNickname(config.ml_nickname || '');
          // Passar userId diretamente para evitar problema de estado
          await loadAllDataWithUserId(user.id);
        }
      }
    } catch (error) {
      console.error('Erro ao verificar conexão ML:', error);
    } finally {
      setIsLoading(false);
    }
  };

  const loadAllDataWithUserId = async (uid: string) => {
    setIsRefreshing(true);
    try {
      await Promise.all([
        loadAnunciosWithUserId(uid),
        loadVendasWithUserId(uid),
        loadPerguntasWithUserId(uid),
      ]);
    } catch (error) {
      console.error('Erro ao carregar dados:', error);
    } finally {
      setIsRefreshing(false);
    }
  };

  const loadAllData = async () => {
    if (!userId) return;
    await loadAllDataWithUserId(userId);
  };

  const loadAnunciosWithUserId = async (uid: string) => {
    try {
      const response = await fetch('/api/mercadolivre/items', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: uid }),
      });

      if (response.ok) {
        const data = await response.json();
        const items = data.items || [];
        setAnuncios(items);
        
        // Atualizar resumo
        const ativos = items.filter((i: MLAnuncio) => i.status === 'active');
        const totalVisitas = items.reduce((acc: number, i: MLAnuncio) => acc + (i.visits || 0), 0);
        
        setResumo(prev => ({
          ...prev,
          totalAnuncios: items.length,
          anunciosAtivos: ativos.length,
          visitas30d: totalVisitas,
        }));
      }
    } catch (error) {
      console.error('Erro ao carregar anúncios:', error);
    }
  };

  const loadVendasWithUserId = async (uid: string) => {
    try {
      const response = await fetch('/api/mercadolivre/orders', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: uid }),
      });

      if (response.ok) {
        const data = await response.json();
        const orders = data.orders || [];
        setVendas(orders);
        
        // Calcular faturamento
        const faturamento = orders.reduce((acc: number, o: MLVenda) => acc + o.total_amount, 0);
        
        setResumo(prev => ({
          ...prev,
          totalVendas30d: orders.length,
          faturamento30d: faturamento,
        }));
      }
    } catch (error) {
      console.error('Erro ao carregar vendas:', error);
    }
  };

  const loadPerguntasWithUserId = async (uid: string) => {
    try {
      const response = await fetch('/api/mercadolivre/questions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: uid }),
      });

      if (response.ok) {
        const data = await response.json();
        const questions = data.questions || [];
        setPerguntas(questions);
        
        const pendentes = questions.filter((q: MLPergunta) => q.status === 'UNANSWERED');
        
        setResumo(prev => ({
          ...prev,
          perguntasPendentes: pendentes.length,
        }));
      }
    } catch (error) {
      console.error('Erro ao carregar perguntas:', error);
    }
  };

  const loadAnuncios = () => loadAnunciosWithUserId(userId);
  const loadVendas = () => loadVendasWithUserId(userId);
  const loadPerguntas = () => loadPerguntasWithUserId(userId);

  const sincronizarEstoque = async () => {
    setIsRefreshing(true);
    try {
      const response = await fetch('/api/mercadolivre/sync-stock', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: userId }),
      });

      if (response.ok) {
        const data = await response.json();
        addToast({
          type: 'success',
          title: 'Estoque sincronizado!',
          description: `${data.synced} produtos atualizados`,
        });
        await loadAnuncios();
      } else {
        throw new Error('Erro ao sincronizar');
      }
    } catch (error) {
      addToast({
        type: 'error',
        title: 'Erro ao sincronizar estoque',
      });
    } finally {
      setIsRefreshing(false);
    }
  };

  const tabs = [
    { id: 'resumo', label: 'Resumo', icon: BarChart3 },
    { id: 'anuncios', label: 'Anúncios', icon: Package },
    { id: 'vendas', label: 'Vendas', icon: ShoppingCart },
    { id: 'perguntas', label: 'Perguntas', icon: HelpCircle },
  ];

  if (isLoading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <RefreshCw className="w-8 h-8 text-yellow-500 animate-spin" />
      </div>
    );
  }

  if (!mlConnected) {
    return (
      <div className="min-h-screen bg-gray-50 pt-safe pb-24 flex items-center justify-center p-4">
        <Card className="p-8 text-center max-w-sm">
          <div className="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <Package className="w-8 h-8 text-yellow-600" />
          </div>
          <h2 className="text-xl font-bold text-gray-900 mb-2">Conecte seu Mercado Livre</h2>
          <p className="text-gray-500 mb-6">
            Conecte sua conta para ver seus anúncios, vendas e mensagens aqui.
          </p>
          <Button fullWidth onClick={() => window.location.href = '/ajustes'}>
            Ir para Ajustes
          </Button>
        </Card>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 pt-safe pb-24">
      {/* Header */}
      <div className="bg-gradient-to-br from-yellow-500 to-yellow-600 text-white px-4 pt-6 pb-6">
        <div className="flex items-center justify-between mb-4">
          <div>
            <h1 className="text-2xl font-bold">Mercado Livre</h1>
            <p className="text-yellow-100 text-sm mt-0.5">@{mlNickname}</p>
          </div>
          <button
            onClick={loadAllData}
            disabled={isRefreshing}
            className="p-2 bg-white/20 rounded-full"
          >
            <RefreshCw className={cn("w-5 h-5", isRefreshing && "animate-spin")} />
          </button>
        </div>

        {/* Quick Stats */}
        <div className="grid grid-cols-2 gap-3">
          <div className="bg-white/20 backdrop-blur-sm rounded-xl p-3">
            <div className="flex items-center gap-2 mb-1">
              <ShoppingCart className="w-4 h-4" />
              <span className="text-xs text-yellow-100">Vendas (30d)</span>
            </div>
            <p className="text-xl font-bold">{resumo.totalVendas30d}</p>
          </div>
          <div className="bg-white/20 backdrop-blur-sm rounded-xl p-3">
            <div className="flex items-center gap-2 mb-1">
              <DollarSign className="w-4 h-4" />
              <span className="text-xs text-yellow-100">Faturamento</span>
            </div>
            <p className="text-xl font-bold">{formatarMoeda(resumo.faturamento30d)}</p>
          </div>
        </div>
      </div>

      {/* Tabs */}
      <div className="px-4 -mt-3">
        <div className="bg-white rounded-xl shadow-sm p-1 flex gap-1 overflow-x-auto">
          {tabs.map((tab) => (
            <button
              key={tab.id}
              onClick={() => setActiveTab(tab.id as TabType)}
              className={cn(
                "flex-1 flex items-center justify-center gap-1.5 py-2 px-3 rounded-lg text-sm font-medium transition-all min-w-max",
                activeTab === tab.id
                  ? "bg-yellow-500 text-white"
                  : "text-gray-600 hover:bg-gray-100"
              )}
            >
              <tab.icon className="w-4 h-4" />
              {tab.label}
              {tab.id === 'perguntas' && resumo.perguntasPendentes > 0 && (
                <span className="bg-red-500 text-white text-xs px-1.5 rounded-full">
                  {resumo.perguntasPendentes}
                </span>
              )}
            </button>
          ))}
        </div>
      </div>

      {/* Content */}
      <div className="px-4 mt-4">
        <AnimatePresence mode="wait">
          {activeTab === 'resumo' && (
            <motion.div
              key="resumo"
              initial={{ opacity: 0, y: 10 }}
              animate={{ opacity: 1, y: 0 }}
              exit={{ opacity: 0, y: -10 }}
              className="space-y-4"
            >
              {/* Cards de Resumo */}
              <div className="grid grid-cols-2 gap-3">
                <Card className="p-4">
                  <div className="flex items-center gap-2 mb-2">
                    <Package className="w-5 h-5 text-blue-600" />
                    <span className="text-xs text-gray-500">Anúncios Ativos</span>
                  </div>
                  <p className="text-2xl font-bold text-gray-900">{resumo.anunciosAtivos}</p>
                  <p className="text-xs text-gray-400">de {resumo.totalAnuncios} total</p>
                </Card>

                <Card className="p-4">
                  <div className="flex items-center gap-2 mb-2">
                    <Eye className="w-5 h-5 text-purple-600" />
                    <span className="text-xs text-gray-500">Visitas</span>
                  </div>
                  <p className="text-2xl font-bold text-gray-900">{resumo.visitas30d}</p>
                  <p className="text-xs text-gray-400">últimos 30 dias</p>
                </Card>

                <Card className="p-4">
                  <div className="flex items-center gap-2 mb-2">
                    <HelpCircle className="w-5 h-5 text-orange-600" />
                    <span className="text-xs text-gray-500">Perguntas</span>
                  </div>
                  <p className="text-2xl font-bold text-gray-900">{resumo.perguntasPendentes}</p>
                  <p className="text-xs text-gray-400">pendentes</p>
                </Card>

                <Card className="p-4">
                  <div className="flex items-center gap-2 mb-2">
                    <TrendingUp className="w-5 h-5 text-green-600" />
                    <span className="text-xs text-gray-500">Ticket Médio</span>
                  </div>
                  <p className="text-2xl font-bold text-gray-900">
                    {resumo.totalVendas30d > 0 
                      ? formatarMoeda(resumo.faturamento30d / resumo.totalVendas30d)
                      : 'R$ 0'}
                  </p>
                  <p className="text-xs text-gray-400">por venda</p>
                </Card>
              </div>

              {/* Ações Rápidas */}
              <Card className="p-4">
                <h3 className="text-sm font-semibold text-gray-900 mb-3">⚡ Ações Rápidas</h3>
                <div className="space-y-2">
                  <button
                    onClick={sincronizarEstoque}
                    disabled={isRefreshing}
                    className="w-full flex items-center justify-between p-3 bg-yellow-50 rounded-xl text-left hover:bg-yellow-100 transition-colors"
                  >
                    <div className="flex items-center gap-3">
                      <RefreshCw className={cn("w-5 h-5 text-yellow-600", isRefreshing && "animate-spin")} />
                      <div>
                        <p className="font-medium text-gray-900">Sincronizar Estoque</p>
                        <p className="text-xs text-gray-500">Importar produtos do ML</p>
                      </div>
                    </div>
                    <ChevronRight className="w-5 h-5 text-gray-400" />
                  </button>

                  <a
                    href="https://www.mercadolivre.com.br/vendas/listagem"
                    target="_blank"
                    rel="noopener noreferrer"
                    className="w-full flex items-center justify-between p-3 bg-blue-50 rounded-xl text-left hover:bg-blue-100 transition-colors"
                  >
                    <div className="flex items-center gap-3">
                      <ExternalLink className="w-5 h-5 text-blue-600" />
                      <div>
                        <p className="font-medium text-gray-900">Abrir Mercado Livre</p>
                        <p className="text-xs text-gray-500">Ir para o painel de vendas</p>
                      </div>
                    </div>
                    <ChevronRight className="w-5 h-5 text-gray-400" />
                  </a>
                </div>
              </Card>

              {/* Últimas Vendas */}
              {vendas.length > 0 && (
                <Card className="p-4">
                  <div className="flex items-center justify-between mb-3">
                    <h3 className="text-sm font-semibold text-gray-900">🛒 Últimas Vendas</h3>
                    <button 
                      onClick={() => setActiveTab('vendas')}
                      className="text-xs text-yellow-600 font-medium"
                    >
                      Ver todas
                    </button>
                  </div>
                  <div className="space-y-3">
                    {vendas.slice(0, 3).map((venda) => (
                      <div key={venda.id} className="flex items-center gap-3 p-2 bg-gray-50 rounded-lg">
                        <div className={cn(
                          "w-8 h-8 rounded-full flex items-center justify-center",
                          venda.status === 'paid' ? "bg-green-100" : "bg-yellow-100"
                        )}>
                          {venda.status === 'paid' ? (
                            <CheckCircle className="w-4 h-4 text-green-600" />
                          ) : (
                            <Clock className="w-4 h-4 text-yellow-600" />
                          )}
                        </div>
                        <div className="flex-1 min-w-0">
                          <p className="text-sm font-medium text-gray-900 truncate">
                            {venda.order_items[0]?.item.title || 'Venda'}
                          </p>
                          <p className="text-xs text-gray-500">
                            {venda.buyer.nickname} • {new Date(venda.date_created).toLocaleDateString('pt-BR')}
                          </p>
                        </div>
                        <span className="text-sm font-bold text-green-600">
                          {formatarMoeda(venda.total_amount)}
                        </span>
                      </div>
                    ))}
                  </div>
                </Card>
              )}
            </motion.div>
          )}

          {activeTab === 'anuncios' && (
            <motion.div
              key="anuncios"
              initial={{ opacity: 0, y: 10 }}
              animate={{ opacity: 1, y: 0 }}
              exit={{ opacity: 0, y: -10 }}
              className="space-y-3"
            >
              <div className="flex items-center justify-between">
                <p className="text-sm text-gray-500">{anuncios.length} anúncios</p>
                <Button size="sm" onClick={sincronizarEstoque} disabled={isRefreshing}>
                  <RefreshCw className={cn("w-4 h-4 mr-1", isRefreshing && "animate-spin")} />
                  Sincronizar
                </Button>
              </div>

              {anuncios.map((anuncio) => (
                <Card key={anuncio.id} className="p-3">
                  <div className="flex gap-3">
                    {anuncio.thumbnail && (
                      <img
                        src={anuncio.thumbnail.replace('http://', 'https://')}
                        alt={anuncio.title}
                        className="w-16 h-16 rounded-lg object-cover"
                      />
                    )}
                    <div className="flex-1 min-w-0">
                      <div className="flex items-start justify-between gap-2">
                        <p className="text-sm font-medium text-gray-900 line-clamp-2">
                          {anuncio.title}
                        </p>
                        <span className={cn(
                          "text-xs px-2 py-0.5 rounded-full whitespace-nowrap",
                          anuncio.status === 'active' 
                            ? "bg-green-100 text-green-700"
                            : "bg-gray-100 text-gray-600"
                        )}>
                          {anuncio.status === 'active' ? 'Ativo' : anuncio.status}
                        </span>
                      </div>
                      <p className="text-lg font-bold text-gray-900 mt-1">
                        {formatarMoeda(anuncio.price)}
                      </p>
                      <div className="flex items-center gap-3 mt-1 text-xs text-gray-500">
                        <span className="flex items-center gap-1">
                          <Package className="w-3 h-3" />
                          {anuncio.available_quantity} disp.
                        </span>
                        <span className="flex items-center gap-1">
                          <ShoppingCart className="w-3 h-3" />
                          {anuncio.sold_quantity} vendidos
                        </span>
                      </div>
                    </div>
                  </div>
                  <a
                    href={anuncio.permalink}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="mt-2 flex items-center justify-center gap-1 text-xs text-yellow-600 font-medium py-2 bg-yellow-50 rounded-lg"
                  >
                    <ExternalLink className="w-3 h-3" />
                    Ver no Mercado Livre
                  </a>
                </Card>
              ))}

              {anuncios.length === 0 && (
                <Card className="p-8 text-center">
                  <Package className="w-12 h-12 text-gray-300 mx-auto mb-3" />
                  <p className="text-gray-500">Nenhum anúncio encontrado</p>
                </Card>
              )}
            </motion.div>
          )}

          {activeTab === 'vendas' && (
            <motion.div
              key="vendas"
              initial={{ opacity: 0, y: 10 }}
              animate={{ opacity: 1, y: 0 }}
              exit={{ opacity: 0, y: -10 }}
              className="space-y-3"
            >
              <p className="text-sm text-gray-500">{vendas.length} vendas recentes</p>

              {vendas.map((venda) => (
                <Card key={venda.id} className="p-4">
                  <div className="flex items-start justify-between mb-2">
                    <div className="flex items-center gap-2">
                      <div className={cn(
                        "w-8 h-8 rounded-full flex items-center justify-center",
                        venda.status === 'paid' ? "bg-green-100" : 
                        venda.status === 'cancelled' ? "bg-red-100" : "bg-yellow-100"
                      )}>
                        {venda.status === 'paid' ? (
                          <CheckCircle className="w-4 h-4 text-green-600" />
                        ) : venda.status === 'cancelled' ? (
                          <XCircle className="w-4 h-4 text-red-600" />
                        ) : (
                          <Clock className="w-4 h-4 text-yellow-600" />
                        )}
                      </div>
                      <div>
                        <p className="text-sm font-medium text-gray-900">
                          Venda #{venda.id}
                        </p>
                        <p className="text-xs text-gray-500">
                          {new Date(venda.date_created).toLocaleString('pt-BR')}
                        </p>
                      </div>
                    </div>
                    <span className="text-lg font-bold text-green-600">
                      {formatarMoeda(venda.total_amount)}
                    </span>
                  </div>
                  
                  <div className="border-t pt-2 mt-2">
                    {venda.order_items.map((item, idx) => (
                      <div key={idx} className="flex justify-between text-sm py-1">
                        <span className="text-gray-600 truncate flex-1">
                          {item.quantity}x {item.item.title}
                        </span>
                        <span className="text-gray-900 font-medium ml-2">
                          {formatarMoeda(item.unit_price * item.quantity)}
                        </span>
                      </div>
                    ))}
                  </div>
                  
                  <div className="flex items-center gap-2 mt-2 pt-2 border-t">
                    <Users className="w-4 h-4 text-gray-400" />
                    <span className="text-xs text-gray-500">
                      Comprador: {venda.buyer.nickname}
                    </span>
                  </div>
                </Card>
              ))}

              {vendas.length === 0 && (
                <Card className="p-8 text-center">
                  <ShoppingCart className="w-12 h-12 text-gray-300 mx-auto mb-3" />
                  <p className="text-gray-500">Nenhuma venda encontrada</p>
                </Card>
              )}
            </motion.div>
          )}

          {activeTab === 'perguntas' && (
            <motion.div
              key="perguntas"
              initial={{ opacity: 0, y: 10 }}
              animate={{ opacity: 1, y: 0 }}
              exit={{ opacity: 0, y: -10 }}
              className="space-y-3"
            >
              <p className="text-sm text-gray-500">
                {resumo.perguntasPendentes} perguntas pendentes
              </p>

              {perguntas.map((pergunta) => (
                <Card key={pergunta.id} className="p-4">
                  <div className="flex items-start gap-3">
                    <div className={cn(
                      "w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0",
                      pergunta.status === 'UNANSWERED' ? "bg-orange-100" : "bg-green-100"
                    )}>
                      {pergunta.status === 'UNANSWERED' ? (
                        <HelpCircle className="w-4 h-4 text-orange-600" />
                      ) : (
                        <CheckCircle className="w-4 h-4 text-green-600" />
                      )}
                    </div>
                    <div className="flex-1">
                      <p className="text-sm text-gray-900">{pergunta.text}</p>
                      <p className="text-xs text-gray-500 mt-1">
                        {new Date(pergunta.date_created).toLocaleString('pt-BR')}
                      </p>
                    </div>
                  </div>
                  {pergunta.status === 'UNANSWERED' && (
                    <a
                      href={`https://www.mercadolivre.com.br/perguntas/produto/${pergunta.item_id}`}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="mt-3 flex items-center justify-center gap-1 text-xs text-yellow-600 font-medium py-2 bg-yellow-50 rounded-lg"
                    >
                      <MessageCircle className="w-3 h-3" />
                      Responder no ML
                    </a>
                  )}
                </Card>
              ))}

              {perguntas.length === 0 && (
                <Card className="p-8 text-center">
                  <HelpCircle className="w-12 h-12 text-gray-300 mx-auto mb-3" />
                  <p className="text-gray-500">Nenhuma pergunta</p>
                </Card>
              )}
            </motion.div>
          )}
        </AnimatePresence>
      </div>
    </div>
  );
}
</file>

<file path="src/app/(app)/vendas/page.tsx">
'use client';

import { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { 
  ShoppingCart, 
  TrendingUp, 
  Calendar,
  ChevronDown,
  Package
} from 'lucide-react';
import { Card } from '@/components/ui';
import { formatarMoeda } from '@/lib/utils/calculos';
import { getSupabaseClient } from '@/lib/supabase/client';

interface Venda {
  id: string;
  produto_nome: string;
  qtd_vendida: number;
  valor_final: number;
  lucro_liquido: number;
  data_venda: string;
  taxa_tipo: string;
}

interface VendaAgrupada {
  data: string;
  dataFormatada: string;
  vendas: Venda[];
  totalFaturamento: number;
  totalLucro: number;
}

type PeriodoTipo = 'hoje' | 'semana' | 'mes' | 'personalizado';

export default function VendasPage() {
  const [periodo, setPeriodo] = useState<PeriodoTipo>('mes');
  const [dataInicio, setDataInicio] = useState(() => {
    const d = new Date();
    d.setMonth(d.getMonth() - 1);
    return d.toISOString().split('T')[0];
  });
  const [dataFim, setDataFim] = useState(() => {
    return new Date().toISOString().split('T')[0];
  });
  const [showDatePicker, setShowDatePicker] = useState(false);
  
  const [vendas, setVendas] = useState<Venda[]>([]);
  const [vendasAgrupadas, setVendasAgrupadas] = useState<VendaAgrupada[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [resumo, setResumo] = useState({
    totalVendas: 0,
    faturamento: 0,
    lucro: 0,
  });

  useEffect(() => {
    carregarVendas();
  }, [periodo, dataInicio, dataFim]);

  useEffect(() => {
    agruparVendas();
  }, [vendas]);

  const getDateRange = () => {
    const agora = new Date();
    let inicio: Date;
    let fim = new Date();
    fim.setHours(23, 59, 59, 999);

    switch (periodo) {
      case 'hoje':
        inicio = new Date();
        inicio.setHours(0, 0, 0, 0);
        break;
      case 'semana':
        inicio = new Date();
        inicio.setDate(agora.getDate() - 7);
        inicio.setHours(0, 0, 0, 0);
        break;
      case 'mes':
        inicio = new Date(agora.getFullYear(), agora.getMonth(), 1);
        break;
      case 'personalizado':
        inicio = new Date(dataInicio);
        inicio.setHours(0, 0, 0, 0);
        fim = new Date(dataFim);
        fim.setHours(23, 59, 59, 999);
        break;
      default:
        inicio = new Date();
        inicio.setHours(0, 0, 0, 0);
    }

    return { inicio, fim };
  };

  const carregarVendas = async () => {
    setIsLoading(true);
    try {
      const supabase = getSupabaseClient();
      const { inicio, fim } = getDateRange();

      const { data, error } = await supabase
        .from('vendas')
        .select('*')
        .gte('data_venda', inicio.toISOString())
        .lte('data_venda', fim.toISOString())
        .order('data_venda', { ascending: false });

      if (error) throw error;

      setVendas(data || []);

      // Calcular resumo
      if (data && data.length > 0) {
        setResumo({
          totalVendas: data.length,
          faturamento: data.reduce((acc: number, v: any) => acc + Number(v.valor_final), 0),
          lucro: data.reduce((acc: number, v: any) => acc + Number(v.lucro_liquido), 0),
        });
      } else {
        setResumo({ totalVendas: 0, faturamento: 0, lucro: 0 });
      }
    } catch (error) {
      console.error('Erro ao carregar vendas:', error);
    } finally {
      setIsLoading(false);
    }
  };

  const agruparVendas = () => {
    const grupos: Record<string, Venda[]> = {};

    vendas.forEach((venda) => {
      const data = new Date(venda.data_venda).toDateString();
      if (!grupos[data]) {
        grupos[data] = [];
      }
      grupos[data].push(venda);
    });

    const agrupadas: VendaAgrupada[] = Object.entries(grupos).map(([data, vendas]) => ({
      data,
      dataFormatada: new Date(data).toLocaleDateString('pt-BR', {
        weekday: 'long',
        day: '2-digit',
        month: 'long',
      }),
      vendas,
      totalFaturamento: vendas.reduce((acc, v) => acc + Number(v.valor_final), 0),
      totalLucro: vendas.reduce((acc, v) => acc + Number(v.lucro_liquido), 0),
    }));

    setVendasAgrupadas(agrupadas);
  };

  const getPeriodoLabel = () => {
    switch (periodo) {
      case 'hoje': return 'Hoje';
      case 'semana': return 'Últimos 7 dias';
      case 'mes': return 'Este mês';
      case 'personalizado': 
        return `${new Date(dataInicio).toLocaleDateString('pt-BR')} - ${new Date(dataFim).toLocaleDateString('pt-BR')}`;
    }
  };

  return (
    <div className="min-h-screen bg-gray-50 pt-safe pb-24">
      {/* Header */}
      <div className="bg-white px-4 pt-6 pb-4 border-b border-gray-100">
        <h1 className="text-2xl font-bold text-gray-900">Vendas</h1>
        <p className="text-sm text-gray-500 mt-0.5">
          Histórico de vendas realizadas
        </p>
      </div>

      {/* Filtros de Período */}
      <div className="px-4 py-4 bg-white border-b border-gray-100">
        <div className="flex gap-2 flex-wrap">
          {['hoje', 'semana', 'mes'].map((p) => (
            <button
              key={p}
              onClick={() => {
                setPeriodo(p as PeriodoTipo);
                setShowDatePicker(false);
              }}
              className={`px-4 py-2 rounded-full text-sm font-medium transition-all ${
                periodo === p
                  ? 'bg-primary-600 text-white'
                  : 'bg-gray-100 text-gray-600'
              }`}
            >
              {p === 'hoje' ? 'Hoje' : p === 'semana' ? 'Semana' : 'Mês'}
            </button>
          ))}
          <button
            onClick={() => {
              setPeriodo('personalizado');
              setShowDatePicker(!showDatePicker);
            }}
            className={`px-4 py-2 rounded-full text-sm font-medium transition-all flex items-center gap-1 ${
              periodo === 'personalizado'
                ? 'bg-primary-600 text-white'
                : 'bg-gray-100 text-gray-600'
            }`}
          >
            <Calendar className="w-4 h-4" />
            Período
            <ChevronDown className="w-4 h-4" />
          </button>
        </div>

        {/* Date Picker */}
        <AnimatePresence>
          {showDatePicker && (
            <motion.div
              initial={{ opacity: 0, height: 0 }}
              animate={{ opacity: 1, height: 'auto' }}
              exit={{ opacity: 0, height: 0 }}
              className="mt-4 bg-gray-50 rounded-xl p-4"
            >
              <div className="flex gap-4">
                <div className="flex-1">
                  <label className="block text-xs text-gray-500 mb-1">De</label>
                  <input
                    type="date"
                    value={dataInicio}
                    onChange={(e) => setDataInicio(e.target.value)}
                    className="w-full px-3 py-2 rounded-lg border border-gray-200 text-sm"
                  />
                </div>
                <div className="flex-1">
                  <label className="block text-xs text-gray-500 mb-1">Até</label>
                  <input
                    type="date"
                    value={dataFim}
                    onChange={(e) => setDataFim(e.target.value)}
                    className="w-full px-3 py-2 rounded-lg border border-gray-200 text-sm"
                  />
                </div>
              </div>
              <button
                onClick={() => setShowDatePicker(false)}
                className="mt-3 w-full py-2 bg-primary-600 text-white rounded-lg font-medium text-sm"
              >
                Aplicar Filtro
              </button>
            </motion.div>
          )}
        </AnimatePresence>
      </div>

      {/* Resumo */}
      <div className="px-4 py-4">
        <div className="grid grid-cols-3 gap-3">
          <Card className="p-3 text-center">
            <ShoppingCart className="w-5 h-5 text-purple-600 mx-auto mb-1" />
            <p className="text-lg font-bold text-gray-900">{resumo.totalVendas}</p>
            <p className="text-xs text-gray-500">Vendas</p>
          </Card>
          <Card className="p-3 text-center">
            <Package className="w-5 h-5 text-blue-600 mx-auto mb-1" />
            <p className="text-lg font-bold text-gray-900">{formatarMoeda(resumo.faturamento)}</p>
            <p className="text-xs text-gray-500">Faturamento</p>
          </Card>
          <Card className="p-3 text-center">
            <TrendingUp className="w-5 h-5 text-green-600 mx-auto mb-1" />
            <p className={`text-lg font-bold ${resumo.lucro >= 0 ? 'text-green-600' : 'text-red-600'}`}>
              {formatarMoeda(resumo.lucro)}
            </p>
            <p className="text-xs text-gray-500">Lucro</p>
          </Card>
        </div>
      </div>

      {/* Lista de Vendas Agrupadas */}
      <div className="px-4 space-y-4">
        {isLoading ? (
          <div className="flex items-center justify-center py-12">
            <div className="w-8 h-8 border-4 border-primary-600 border-t-transparent rounded-full animate-spin" />
          </div>
        ) : vendasAgrupadas.length === 0 ? (
          <Card className="p-8 text-center">
            <ShoppingCart className="w-12 h-12 text-gray-300 mx-auto mb-4" />
            <h3 className="text-gray-500 font-medium">Nenhuma venda encontrada</h3>
            <p className="text-sm text-gray-400 mt-1">
              {getPeriodoLabel()}
            </p>
          </Card>
        ) : (
          vendasAgrupadas.map((grupo) => (
            <motion.div
              key={grupo.data}
              initial={{ opacity: 0, y: 10 }}
              animate={{ opacity: 1, y: 0 }}
            >
              {/* Data Header */}
              <div className="flex items-center justify-between mb-2">
                <h3 className="text-sm font-medium text-gray-500 capitalize">
                  {grupo.dataFormatada}
                </h3>
                <div className="flex items-center gap-3 text-xs">
                  <span className="text-gray-400">
                    {grupo.vendas.length} venda{grupo.vendas.length > 1 ? 's' : ''}
                  </span>
                  <span className={`font-medium ${grupo.totalLucro >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                    {formatarMoeda(grupo.totalLucro)}
                  </span>
                </div>
              </div>

              {/* Vendas do dia */}
              <Card className="divide-y divide-gray-100">
                {grupo.vendas.map((venda) => (
                  <div key={venda.id} className="p-4 flex items-center justify-between">
                    <div className="flex-1">
                      <h4 className="font-medium text-gray-900">{venda.produto_nome}</h4>
                      <div className="flex items-center gap-2 mt-1">
                        <span className="text-xs text-gray-500">
                          {venda.qtd_vendida}x {formatarMoeda(venda.valor_final / venda.qtd_vendida)}
                        </span>
                        <span className={`text-xs px-2 py-0.5 rounded-full ${
                          venda.taxa_tipo === 'premium' 
                            ? 'bg-purple-100 text-purple-700'
                            : 'bg-blue-100 text-blue-700'
                        }`}>
                          {venda.taxa_tipo === 'premium' ? 'Premium' : 'Clássico'}
                        </span>
                      </div>
                    </div>
                    <div className="text-right">
                      <p className="font-medium text-gray-900">
                        {formatarMoeda(venda.valor_final)}
                      </p>
                      <p className={`text-sm ${venda.lucro_liquido >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                        {venda.lucro_liquido >= 0 ? '+' : ''}{formatarMoeda(venda.lucro_liquido)}
                      </p>
                    </div>
                  </div>
                ))}
              </Card>
            </motion.div>
          ))
        )}
      </div>
    </div>
  );
}
</file>

<file path="src/app/api/ml-webhook/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@supabase/supabase-js';

// Cliente Supabase com service role para operações administrativas
const supabaseAdmin = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
);

// Tipos para notificações do Mercado Livre
interface MLNotification {
  resource: string;
  user_id: string;
  topic: string;
  application_id: number;
  attempts: number;
  sent: string;
  received: string;
}

interface MLOrder {
  id: number;
  status: string;
  status_detail: string | null;
  date_created: string;
  date_closed: string;
  order_items: MLOrderItem[];
  total_amount: number;
  currency_id: string;
  buyer: {
    id: number;
    nickname: string;
  };
  payments: MLPayment[];
}

interface MLOrderItem {
  item: {
    id: string;
    title: string;
    variation_id: number | null;
  };
  quantity: number;
  unit_price: number;
  full_unit_price: number;
  currency_id: string;
}

interface MLPayment {
  id: number;
  status: string;
  status_detail: string;
  payment_type: string;
  total_paid_amount: number;
}

/**
 * Busca detalhes de um pedido no Mercado Livre
 */
async function fetchOrderDetails(
  orderId: string,
  accessToken: string
): Promise<MLOrder | null> {
  try {
    const response = await fetch(
      `https://api.mercadolibre.com/orders/${orderId}`,
      {
        headers: {
          Authorization: `Bearer ${accessToken}`,
        },
      }
    );

    if (!response.ok) {
      console.error('Erro ao buscar pedido ML:', response.status);
      return null;
    }

    return response.json();
  } catch (error) {
    console.error('Erro ao buscar pedido ML:', error);
    return null;
  }
}

/**
 * Processa uma ordem aprovada do Mercado Livre
 */
async function processOrder(order: MLOrder, userId: string) {
  for (const item of order.order_items) {
    const mlItemId = item.item.id;

    // Buscar produto pelo ml_id
    const { data: produto, error: produtoError } = await supabaseAdmin
      .from('produtos')
      .select('*')
      .eq('ml_id', mlItemId)
      .eq('user_id', userId)
      .single();

    if (produtoError || !produto) {
      console.log(`Produto não encontrado para ML ID: ${mlItemId}`);
      continue;
    }

    // Buscar configurações do usuário para taxas
    const { data: config } = await supabaseAdmin
      .from('configuracoes')
      .select('*')
      .eq('user_id', userId)
      .single();

    const taxaPercentual = produto.taxa_tipo === 'premium' 
      ? (config?.taxa_premium || 16)
      : (config?.taxa_classico || 11);

    const valorFinal = item.unit_price * item.quantity;
    const valorTaxaPercentual = (valorFinal * taxaPercentual) / 100;
    const taxaFixa = valorFinal < (config?.taxa_fixa_limite || 79) 
      ? (config?.taxa_fixa_valor || 6) 
      : 0;
    const custoTotal = produto.valor_pago * item.quantity;
    const lucroLiquido = valorFinal - custoTotal - valorTaxaPercentual - taxaFixa;

    // Verificar se a venda já foi registrada
    const { data: vendaExistente } = await supabaseAdmin
      .from('vendas')
      .select('id')
      .eq('ml_order_id', order.id.toString())
      .eq('produto_id', produto.id)
      .single();

    if (vendaExistente) {
      console.log(`Venda já registrada para order ${order.id}, item ${mlItemId}`);
      continue;
    }

    // Registrar a venda
    const { error: vendaError } = await supabaseAdmin
      .from('vendas')
      .insert({
        user_id: userId,
        produto_id: produto.id,
        produto_nome: produto.nome,
        qtd_vendida: item.quantity,
        valor_unitario: item.unit_price,
        valor_final: valorFinal,
        custo_unitario: produto.valor_pago,
        taxa_tipo: produto.taxa_tipo,
        taxa_percentual: taxaPercentual,
        taxa_fixa: taxaFixa,
        lucro_liquido: lucroLiquido,
        ml_order_id: order.id.toString(),
        origem: 'mercadolivre',
        data_venda: order.date_created,
      });

    if (vendaError) {
      console.error('Erro ao registrar venda:', vendaError);
      continue;
    }

    console.log(`Venda registrada: ${produto.nome} x${item.quantity} - Lucro: ${lucroLiquido}`);

    // TODO: Enviar notificação push para o usuário
    // Implementar com web push ou serviço de notificação
  }
}

/**
 * Webhook handler para notificações do Mercado Livre
 * Endpoint: POST /api/ml-webhook
 */
export async function POST(request: NextRequest) {
  try {
    const notification: MLNotification = await request.json();
    
    console.log('Webhook ML recebido:', notification);

    // Verificar se é uma notificação de pedido
    if (notification.topic !== 'orders_v2' && notification.topic !== 'orders') {
      return NextResponse.json({ 
        received: true, 
        processed: false, 
        reason: 'Not an order notification' 
      });
    }

    // Extrair o ID do pedido do resource
    // Formato: /orders/ORDER_ID
    const resourceMatch = notification.resource.match(/\/orders\/(\d+)/);
    if (!resourceMatch) {
      return NextResponse.json({ 
        received: true, 
        processed: false, 
        reason: 'Invalid resource format' 
      });
    }

    const orderId = resourceMatch[1];
    const mlUserId = notification.user_id;

    // Buscar configurações do usuário pelo ml_user_id
    const { data: config, error: configError } = await supabaseAdmin
      .from('configuracoes')
      .select('*')
      .eq('ml_user_id', mlUserId)
      .single();

    if (configError || !config || !config.ml_access_token) {
      console.error('Configuração não encontrada para ML user:', mlUserId);
      return NextResponse.json({ 
        received: true, 
        processed: false, 
        reason: 'User configuration not found' 
      });
    }

    // TODO: Implementar refresh token se expirado
    // Verificar config.ml_token_expires_at

    // Buscar detalhes do pedido
    const order = await fetchOrderDetails(orderId, config.ml_access_token);

    if (!order) {
      return NextResponse.json({ 
        received: true, 
        processed: false, 
        reason: 'Could not fetch order details' 
      });
    }

    // Processar apenas pedidos pagos/aprovados
    if (order.status !== 'paid') {
      console.log(`Pedido ${orderId} não está pago. Status: ${order.status}`);
      return NextResponse.json({ 
        received: true, 
        processed: false, 
        reason: `Order status: ${order.status}` 
      });
    }

    // Processar a ordem
    await processOrder(order, config.user_id);

    return NextResponse.json({ 
      received: true, 
      processed: true,
      orderId: orderId
    });

  } catch (error) {
    console.error('Erro no webhook ML:', error);
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    );
  }
}

/**
 * GET handler para validação do webhook pelo Mercado Livre
 */
export async function GET(request: NextRequest) {
  // O ML faz um GET para validar o endpoint
  return NextResponse.json({ status: 'ok' });
}
</file>

<file path="src/app/page.tsx">
import { redirect } from 'next/navigation';
import { createServerSupabaseClient } from '@/lib/supabase/server';

export default async function Home() {
  const supabase = await createServerSupabaseClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (user) {
    redirect('/dashboard');
  } else {
    redirect('/login');
  }
}
</file>

<file path="src/components/navigation/TabBar.tsx">
'use client';

import { usePathname } from 'next/navigation';
import Link from 'next/link';
import { motion } from 'framer-motion';
import { 
  LayoutDashboard, 
  Package, 
  ShoppingCart, 
  Settings,
  Store
} from 'lucide-react';

const tabs = [
  { href: '/dashboard', icon: LayoutDashboard, label: 'Dashboard' },
  { href: '/estoque', icon: Package, label: 'Estoque' },
  { href: '/mercadolivre', icon: Store, label: 'ML' },
  { href: '/vendas', icon: ShoppingCart, label: 'Vendas' },
  { href: '/ajustes', icon: Settings, label: 'Ajustes' },
];

export default function TabBar() {
  const pathname = usePathname();

  return (
    <nav className="fixed bottom-0 left-0 right-0 z-50">
      {/* Glassmorphism background */}
      <div className="glass border-t border-gray-200/50">
        <div className="flex items-center justify-around px-2 pb-[env(safe-area-inset-bottom)]">
          {tabs.map((tab) => {
            const isActive = pathname === tab.href || pathname?.startsWith(`${tab.href}/`);
            const Icon = tab.icon;

            return (
              <Link
                key={tab.href}
                href={tab.href}
                className="relative flex flex-col items-center justify-center py-2 px-4 min-w-[64px] press-effect"
              >
                <motion.div
                  className="relative"
                  whileTap={{ scale: 0.9 }}
                  transition={{ type: 'spring', stiffness: 400, damping: 17 }}
                >
                  {isActive && (
                    <motion.div
                      layoutId="activeTab"
                      className="absolute -inset-2 bg-primary-100 rounded-xl"
                      transition={{ type: 'spring', stiffness: 500, damping: 30 }}
                    />
                  )}
                  <Icon
                    className={`relative w-6 h-6 transition-colors ${
                      isActive ? 'text-primary-600' : 'text-gray-400'
                    }`}
                  />
                </motion.div>
                <span
                  className={`mt-1 text-[10px] font-medium transition-colors ${
                    isActive ? 'text-primary-600' : 'text-gray-400'
                  }`}
                >
                  {tab.label}
                </span>
              </Link>
            );
          })}
        </div>
      </div>
    </nav>
  );
}
</file>

<file path="src/lib/supabase/client.ts">
import { createBrowserClient } from '@supabase/ssr';

export function createClient() {
  return createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  );
}

// Cliente singleton para uso no lado do cliente
let client: ReturnType<typeof createClient> | null = null;

export function getSupabaseClient() {
  if (!client) {
    client = createClient();
  }
  return client;
}
</file>

<file path="src/lib/supabase/server.ts">
import { createServerClient, type CookieOptions } from '@supabase/ssr';
import { cookies } from 'next/headers';

export async function createServerSupabaseClient() {
  const cookieStore = await cookies();

  return createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) {
          return cookieStore.get(name)?.value;
        },
        set(name: string, value: string, options: CookieOptions) {
          try {
            cookieStore.set({ name, value, ...options });
          } catch (error) {
            // Handle cookie setting in server components
          }
        },
        remove(name: string, options: CookieOptions) {
          try {
            cookieStore.set({ name, value: '', ...options });
          } catch (error) {
            // Handle cookie removal in server components
          }
        },
      },
    }
  );
}
</file>

<file path="src/types/database.ts">
// Tipos do banco de dados Supabase

export type TaxaTipo = 'classico' | 'premium';
export type OrigemVenda = 'manual' | 'mercadolivre';

export interface Produto {
  id: string;
  user_id: string;
  nome: string;
  descricao?: string;
  foto_url?: string;
  quantidade: number;
  valor_pago: number;
  valor_venda: number;
  taxa_tipo: TaxaTipo;
  ml_id?: string;
  ativo: boolean;
  created_at: string;
  updated_at: string;
}

export interface ProdutoInsert {
  nome: string;
  descricao?: string;
  foto_url?: string;
  quantidade: number;
  valor_pago: number;
  valor_venda: number;
  taxa_tipo?: TaxaTipo;
  ml_id?: string;
}

export interface ProdutoUpdate {
  nome?: string;
  descricao?: string;
  foto_url?: string;
  quantidade?: number;
  valor_pago?: number;
  valor_venda?: number;
  taxa_tipo?: TaxaTipo;
  ml_id?: string;
  ativo?: boolean;
}

export interface Venda {
  id: string;
  user_id: string;
  produto_id?: string;
  produto_nome: string;
  qtd_vendida: number;
  valor_unitario: number;
  valor_final: number;
  custo_unitario: number;
  taxa_tipo: TaxaTipo;
  taxa_percentual: number;
  taxa_fixa: number;
  lucro_liquido: number;
  ml_order_id?: string;
  origem: OrigemVenda;
  data_venda: string;
}

export interface VendaInsert {
  produto_id?: string;
  produto_nome: string;
  qtd_vendida: number;
  valor_unitario: number;
  valor_final: number;
  custo_unitario: number;
  taxa_tipo: TaxaTipo;
  taxa_percentual: number;
  taxa_fixa?: number;
  lucro_liquido: number;
  ml_order_id?: string;
  origem?: OrigemVenda;
}

export interface Configuracoes {
  id: string;
  user_id: string;
  taxa_classico: number;
  taxa_premium: number;
  taxa_fixa_limite: number;
  taxa_fixa_valor: number;
  meta_diaria: number;
  meta_mensal: number;
  ml_access_token?: string;
  ml_refresh_token?: string;
  ml_user_id?: string;
  ml_token_expires_at?: string;
  notificacoes_ativas: boolean;
  created_at: string;
  updated_at: string;
}

export interface ConfiguracoesUpdate {
  taxa_classico?: number;
  taxa_premium?: number;
  taxa_fixa_limite?: number;
  taxa_fixa_valor?: number;
  meta_diaria?: number;
  meta_mensal?: number;
  ml_access_token?: string;
  ml_refresh_token?: string;
  ml_user_id?: string;
  ml_token_expires_at?: string;
  notificacoes_ativas?: boolean;
}

// Tipos para Dashboard
export interface DashboardResumo {
  faturamento: number;
  gastoEstoque: number;
  totalTaxas: number;
  lucroLiquido: number;
  totalVendas: number;
  ticketMedio: number;
}

export interface DashboardSemanal {
  dia: string;
  faturamento: number;
  lucro: number;
  vendas: number;
}

// Tipos para cálculo de lucro
export interface CalculoLucro {
  valorVenda: number;
  valorPago: number;
  taxaTipo: TaxaTipo;
  taxaPercentual: number;
  taxaFixa: number;
  lucroUnitario: number;
  margemPercentual: number;
}

// Database types para Supabase
export type Database = {
  public: {
    Tables: {
      produtos: {
        Row: Produto;
        Insert: Partial<Produto>;
        Update: Partial<Produto>;
      };
      vendas: {
        Row: Venda;
        Insert: Partial<Venda>;
        Update: Partial<Venda>;
      };
      configuracoes: {
        Row: Configuracoes;
        Insert: Partial<Configuracoes>;
        Update: Partial<Configuracoes>;
      };
    };
    Views: {};
    Functions: {};
    Enums: {};
  };
};
</file>

<file path="src/app/(app)/dashboard/page.tsx">
'use client';

import { useState, useEffect } from 'react';
import { motion } from 'framer-motion';
import { 
  TrendingUp, 
  TrendingDown,
  DollarSign, 
  Package, 
  ShoppingCart,
  Target,
  Calendar,
  ChevronDown,
  Wallet,
  PiggyBank,
  BarChart3,
  Percent,
  ArrowUpRight,
  ArrowDownRight,
  Box
} from 'lucide-react';
import { 
  BarChart, 
  Bar, 
  XAxis, 
  YAxis, 
  ResponsiveContainer,
  Tooltip,
  PieChart,
  Pie,
  Cell
} from 'recharts';
import { Card } from '@/components/ui';
import { formatarMoeda, calcularLucroUnitario } from '@/lib/utils/calculos';
import { getSupabaseClient } from '@/lib/supabase/client';

interface DashboardResumo {
  faturamento: number;
  gastoEstoque: number;
  totalTaxas: number;
  lucroLiquido: number;
  totalVendas: number;
  ticketMedio: number;
  quantidadeVendida: number;
}

interface EstoqueInfo {
  totalProdutos: number;
  totalItens: number;
  valorCusto: number;
  valorVenda: number;
  lucroEsperado: number;
  margemMedia: number;
}

interface DadoGrafico {
  label: string;
  faturamento: number;
  lucro: number;
  vendas: number;
}

interface ProdutoTop {
  nome: string;
  vendas: number;
  lucro: number;
}

type PeriodoTipo = 'hoje' | 'semana' | 'mes' | 'personalizado';

const COLORS = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6'];

export default function DashboardPage() {
  const [periodo, setPeriodo] = useState<PeriodoTipo>('mes');
  const [dataInicio, setDataInicio] = useState(() => {
    const d = new Date();
    d.setMonth(d.getMonth() - 1);
    return d.toISOString().split('T')[0];
  });
  const [dataFim, setDataFim] = useState(() => {
    return new Date().toISOString().split('T')[0];
  });
  const [showDatePicker, setShowDatePicker] = useState(false);
  
  const [resumo, setResumo] = useState<DashboardResumo>({
    faturamento: 0,
    gastoEstoque: 0,
    totalTaxas: 0,
    lucroLiquido: 0,
    totalVendas: 0,
    ticketMedio: 0,
    quantidadeVendida: 0,
  });

  const [estoque, setEstoque] = useState<EstoqueInfo>({
    totalProdutos: 0,
    totalItens: 0,
    valorCusto: 0,
    valorVenda: 0,
    lucroEsperado: 0,
    margemMedia: 0,
  });

  const [produtosTop, setProdutosTop] = useState<ProdutoTop[]>([]);
  const [dadosGrafico, setDadosGrafico] = useState<DadoGrafico[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [metaDiaria, setMetaDiaria] = useState(100);
  const [metaMensal, setMetaMensal] = useState(3000);

  useEffect(() => {
    carregarTudo();
  }, [periodo, dataInicio, dataFim]);

  const carregarTudo = async () => {
    setIsLoading(true);
    await Promise.all([
      carregarDados(),
      carregarEstoque(),
      carregarMeta(),
      carregarProdutosTop(),
    ]);
    setIsLoading(false);
  };

  const getDateRange = () => {
    const agora = new Date();
    let inicio: Date;
    let fim = new Date();
    fim.setHours(23, 59, 59, 999);

    switch (periodo) {
      case 'hoje':
        inicio = new Date();
        inicio.setHours(0, 0, 0, 0);
        break;
      case 'semana':
        inicio = new Date();
        inicio.setDate(agora.getDate() - 7);
        inicio.setHours(0, 0, 0, 0);
        break;
      case 'mes':
        inicio = new Date(agora.getFullYear(), agora.getMonth(), 1);
        break;
      case 'personalizado':
        inicio = new Date(dataInicio);
        inicio.setHours(0, 0, 0, 0);
        fim = new Date(dataFim);
        fim.setHours(23, 59, 59, 999);
        break;
      default:
        inicio = new Date();
        inicio.setHours(0, 0, 0, 0);
    }

    return { inicio, fim };
  };

  const carregarMeta = async () => {
    try {
      const supabase = getSupabaseClient();
      const { data } = await supabase
        .from('configuracoes')
        .select('meta_diaria, meta_mensal')
        .single();
      
      if (data) {
        setMetaDiaria(Number(data.meta_diaria) || 100);
        setMetaMensal(Number(data.meta_mensal) || 3000);
      }
    } catch (error) {
      console.error('Erro ao carregar meta:', error);
    }
  };

  const carregarEstoque = async () => {
    try {
      const supabase = getSupabaseClient();
      const { data: produtos } = await supabase
        .from('produtos')
        .select('*')
        .eq('ativo', true);

      if (produtos && produtos.length > 0) {
        const totalProdutos = produtos.length;
        const totalItens = produtos.reduce((acc: number, p: any) => acc + p.quantidade, 0);
        const valorCusto = produtos.reduce((acc: number, p: any) => acc + (p.quantidade * Number(p.valor_pago)), 0);
        const valorVenda = produtos.reduce((acc: number, p: any) => acc + (p.quantidade * Number(p.valor_venda)), 0);
        
        // Calcular lucro esperado considerando taxas
        let lucroEsperadoTotal = 0;
        let somaMargens = 0;
        
        produtos.forEach((p: any) => {
          const calculo = calcularLucroUnitario(Number(p.valor_venda), Number(p.valor_pago), p.taxa_tipo);
          lucroEsperadoTotal += calculo.lucroUnitario * p.quantidade;
          somaMargens += calculo.margemPercentual;
        });

        const margemMedia = produtos.length > 0 ? somaMargens / produtos.length : 0;

        setEstoque({
          totalProdutos,
          totalItens,
          valorCusto,
          valorVenda,
          lucroEsperado: lucroEsperadoTotal,
          margemMedia,
        });
      }
    } catch (error) {
      console.error('Erro ao carregar estoque:', error);
    }
  };

  const carregarProdutosTop = async () => {
    try {
      const supabase = getSupabaseClient();
      const { inicio, fim } = getDateRange();
      
      const { data: vendas } = await supabase
        .from('vendas')
        .select('produto_nome, qtd_vendida, lucro_liquido')
        .gte('data_venda', inicio.toISOString())
        .lte('data_venda', fim.toISOString());

      if (vendas && vendas.length > 0) {
        // Agrupar por produto
        const grupos: Record<string, { vendas: number; lucro: number }> = {};
        vendas.forEach((v: any) => {
          if (!grupos[v.produto_nome]) {
            grupos[v.produto_nome] = { vendas: 0, lucro: 0 };
          }
          grupos[v.produto_nome].vendas += v.qtd_vendida;
          grupos[v.produto_nome].lucro += Number(v.lucro_liquido);
        });

        const top = Object.entries(grupos)
          .map(([nome, dados]) => ({ nome, ...dados }))
          .sort((a, b) => b.lucro - a.lucro)
          .slice(0, 5);

        setProdutosTop(top);
      } else {
        setProdutosTop([]);
      }
    } catch (error) {
      console.error('Erro ao carregar produtos top:', error);
    }
  };

  const carregarDados = async () => {
    try {
      const supabase = getSupabaseClient();
      const { inicio, fim } = getDateRange();

      const { data: vendasData, error } = await supabase
        .from('vendas')
        .select('*')
        .gte('data_venda', inicio.toISOString())
        .lte('data_venda', fim.toISOString())
        .order('data_venda', { ascending: true });

      if (error) throw error;

      const vendas = vendasData || [];

      if (vendas.length > 0) {
        const faturamento = vendas.reduce((acc: number, v: any) => acc + Number(v.valor_final), 0);
        const gastoEstoque = vendas.reduce((acc: number, v: any) => acc + (Number(v.custo_unitario) * v.qtd_vendida), 0);
        const totalTaxas = vendas.reduce((acc: number, v: any) => {
          const taxaPerc = (Number(v.taxa_percentual) / 100) * Number(v.valor_final);
          return acc + taxaPerc + Number(v.taxa_fixa || 0);
        }, 0);
        const lucroLiquido = vendas.reduce((acc: number, v: any) => acc + Number(v.lucro_liquido), 0);
        const quantidadeVendida = vendas.reduce((acc: number, v: any) => acc + v.qtd_vendida, 0);

        setResumo({
          faturamento,
          gastoEstoque,
          totalTaxas,
          lucroLiquido,
          totalVendas: vendas.length,
          ticketMedio: faturamento / vendas.length,
          quantidadeVendida,
        });

        // Agrupar por dia para gráfico
        const grupos: Record<string, { faturamento: number; lucro: number; vendas: number }> = {};
        vendas.forEach((v: any) => {
          const data = new Date(v.data_venda).toLocaleDateString('pt-BR', { 
            day: '2-digit', 
            month: '2-digit' 
          });
          if (!grupos[data]) {
            grupos[data] = { faturamento: 0, lucro: 0, vendas: 0 };
          }
          grupos[data].faturamento += Number(v.valor_final);
          grupos[data].lucro += Number(v.lucro_liquido);
          grupos[data].vendas += 1;
        });

        const dadosOrdenados = Object.entries(grupos).map(([label, dados]) => ({
          label,
          ...dados,
        }));
        setDadosGrafico(dadosOrdenados);
      } else {
        setResumo({
          faturamento: 0,
          gastoEstoque: 0,
          totalTaxas: 0,
          lucroLiquido: 0,
          totalVendas: 0,
          ticketMedio: 0,
          quantidadeVendida: 0,
        });
        setDadosGrafico([]);
      }
    } catch (error) {
      console.error('Erro ao carregar dados:', error);
    }
  };

  const getMeta = () => {
    if (periodo === 'hoje') return metaDiaria;
    if (periodo === 'mes') return metaMensal;
    if (periodo === 'semana') return metaDiaria * 7;
    return metaMensal;
  };

  const progressoMeta = getMeta() > 0 ? Math.min((resumo.lucroLiquido / getMeta()) * 100, 100) : 0;

  const getPeriodoLabel = () => {
    switch (periodo) {
      case 'hoje': return 'Hoje';
      case 'semana': return 'Últimos 7 dias';
      case 'mes': return 'Este mês';
      case 'personalizado': 
        return `${new Date(dataInicio).toLocaleDateString('pt-BR')} - ${new Date(dataFim).toLocaleDateString('pt-BR')}`;
    }
  };

  // ROI = (Lucro / Custo) * 100
  const roi = resumo.gastoEstoque > 0 ? ((resumo.lucroLiquido / resumo.gastoEstoque) * 100) : 0;

  return (
    <div className="min-h-screen bg-gray-50 pt-safe pb-24">
      {/* Header */}
      <div className="bg-gradient-to-br from-primary-600 to-primary-800 text-white px-4 pt-6 pb-16 rounded-b-3xl">
        <motion.div
          initial={{ opacity: 0, y: -10 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.3 }}
        >
          <h1 className="text-2xl font-bold">Dashboard</h1>
          <p className="text-primary-200 mt-1">Visão completa do seu negócio</p>
        </motion.div>

        {/* Seletor de Período */}
        <div className="mt-4 flex gap-2 flex-wrap">
          {['hoje', 'semana', 'mes'].map((p) => (
            <button
              key={p}
              onClick={() => {
                setPeriodo(p as PeriodoTipo);
                setShowDatePicker(false);
              }}
              className={`px-4 py-2 rounded-full text-sm font-medium transition-all ${
                periodo === p
                  ? 'bg-white text-primary-600'
                  : 'bg-white/20 text-white'
              }`}
            >
              {p === 'hoje' ? 'Hoje' : p === 'semana' ? 'Semana' : 'Mês'}
            </button>
          ))}
          <button
            onClick={() => {
              setPeriodo('personalizado');
              setShowDatePicker(!showDatePicker);
            }}
            className={`px-4 py-2 rounded-full text-sm font-medium transition-all flex items-center gap-1 ${
              periodo === 'personalizado'
                ? 'bg-white text-primary-600'
                : 'bg-white/20 text-white'
            }`}
          >
            <Calendar className="w-4 h-4" />
            Período
            <ChevronDown className="w-4 h-4" />
          </button>
        </div>

        {/* Date Picker */}
        {showDatePicker && (
          <motion.div
            initial={{ opacity: 0, height: 0 }}
            animate={{ opacity: 1, height: 'auto' }}
            className="mt-4 bg-white/10 backdrop-blur-sm rounded-xl p-4"
          >
            <div className="flex gap-4">
              <div className="flex-1">
                <label className="block text-xs text-primary-200 mb-1">De</label>
                <input
                  type="date"
                  value={dataInicio}
                  onChange={(e) => setDataInicio(e.target.value)}
                  className="w-full px-3 py-2 rounded-lg bg-white text-gray-900 text-sm"
                />
              </div>
              <div className="flex-1">
                <label className="block text-xs text-primary-200 mb-1">Até</label>
                <input
                  type="date"
                  value={dataFim}
                  onChange={(e) => setDataFim(e.target.value)}
                  className="w-full px-3 py-2 rounded-lg bg-white text-gray-900 text-sm"
                />
              </div>
            </div>
            <button
              onClick={() => setShowDatePicker(false)}
              className="mt-3 w-full py-2 bg-white text-primary-600 rounded-lg font-medium text-sm"
            >
              Aplicar Filtro
            </button>
          </motion.div>
        )}

        {/* Meta Progress */}
        <motion.div
          initial={{ opacity: 0, scale: 0.95 }}
          animate={{ opacity: 1, scale: 1 }}
          transition={{ delay: 0.1 }}
          className="mt-6 bg-white/10 backdrop-blur-sm rounded-2xl p-4"
        >
          <div className="flex items-center justify-between mb-2">
            <div className="flex items-center gap-2">
              <Target className="w-5 h-5" />
              <span className="text-sm font-medium">Meta {periodo === 'hoje' ? 'Diária' : periodo === 'mes' ? 'Mensal' : 'do Período'}</span>
            </div>
            <span className="text-lg font-bold">
              {formatarMoeda(resumo.lucroLiquido)} / {formatarMoeda(getMeta())}
            </span>
          </div>
          <div className="w-full h-2 bg-white/20 rounded-full overflow-hidden">
            <motion.div
              initial={{ width: 0 }}
              animate={{ width: `${progressoMeta}%` }}
              transition={{ duration: 0.5, delay: 0.2 }}
              className={`h-full rounded-full ${
                progressoMeta >= 100 ? 'bg-green-400' : 'bg-white'
              }`}
            />
          </div>
          <p className="text-xs text-primary-200 mt-2">
            {progressoMeta >= 100 
              ? '🎉 Meta atingida!' 
              : `${progressoMeta.toFixed(0)}% da meta`
            }
          </p>
        </motion.div>
      </div>

      {/* Cards Principais - Lucro Real vs Esperado */}
      <div className="px-4 -mt-8">
        <div className="grid grid-cols-2 gap-3">
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.1 }}
          >
            <Card className="p-4 border-l-4 border-l-green-500">
              <div className="flex items-center gap-2 mb-2">
                <TrendingUp className="w-4 h-4 text-green-600" />
                <span className="text-xs text-gray-500">Lucro Real</span>
              </div>
              <p className={`text-xl font-bold ${resumo.lucroLiquido >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                {formatarMoeda(resumo.lucroLiquido)}
              </p>
              <p className="text-xs text-gray-400 mt-1">{getPeriodoLabel()}</p>
            </Card>
          </motion.div>

          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.15 }}
          >
            <Card className="p-4 border-l-4 border-l-blue-500">
              <div className="flex items-center gap-2 mb-2">
                <PiggyBank className="w-4 h-4 text-blue-600" />
                <span className="text-xs text-gray-500">Lucro Esperado</span>
              </div>
              <p className="text-xl font-bold text-blue-600">
                {formatarMoeda(estoque.lucroEsperado)}
              </p>
              <p className="text-xs text-gray-400 mt-1">Se vender todo estoque</p>
            </Card>
          </motion.div>
        </div>
      </div>

      {/* Cards Estoque */}
      <div className="px-4 mt-4">
        <h3 className="text-sm font-semibold text-gray-600 mb-3">💼 Estoque</h3>
        <div className="grid grid-cols-2 gap-3">
          <Card className="p-4">
            <div className="flex items-center gap-2 mb-2">
              <Box className="w-4 h-4 text-orange-600" />
              <span className="text-xs text-gray-500">Valor Custo</span>
            </div>
            <p className="text-lg font-bold text-gray-900">
              {formatarMoeda(estoque.valorCusto)}
            </p>
            <p className="text-xs text-gray-400 mt-1">{estoque.totalItens} itens</p>
          </Card>

          <Card className="p-4">
            <div className="flex items-center gap-2 mb-2">
              <DollarSign className="w-4 h-4 text-green-600" />
              <span className="text-xs text-gray-500">Valor Venda</span>
            </div>
            <p className="text-lg font-bold text-gray-900">
              {formatarMoeda(estoque.valorVenda)}
            </p>
            <p className="text-xs text-gray-400 mt-1">Potencial bruto</p>
          </Card>

          <Card className="p-4">
            <div className="flex items-center gap-2 mb-2">
              <Package className="w-4 h-4 text-purple-600" />
              <span className="text-xs text-gray-500">Produtos</span>
            </div>
            <p className="text-lg font-bold text-gray-900">
              {estoque.totalProdutos}
            </p>
            <p className="text-xs text-gray-400 mt-1">Cadastrados</p>
          </Card>

          <Card className="p-4">
            <div className="flex items-center gap-2 mb-2">
              <Percent className="w-4 h-4 text-indigo-600" />
              <span className="text-xs text-gray-500">Margem Média</span>
            </div>
            <p className="text-lg font-bold text-gray-900">
              {estoque.margemMedia.toFixed(1)}%
            </p>
            <p className="text-xs text-gray-400 mt-1">Por produto</p>
          </Card>
        </div>
      </div>

      {/* Cards Vendas do Período */}
      <div className="px-4 mt-6">
        <h3 className="text-sm font-semibold text-gray-600 mb-3">📊 Vendas - {getPeriodoLabel()}</h3>
        <div className="grid grid-cols-3 gap-3">
          <Card className="p-3 text-center">
            <ShoppingCart className="w-5 h-5 text-purple-600 mx-auto mb-1" />
            <p className="text-lg font-bold text-gray-900">{resumo.totalVendas}</p>
            <p className="text-xs text-gray-500">Vendas</p>
          </Card>

          <Card className="p-3 text-center">
            <Package className="w-5 h-5 text-blue-600 mx-auto mb-1" />
            <p className="text-lg font-bold text-gray-900">{resumo.quantidadeVendida}</p>
            <p className="text-xs text-gray-500">Unidades</p>
          </Card>

          <Card className="p-3 text-center">
            <BarChart3 className="w-5 h-5 text-green-600 mx-auto mb-1" />
            <p className={`text-lg font-bold ${roi >= 0 ? 'text-green-600' : 'text-red-600'}`}>
              {roi.toFixed(0)}%
            </p>
            <p className="text-xs text-gray-500">ROI</p>
          </Card>
        </div>
      </div>

      {/* Detalhes Financeiros */}
      <div className="px-4 mt-6">
        <Card className="p-4">
          <h3 className="text-sm font-semibold text-gray-900 mb-4">
            💰 Resumo Financeiro - {getPeriodoLabel()}
          </h3>
          <div className="space-y-3">
            <div className="flex justify-between items-center">
              <span className="text-sm text-gray-500">Faturamento Bruto</span>
              <span className="text-sm font-medium text-gray-900">
                {formatarMoeda(resumo.faturamento)}
              </span>
            </div>
            <div className="flex justify-between items-center">
              <span className="text-sm text-gray-500">(-) Custo dos Produtos</span>
              <span className="text-sm font-medium text-red-600">
                -{formatarMoeda(resumo.gastoEstoque)}
              </span>
            </div>
            <div className="flex justify-between items-center">
              <span className="text-sm text-gray-500">(-) Taxas ML</span>
              <span className="text-sm font-medium text-red-600">
                -{formatarMoeda(resumo.totalTaxas)}
              </span>
            </div>
            <div className="border-t pt-3 flex justify-between items-center">
              <span className="text-sm font-semibold text-gray-900">= Lucro Líquido</span>
              <span className={`text-xl font-bold ${resumo.lucroLiquido >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                {formatarMoeda(resumo.lucroLiquido)}
              </span>
            </div>
            {resumo.totalVendas > 0 && (
              <>
                <div className="border-t pt-3 flex justify-between items-center text-xs text-gray-400">
                  <span>Ticket Médio</span>
                  <span>{formatarMoeda(resumo.ticketMedio)}</span>
                </div>
                <div className="flex justify-between items-center text-xs text-gray-400">
                  <span>Lucro por Venda</span>
                  <span>{formatarMoeda(resumo.lucroLiquido / resumo.totalVendas)}</span>
                </div>
              </>
            )}
          </div>
        </Card>
      </div>

      {/* Top Produtos */}
      {produtosTop.length > 0 && (
        <div className="px-4 mt-6">
          <Card className="p-4">
            <h3 className="text-sm font-semibold text-gray-900 mb-4">
              🏆 Top Produtos - {getPeriodoLabel()}
            </h3>
            <div className="space-y-3">
              {produtosTop.map((produto, index) => (
                <div key={produto.nome} className="flex items-center gap-3">
                  <div className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold text-white ${
                    index === 0 ? 'bg-yellow-500' : index === 1 ? 'bg-gray-400' : index === 2 ? 'bg-orange-600' : 'bg-gray-300'
                  }`}>
                    {index + 1}
                  </div>
                  <div className="flex-1 min-w-0">
                    <p className="text-sm font-medium text-gray-900 truncate">{produto.nome}</p>
                    <p className="text-xs text-gray-500">{produto.vendas} vendas</p>
                  </div>
                  <span className={`text-sm font-bold ${produto.lucro >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                    {formatarMoeda(produto.lucro)}
                  </span>
                </div>
              ))}
            </div>
          </Card>
        </div>
      )}

      {/* Gráfico */}
      {dadosGrafico.length > 0 && (
        <div className="px-4 mt-6">
          <Card className="p-4">
            <h3 className="text-sm font-semibold text-gray-900 mb-4">
              📈 Evolução - {getPeriodoLabel()}
            </h3>
            <div className="h-48">
              <ResponsiveContainer width="100%" height="100%">
                <BarChart data={dadosGrafico}>
                  <XAxis 
                    dataKey="label" 
                    tick={{ fontSize: 10, fill: '#9CA3AF' }}
                    axisLine={false}
                    tickLine={false}
                  />
                  <YAxis 
                    tick={{ fontSize: 10, fill: '#9CA3AF' }}
                    axisLine={false}
                    tickLine={false}
                    tickFormatter={(value) => `R$${value}`}
                  />
                  <Tooltip 
                    formatter={(value: number, name: string) => [
                      formatarMoeda(value),
                      name === 'faturamento' ? 'Faturamento' : 'Lucro'
                    ]}
                    contentStyle={{
                      borderRadius: '8px',
                      border: 'none',
                      boxShadow: '0 4px 6px -1px rgba(0,0,0,0.1)',
                    }}
                  />
                  <Bar 
                    dataKey="faturamento" 
                    fill="#3B82F6" 
                    radius={[4, 4, 0, 0]}
                    name="Faturamento"
                  />
                  <Bar 
                    dataKey="lucro" 
                    fill="#10B981" 
                    radius={[4, 4, 0, 0]}
                    name="Lucro"
                  />
                </BarChart>
              </ResponsiveContainer>
            </div>
            <div className="flex justify-center gap-6 mt-4">
              <div className="flex items-center gap-2">
                <div className="w-3 h-3 bg-blue-500 rounded" />
                <span className="text-xs text-gray-500">Faturamento</span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-3 h-3 bg-green-500 rounded" />
                <span className="text-xs text-gray-500">Lucro</span>
              </div>
            </div>
          </Card>
        </div>
      )}

      {/* Mensagem quando não há vendas */}
      {!isLoading && resumo.totalVendas === 0 && (
        <div className="px-4 mt-6">
          <Card className="p-8 text-center">
            <ShoppingCart className="w-12 h-12 text-gray-300 mx-auto mb-4" />
            <h3 className="text-gray-500 font-medium">Nenhuma venda no período</h3>
            <p className="text-sm text-gray-400 mt-1">
              Registre vendas no Estoque para ver os dados aqui
            </p>
          </Card>
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/app/api/mercadolivre/callback/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { getMLUser } from '@/lib/mercadolivre/client';
import { createClient } from '@supabase/supabase-js';

const ML_APP_ID = process.env.ML_APP_ID || '5368303012953288';
const ML_SECRET_KEY = process.env.ML_SECRET_KEY || 'wdSjpo7w61ASY7OztyOO8PM8fFYbAtPb';
const BASE_URL = process.env.NEXT_PUBLIC_APP_URL || 'https://ll-controll.vercel.app';
const SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL || 'https://vbhhjukhtrylghclvotv.supabase.co';
const SUPABASE_SERVICE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY || '';

export async function GET(request: NextRequest) {
  const searchParams = request.nextUrl.searchParams;
  const code = searchParams.get('code');
  const error = searchParams.get('error');
  const state = searchParams.get('state'); // userId passado pelo state

  if (error) {
    return NextResponse.redirect(
      `${BASE_URL}/ajustes?ml_error=${encodeURIComponent(error)}`
    );
  }

  if (!code) {
    return NextResponse.redirect(
      `${BASE_URL}/ajustes?ml_error=no_code`
    );
  }

  try {
    // Trocar código por token
    const redirectUri = `${BASE_URL}/api/mercadolivre/callback`;
    
    const tokenResponse = await fetch('https://api.mercadolibre.com/oauth/token', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'Accept': 'application/json',
      },
      body: new URLSearchParams({
        grant_type: 'authorization_code',
        client_id: ML_APP_ID,
        client_secret: ML_SECRET_KEY,
        code: code,
        redirect_uri: redirectUri,
      }),
    });

    if (!tokenResponse.ok) {
      const errorData = await tokenResponse.json();
      throw new Error(errorData.message || 'Erro ao obter token');
    }

    const tokenData = await tokenResponse.json();
    
    // Obter dados do usuário do ML
    const mlUser = await getMLUser(tokenData.access_token);

    // Salvar no Supabase
    const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);

    // Usar o userId do state ou buscar o primeiro usuário
    let userId = state ? decodeURIComponent(state) : null;
    
    if (!userId) {
      // Fallback: buscar usuário existente
      const { data: configData } = await supabase
        .from('configuracoes')
        .select('user_id')
        .limit(1)
        .single();
      userId = configData?.user_id;
    }

    if (userId) {
      // Verificar se existe configuração, senão criar
      const { data: existingConfig } = await supabase
        .from('configuracoes')
        .select('user_id')
        .eq('user_id', userId)
        .single();

      if (existingConfig) {
        // Atualizar
        await supabase
          .from('configuracoes')
          .update({
            ml_user_id: mlUser.id.toString(),
            ml_access_token: tokenData.access_token,
            ml_refresh_token: tokenData.refresh_token,
            ml_token_expires: new Date(Date.now() + tokenData.expires_in * 1000).toISOString(),
            ml_nickname: mlUser.nickname,
          })
          .eq('user_id', userId);
      } else {
        // Inserir
        await supabase
          .from('configuracoes')
          .insert({
            user_id: userId,
            ml_user_id: mlUser.id.toString(),
            ml_access_token: tokenData.access_token,
            ml_refresh_token: tokenData.refresh_token,
            ml_token_expires: new Date(Date.now() + tokenData.expires_in * 1000).toISOString(),
            ml_nickname: mlUser.nickname,
          });
      }
    }

    return NextResponse.redirect(
      `${BASE_URL}/ajustes?ml_success=true&nickname=${encodeURIComponent(mlUser.nickname)}`
    );
  } catch (err: any) {
    console.error('Erro no callback ML:', err);
    return NextResponse.redirect(
      `${BASE_URL}/ajustes?ml_error=${encodeURIComponent(err.message || 'unknown')}`
    );
  }
}
</file>

<file path="src/lib/mercadolivre/client.ts">
// Mercado Livre API Client

const ML_API_BASE = 'https://api.mercadolibre.com';

export interface MLToken {
  access_token: string;
  token_type: string;
  expires_in: number;
  scope: string;
  user_id: number;
  refresh_token: string;
}

export interface MLUser {
  id: number;
  nickname: string;
  email: string;
  first_name: string;
  last_name: string;
}

export interface MLItem {
  id: string;
  title: string;
  price: number;
  available_quantity: number;
  sold_quantity: number;
  thumbnail: string;
  permalink: string;
  status: string;
  category_id: string;
}

export interface MLOrder {
  id: number;
  status: string;
  date_created: string;
  order_items: {
    item: {
      id: string;
      title: string;
    };
    quantity: number;
    unit_price: number;
  }[];
  total_amount: number;
  buyer: {
    id: number;
    nickname: string;
  };
}

// Gerar URL de autorização
export function getAuthUrl(userId?: string): string {
  const clientId = process.env.NEXT_PUBLIC_ML_APP_ID || '5368303012953288';
  const baseUrl = process.env.NEXT_PUBLIC_APP_URL || 'https://ll-controll.vercel.app';
  const redirectUri = `${baseUrl}/api/mercadolivre/callback`;
  
  // Passar userId no state para recuperar no callback
  const state = userId ? encodeURIComponent(userId) : '';
  
  return `https://auth.mercadolivre.com.br/authorization?response_type=code&client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&state=${state}`;
}

// Trocar código por tokens
export async function exchangeCodeForToken(code: string): Promise<MLToken> {
  const response = await fetch(`${ML_API_BASE}/oauth/token`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'Accept': 'application/json',
    },
    body: new URLSearchParams({
      grant_type: 'authorization_code',
      client_id: process.env.ML_APP_ID!,
      client_secret: process.env.ML_SECRET_KEY!,
      code: code,
      redirect_uri: `${process.env.NEXT_PUBLIC_APP_URL}/api/mercadolivre/callback`,
    }),
  });

  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.message || 'Erro ao obter token');
  }

  return response.json();
}

// Renovar token
export async function refreshToken(refresh_token: string): Promise<MLToken> {
  const response = await fetch(`${ML_API_BASE}/oauth/token`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'Accept': 'application/json',
    },
    body: new URLSearchParams({
      grant_type: 'refresh_token',
      client_id: process.env.ML_APP_ID!,
      client_secret: process.env.ML_SECRET_KEY!,
      refresh_token: refresh_token,
    }),
  });

  if (!response.ok) {
    throw new Error('Erro ao renovar token');
  }

  return response.json();
}

// Obter dados do usuário
export async function getMLUser(accessToken: string): Promise<MLUser> {
  const response = await fetch(`${ML_API_BASE}/users/me`, {
    headers: {
      'Authorization': `Bearer ${accessToken}`,
    },
  });

  if (!response.ok) {
    throw new Error('Erro ao obter usuário');
  }

  return response.json();
}

// Listar anúncios do vendedor
export async function getMLItems(accessToken: string, userId: number): Promise<MLItem[]> {
  // Primeiro, buscar IDs dos itens
  const idsResponse = await fetch(
    `${ML_API_BASE}/users/${userId}/items/search?limit=50`,
    {
      headers: {
        'Authorization': `Bearer ${accessToken}`,
      },
    }
  );

  if (!idsResponse.ok) {
    throw new Error('Erro ao buscar anúncios');
  }

  const idsData = await idsResponse.json();
  const itemIds = idsData.results || [];

  if (itemIds.length === 0) {
    return [];
  }

  // Buscar detalhes dos itens
  const itemsResponse = await fetch(
    `${ML_API_BASE}/items?ids=${itemIds.join(',')}`,
    {
      headers: {
        'Authorization': `Bearer ${accessToken}`,
      },
    }
  );

  if (!itemsResponse.ok) {
    throw new Error('Erro ao buscar detalhes dos anúncios');
  }

  const itemsData = await itemsResponse.json();
  return itemsData.map((item: any) => item.body);
}

// Buscar pedidos recentes
export async function getMLOrders(
  accessToken: string, 
  sellerId: number,
  status: 'paid' | 'all' = 'paid'
): Promise<MLOrder[]> {
  const url = status === 'all' 
    ? `${ML_API_BASE}/orders/search?seller=${sellerId}&sort=date_desc&limit=50`
    : `${ML_API_BASE}/orders/search?seller=${sellerId}&order.status=paid&sort=date_desc&limit=50`;

  const response = await fetch(url, {
    headers: {
      'Authorization': `Bearer ${accessToken}`,
    },
  });

  if (!response.ok) {
    throw new Error('Erro ao buscar pedidos');
  }

  const data = await response.json();
  return data.results || [];
}

// Obter detalhes de um item
export async function getMLItemDetails(accessToken: string, itemId: string): Promise<MLItem> {
  const response = await fetch(`${ML_API_BASE}/items/${itemId}`, {
    headers: {
      'Authorization': `Bearer ${accessToken}`,
    },
  });

  if (!response.ok) {
    throw new Error('Erro ao buscar detalhes do item');
  }

  return response.json();
}

// Atualizar quantidade de um item
export async function updateMLItemQuantity(
  accessToken: string, 
  itemId: string, 
  quantity: number
): Promise<void> {
  const response = await fetch(`${ML_API_BASE}/items/${itemId}`, {
    method: 'PUT',
    headers: {
      'Authorization': `Bearer ${accessToken}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      available_quantity: quantity,
    }),
  });

  if (!response.ok) {
    throw new Error('Erro ao atualizar quantidade');
  }
}
</file>

<file path="src/app/(app)/ajustes/page.tsx">
'use client';

import { useState, useEffect, Suspense } from 'react';
import { motion } from 'framer-motion';
import { useSearchParams } from 'next/navigation';
import { 
  Settings, 
  Bell, 
  Target, 
  Percent,
  Link2,
  Link2Off,
  LogOut,
  ChevronRight,
  User,
  Info,
  Package,
  RefreshCw,
  Check,
  AlertCircle,
  ExternalLink
} from 'lucide-react';
import * as SwitchPrimitive from '@radix-ui/react-switch';
import { Card, Button, Input, Modal, useToast } from '@/components/ui';
import { formatarMoeda } from '@/lib/utils/calculos';
import { getSupabaseClient } from '@/lib/supabase/client';
import { Configuracoes } from '@/types/database';
import { cn, hapticFeedback } from '@/lib/utils/helpers';
import { getAuthUrl } from '@/lib/mercadolivre/client';

interface SettingItemProps {
  icon: React.ReactNode;
  title: string;
  description?: string;
  onClick?: () => void;
  rightElement?: React.ReactNode;
}

function SettingItem({ icon, title, description, onClick, rightElement }: SettingItemProps) {
  return (
    <button
      onClick={onClick}
      disabled={!onClick}
      className={cn(
        'w-full flex items-center gap-4 p-4 text-left',
        'transition-colors',
        onClick && 'active:bg-gray-50'
      )}
    >
      <div className="p-2 bg-gray-100 rounded-xl">
        {icon}
      </div>
      <div className="flex-1">
        <p className="font-medium text-gray-900">{title}</p>
        {description && (
          <p className="text-sm text-gray-500 mt-0.5">{description}</p>
        )}
      </div>
      {rightElement || (onClick && <ChevronRight className="w-5 h-5 text-gray-400" />)}
    </button>
  );
}

function AjustesContent() {
  const searchParams = useSearchParams();
  const [config, setConfig] = useState<Configuracoes | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [showMetasModal, setShowMetasModal] = useState(false);
  const [showTaxasModal, setShowTaxasModal] = useState(false);
  const [showContaModal, setShowContaModal] = useState(false);
  const [showMLModal, setShowMLModal] = useState(false);
  const [mlConnected, setMlConnected] = useState(false);
  const [mlNickname, setMlNickname] = useState('');
  const [mlItems, setMlItems] = useState<any[]>([]);
  const [loadingItems, setLoadingItems] = useState(false);
  const [importingItem, setImportingItem] = useState<string | null>(null);
  const [userEmail, setUserEmail] = useState('');
  const [userId, setUserId] = useState('');
  const [metaDiaria, setMetaDiaria] = useState('');
  const [metaMensal, setMetaMensal] = useState('');
  const [taxaClassico, setTaxaClassico] = useState('11');
  const [taxaPremium, setTaxaPremium] = useState('16');
  const [notificacoesAtivas, setNotificacoesAtivas] = useState(true);

  const { addToast } = useToast();

  useEffect(() => {
    carregarConfiguracoes();
    
    // Verificar retorno do OAuth
    const mlSuccess = searchParams.get('ml_success');
    const mlError = searchParams.get('ml_error');
    const nickname = searchParams.get('nickname');
    
    if (mlSuccess === 'true') {
      addToast({ 
        type: 'success', 
        title: 'Mercado Livre conectado!',
        description: nickname ? `Bem-vindo, ${nickname}` : undefined
      });
      setMlConnected(true);
      if (nickname) setMlNickname(nickname);
      // Limpar URL
      window.history.replaceState({}, '', '/ajustes');
    } else if (mlError) {
      addToast({ 
        type: 'error', 
        title: 'Erro ao conectar ML',
        description: mlError
      });
      window.history.replaceState({}, '', '/ajustes');
    }
  }, [searchParams]);

  const carregarConfiguracoes = async () => {
    try {
      const supabase = getSupabaseClient();
      const { data: { user } } = await supabase.auth.getUser();

      if (user) {
        setUserEmail(user.email || '');
        setUserId(user.id);
        
        const { data, error } = await supabase
          .from('configuracoes')
          .select('*')
          .eq('user_id', user.id)
          .single();

        if (data && !error) {
          const configData = data as Configuracoes;
          setConfig(configData);
          setMetaDiaria(configData.meta_diaria?.toString() || '100');
          setMetaMensal(configData.meta_mensal?.toString() || '3000');
          setTaxaClassico(configData.taxa_classico?.toString() || '11');
          setTaxaPremium(configData.taxa_premium?.toString() || '16');
          setNotificacoesAtivas(configData.notificacoes_ativas ?? true);
          
          // Verificar conexão ML
          if ((configData as any).ml_user_id) {
            setMlConnected(true);
            setMlNickname((configData as any).ml_nickname || '');
          }
        }
      }
    } catch (error) {
      console.error('Erro ao carregar configurações:', error);
    } finally {
      setIsLoading(false);
    }
  };

  const salvarMetas = async () => {
    try {
      const supabase = getSupabaseClient();
      const { data: { user } } = await supabase.auth.getUser();

      if (!user) {
        addToast({ type: 'error', title: 'Usuário não autenticado' });
        return;
      }

      const metaDiariaNum = parseFloat(metaDiaria) || 0;
      const metaMensalNum = parseFloat(metaMensal) || 0;

      const { error } = await supabase
        .from('configuracoes')
        .upsert({
          user_id: user.id,
          meta_diaria: metaDiariaNum,
          meta_mensal: metaMensalNum,
        } as any);

      if (error) throw error;

      hapticFeedback('medium');
      addToast({ type: 'success', title: 'Metas atualizadas!' });
      setShowMetasModal(false);
    } catch (error) {
      console.error('Erro ao salvar metas:', error);
      addToast({ type: 'error', title: 'Erro ao salvar metas' });
    }
  };

  const salvarTaxas = async () => {
    try {
      const supabase = getSupabaseClient();
      const { data: { user } } = await supabase.auth.getUser();

      if (!user) {
        addToast({ type: 'error', title: 'Usuário não autenticado' });
        return;
      }

      const { error } = await supabase
        .from('configuracoes')
        .upsert({
          user_id: user.id,
          taxa_classico: parseFloat(taxaClassico) || 11,
          taxa_premium: parseFloat(taxaPremium) || 16,
        } as any);

      if (error) throw error;

      hapticFeedback('medium');
      addToast({ type: 'success', title: 'Taxas atualizadas!' });
      setShowTaxasModal(false);
    } catch (error) {
      console.error('Erro ao salvar taxas:', error);
      addToast({ type: 'error', title: 'Erro ao salvar taxas' });
    }
  };

  const toggleNotificacoes = async (enabled: boolean) => {
    setNotificacoesAtivas(enabled);
    hapticFeedback('light');

    try {
      const supabase = getSupabaseClient();
      const { data: { user } } = await supabase.auth.getUser();

      if (user) {
        await supabase
          .from('configuracoes')
          .upsert({
            user_id: user.id,
            notificacoes_ativas: enabled,
          } as any);
      }
    } catch (error) {
      console.error('Erro ao atualizar notificações:', error);
    }
  };

  const handleLogout = async () => {
    const supabase = getSupabaseClient();
    await supabase.auth.signOut();
    window.location.href = '/login';
  };

  const handleConnectML = () => {
    const authUrl = getAuthUrl(userId);
    window.location.href = authUrl;
  };

  const handleDisconnectML = async () => {
    try {
      const supabase = getSupabaseClient();
      await supabase
        .from('configuracoes')
        .update({
          ml_user_id: null,
          ml_access_token: null,
          ml_refresh_token: null,
          ml_token_expires: null,
          ml_nickname: null,
        } as any)
        .eq('user_id', userId);

      setMlConnected(false);
      setMlNickname('');
      setMlItems([]);
      addToast({ type: 'success', title: 'Mercado Livre desconectado' });
    } catch (error) {
      console.error('Erro ao desconectar ML:', error);
      addToast({ type: 'error', title: 'Erro ao desconectar' });
    }
  };

  const loadMLItems = async () => {
    if (!userId) return;
    
    setLoadingItems(true);
    try {
      const response = await fetch('/api/mercadolivre/items', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: userId }),
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Erro ao buscar anúncios');
      }

      const data = await response.json();
      setMlItems(data.items || []);
    } catch (error: any) {
      console.error('Erro ao buscar anúncios:', error);
      addToast({ 
        type: 'error', 
        title: 'Erro ao buscar anúncios',
        description: error.message 
      });
    } finally {
      setLoadingItems(false);
    }
  };

  const importarProdutoML = async (item: any) => {
    setImportingItem(item.id);
    try {
      const supabase = getSupabaseClient();
      
      // Verificar se já existe produto com este ml_id
      const { data: existing } = await supabase
        .from('produtos')
        .select('id')
        .eq('ml_id', item.id)
        .single();

      if (existing) {
        addToast({ 
          type: 'warning', 
          title: 'Produto já importado',
          description: 'Este anúncio já está vinculado a um produto'
        });
        return;
      }

      // Criar produto
      const { error } = await supabase
        .from('produtos')
        .insert({
          user_id: userId,
          nome: item.title,
          foto_url: item.thumbnail?.replace('http://', 'https://') || null,
          quantidade: item.available_quantity,
          valor_pago: 0, // Usuário precisará preencher o custo
          valor_venda: item.price,
          ml_id: item.id,
          taxa_tipo: 'classico',
          ativo: true,
        } as any);

      if (error) throw error;

      addToast({ 
        type: 'success', 
        title: 'Produto importado!',
        description: 'Não esqueça de preencher o custo no Estoque'
      });

      // Marcar como importado na lista
      setMlItems(prev => prev.map(i => 
        i.id === item.id ? { ...i, imported: true } : i
      ));
    } catch (error: any) {
      console.error('Erro ao importar:', error);
      addToast({ type: 'error', title: 'Erro ao importar produto' });
    } finally {
      setImportingItem(null);
    }
  };

  return (
    <div className="min-h-screen bg-gray-50 pt-safe">
      {/* Header */}
      <div className="bg-white px-4 pt-6 pb-4 border-b border-gray-100">
        <h1 className="text-2xl font-bold text-gray-900">Ajustes</h1>
        <p className="text-sm text-gray-500 mt-0.5">
          Configure seu aplicativo
        </p>
      </div>

      {/* Settings Sections */}
      <div className="px-4 py-4 space-y-4">
        {/* Metas */}
        <Card className="overflow-hidden p-0">
          <div className="px-4 py-3 bg-gray-50 border-b border-gray-100">
            <h3 className="text-sm font-semibold text-gray-600 uppercase tracking-wide">
              Metas
            </h3>
          </div>
          <SettingItem
            icon={<Target className="w-5 h-5 text-primary-600" />}
            title="Metas de Lucro"
            description={
              config?.meta_diaria 
                ? `Diária: ${formatarMoeda(config.meta_diaria)}`
                : 'Definir metas diárias e mensais'
            }
            onClick={() => setShowMetasModal(true)}
          />
        </Card>

        {/* Mercado Livre */}
        <Card className="overflow-hidden p-0">
          <div className="px-4 py-3 bg-yellow-50 border-b border-yellow-100">
            <h3 className="text-sm font-semibold text-yellow-700 uppercase tracking-wide flex items-center gap-2">
              <span className="text-lg">🛒</span> Mercado Livre
            </h3>
          </div>
          <SettingItem
            icon={<Percent className="w-5 h-5 text-yellow-600" />}
            title="Taxas Personalizadas"
            description={`Clássico: ${taxaClassico}% • Premium: ${taxaPremium}%`}
            onClick={() => setShowTaxasModal(true)}
          />
          <div className="border-t border-gray-100" />
          
          {mlConnected ? (
            <>
              <div className="p-4 bg-green-50 border-b border-green-100">
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                    <Check className="w-5 h-5 text-green-600" />
                  </div>
                  <div className="flex-1">
                    <p className="text-sm font-medium text-green-800">Conta Conectada</p>
                    <p className="text-xs text-green-600">{mlNickname || 'Sincronização ativa'}</p>
                  </div>
                </div>
              </div>
              <SettingItem
                icon={<Package className="w-5 h-5 text-blue-600" />}
                title="Importar Anúncios"
                description="Trazer produtos do Mercado Livre"
                onClick={() => {
                  setShowMLModal(true);
                  loadMLItems();
                }}
              />
              <div className="border-t border-gray-100" />
              <SettingItem
                icon={<Link2Off className="w-5 h-5 text-red-500" />}
                title="Desconectar Conta"
                description="Remover integração com ML"
                onClick={handleDisconnectML}
              />
            </>
          ) : (
            <SettingItem
              icon={<Link2 className="w-5 h-5 text-green-600" />}
              title="Conectar Conta"
              description="Sincronizar vendas automaticamente"
              onClick={handleConnectML}
            />
          )}
        </Card>

        {/* Notificações */}
        <Card className="overflow-hidden p-0">
          <div className="px-4 py-3 bg-gray-50 border-b border-gray-100">
            <h3 className="text-sm font-semibold text-gray-600 uppercase tracking-wide">
              Notificações
            </h3>
          </div>
          <SettingItem
            icon={<Bell className="w-5 h-5 text-purple-600" />}
            title="Alertas de Vendas"
            description="Receber notificações ao vender"
            rightElement={
              <SwitchPrimitive.Root
                checked={notificacoesAtivas}
                onCheckedChange={toggleNotificacoes}
                className={cn(
                  'w-11 h-6 rounded-full transition-colors',
                  notificacoesAtivas ? 'bg-primary-600' : 'bg-gray-200'
                )}
              >
                <SwitchPrimitive.Thumb
                  className={cn(
                    'block w-5 h-5 bg-white rounded-full shadow-sm transition-transform',
                    notificacoesAtivas ? 'translate-x-5' : 'translate-x-0.5'
                  )}
                />
              </SwitchPrimitive.Root>
            }
          />
        </Card>

        {/* Conta */}
        <Card className="overflow-hidden p-0">
          <div className="px-4 py-3 bg-gray-50 border-b border-gray-100">
            <h3 className="text-sm font-semibold text-gray-600 uppercase tracking-wide">
              Conta
            </h3>
          </div>
          <SettingItem
            icon={<User className="w-5 h-5 text-gray-600" />}
            title="Minha Conta"
            description={userEmail || 'Gerenciar perfil'}
            onClick={() => setShowContaModal(true)}
          />
          <div className="border-t border-gray-100" />
          <SettingItem
            icon={<Info className="w-5 h-5 text-gray-600" />}
            title="Sobre o App"
            description="LLControl v1.0.0"
          />
          <div className="border-t border-gray-100" />
          <button
            onClick={handleLogout}
            className="w-full flex items-center gap-4 p-4 text-left text-danger-600 active:bg-danger-50 transition-colors"
          >
            <div className="p-2 bg-danger-100 rounded-xl">
              <LogOut className="w-5 h-5 text-danger-600" />
            </div>
            <span className="font-medium">Sair da Conta</span>
          </button>
        </Card>
      </div>

      {/* Metas Modal */}
      <Modal
        open={showMetasModal}
        onOpenChange={setShowMetasModal}
        title="Metas de Lucro"
        description="Defina suas metas para acompanhar seu progresso"
      >
        <div className="space-y-4">
          <Input
            label="Meta Diária (R$)"
            type="number"
            placeholder="0,00"
            step="0.01"
            value={metaDiaria}
            onChange={(e) => setMetaDiaria(e.target.value)}
          />
          <Input
            label="Meta Mensal (R$)"
            type="number"
            placeholder="0,00"
            step="0.01"
            value={metaMensal}
            onChange={(e) => setMetaMensal(e.target.value)}
          />
          <div className="flex gap-3 pt-4">
            <Button
              variant="secondary"
              fullWidth
              onClick={() => setShowMetasModal(false)}
            >
              Cancelar
            </Button>
            <Button fullWidth onClick={salvarMetas}>
              Salvar
            </Button>
          </div>
        </div>
      </Modal>

      {/* Taxas Modal */}
      <Modal
        open={showTaxasModal}
        onOpenChange={setShowTaxasModal}
        title="Taxas do Mercado Livre"
        description="Personalize as taxas conforme seu contrato"
      >
        <div className="space-y-4">
          <Input
            label="Taxa Clássico (%)"
            type="number"
            placeholder="11"
            step="0.1"
            value={taxaClassico}
            onChange={(e) => setTaxaClassico(e.target.value)}
          />
          <Input
            label="Taxa Premium (%)"
            type="number"
            placeholder="16"
            step="0.1"
            value={taxaPremium}
            onChange={(e) => setTaxaPremium(e.target.value)}
          />
          <div className="p-3 bg-gray-50 rounded-xl text-sm text-gray-600">
            <p>Valores padrão: Clássico 11% • Premium 16%</p>
            <p className="mt-1">Taxa fixa de R$ 6,00 em vendas abaixo de R$ 79,00</p>
          </div>
          <div className="flex gap-3 pt-4">
            <Button
              variant="secondary"
              fullWidth
              onClick={() => setShowTaxasModal(false)}
            >
              Cancelar
            </Button>
            <Button fullWidth onClick={salvarTaxas}>
              Salvar
            </Button>
          </div>
        </div>
      </Modal>

      {/* Conta Modal */}
      <Modal
        open={showContaModal}
        onOpenChange={setShowContaModal}
        title="Minha Conta"
        description="Informações da sua conta"
      >
        <div className="space-y-4">
          <div className="flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
            <div className="w-12 h-12 bg-primary-100 rounded-full flex items-center justify-center">
              <User className="w-6 h-6 text-primary-600" />
            </div>
            <div className="flex-1">
              <p className="text-sm text-gray-500">Email</p>
              <p className="font-medium text-gray-900">{userEmail}</p>
            </div>
          </div>
          
          <div className="border-t pt-4">
            <button
              onClick={() => {
                setShowContaModal(false);
                handleLogout();
              }}
              className="w-full flex items-center justify-center gap-2 py-3 px-4 bg-danger-50 text-danger-600 rounded-xl font-medium active:bg-danger-100 transition-colors"
            >
              <LogOut className="w-5 h-5" />
              Sair da Conta
            </button>
          </div>

          <Button
            variant="secondary"
            fullWidth
            onClick={() => setShowContaModal(false)}
          >
            Fechar
          </Button>
        </div>
      </Modal>

      {/* Modal Importar ML */}
      <Modal
        open={showMLModal}
        onOpenChange={setShowMLModal}
        title="Importar do Mercado Livre"
        description="Selecione os anúncios para importar ao estoque"
      >
        <div className="space-y-4 max-h-96 overflow-y-auto">
          {loadingItems ? (
            <div className="flex items-center justify-center py-8">
              <RefreshCw className="w-6 h-6 text-gray-400 animate-spin" />
            </div>
          ) : mlItems.length === 0 ? (
            <div className="text-center py-8">
              <Package className="w-12 h-12 text-gray-300 mx-auto mb-3" />
              <p className="text-gray-500">Nenhum anúncio encontrado</p>
              <button
                onClick={loadMLItems}
                className="mt-3 text-primary-600 text-sm font-medium flex items-center gap-1 mx-auto"
              >
                <RefreshCw className="w-4 h-4" /> Recarregar
              </button>
            </div>
          ) : (
            mlItems.map((item) => (
              <div 
                key={item.id}
                className={cn(
                  "flex items-center gap-3 p-3 rounded-xl border transition-colors",
                  item.imported 
                    ? "bg-green-50 border-green-200" 
                    : "bg-gray-50 border-gray-200"
                )}
              >
                {item.thumbnail && (
                  <img 
                    src={item.thumbnail.replace('http://', 'https://')} 
                    alt={item.title}
                    className="w-14 h-14 object-cover rounded-lg"
                  />
                )}
                <div className="flex-1 min-w-0">
                  <p className="text-sm font-medium text-gray-900 truncate">
                    {item.title}
                  </p>
                  <p className="text-xs text-gray-500">
                    {formatarMoeda(item.price)} • Estoque: {item.available_quantity}
                  </p>
                  <p className="text-xs text-gray-400 mt-0.5">
                    {item.status === 'active' ? '🟢 Ativo' : '🔴 ' + item.status}
                  </p>
                </div>
                {item.imported ? (
                  <div className="flex items-center gap-1 text-green-600 text-xs font-medium">
                    <Check className="w-4 h-4" /> Importado
                  </div>
                ) : (
                  <Button
                    size="sm"
                    onClick={() => importarProdutoML(item)}
                    disabled={importingItem === item.id}
                  >
                    {importingItem === item.id ? (
                      <RefreshCw className="w-4 h-4 animate-spin" />
                    ) : (
                      'Importar'
                    )}
                  </Button>
                )}
              </div>
            ))
          )}
        </div>
        
        <div className="flex gap-3 pt-4 border-t mt-4">
          <Button
            variant="secondary"
            fullWidth
            onClick={() => setShowMLModal(false)}
          >
            Fechar
          </Button>
          <Button
            fullWidth
            onClick={loadMLItems}
            disabled={loadingItems}
          >
            <RefreshCw className={cn("w-4 h-4 mr-2", loadingItems && "animate-spin")} />
            Atualizar Lista
          </Button>
        </div>
      </Modal>
    </div>
  );
}

export default function AjustesPage() {
  return (
    <Suspense fallback={
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <RefreshCw className="w-8 h-8 text-gray-400 animate-spin" />
      </div>
    }>
      <AjustesContent />
    </Suspense>
  );
}
</file>

</files>
